<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <!-- Viewport adjustment for safe areas (Notch support) -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>SORTIQ - Dashboard</title>
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    
    <!-- Firebase Libraries -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
        import { getFirestore, collection, doc, onSnapshot, addDoc, updateDoc, setDoc, serverTimestamp, query } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

        // --- 1. SETUP FIREBASE ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app';
        
        let db, auth, userUid;

        if (firebaseConfig) {
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } else {
            console.log("Running in Demo Mode");
        }

        // --- 2. LOGIC BRIDGE ---
        window.fbBridge = {
            init: async (alpineScope) => {
                if (!auth) return;
                const initAuth = async () => {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                };
                await initAuth();

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userUid = user.uid;
                        alpineScope.username = "User " + userUid.substring(0, 5); 

                        const userDocRef = doc(db, 'artifacts', appId, 'users', userUid, 'profile', 'data');
                        onSnapshot(userDocRef, (docSnap) => {
                            if (docSnap.exists()) {
                                const data = docSnap.data();
                                alpineScope.xp = data.xp || 0;
                                alpineScope.username = data.name || alpineScope.username;
                            } else {
                                setDoc(userDocRef, { xp: 0, name: "Pengguna Baru", joinedAt: serverTimestamp() });
                            }
                        });

                        const depositsRef = collection(db, 'artifacts', appId, 'public', 'data', 'deposits');
                        onSnapshot(depositsRef, (snapshot) => {
                            const allDeposits = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            const myDeposits = allDeposits.filter(d => d.uid === userUid).sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                            alpineScope.userHistory = myDeposits;
                        });

                        const ordersRef = collection(db, 'artifacts', appId, 'public', 'data', 'market_orders');
                        onSnapshot(ordersRef, (snapshot) => {
                            const allOrders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            const myOrders = allOrders.filter(d => d.uid === userUid).sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                            alpineScope.marketOrders = myOrders;
                        });
                    }
                });
            },
            submitDeposit: async (data) => {
                if (!db) return new Promise(resolve => setTimeout(() => resolve(true), 1000));
                if (!userUid) return false;
                try {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'deposits'), {
                        uid: userUid, weight: parseFloat(data.weight), xpReward: parseInt(data.xpReward), address: data.address, status: 'Pending', tpaName: data.tpaName, timestamp: serverTimestamp(), date: new Date().toISOString()
                    });
                    return true;
                } catch (e) { return false; }
            },
            submitOrder: async (orderData, currentXP) => {
                if (!db) return new Promise(resolve => setTimeout(() => resolve(true), 1000));
                if (!userUid) return false;
                if (orderData.type === 'xp') {
                      const newXP = currentXP - orderData.priceValue;
                      if (newXP < 0) return false;
                      try {
                         const userDocRef = doc(db, 'artifacts', appId, 'users', userUid, 'profile', 'data');
                         await updateDoc(userDocRef, { xp: newXP });
                      } catch(e) { return false; }
                }
                try {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'market_orders'), {
                        uid: userUid, itemName: orderData.name, itemType: orderData.type, costDisplay: orderData.cost, priceValue: orderData.priceValue, status: 'Diproses', shippingMethod: orderData.method, timestamp: serverTimestamp(), date: new Date().toISOString()
                    });
                    return true;
                } catch (e) { return false; }
            }
        };
    </script>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Config & Styles -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Plus Jakarta Sans', 'sans-serif'] },
                    animation: { 'float': 'float 6s ease-in-out infinite' },
                    keyframes: { float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-10px)' } } }
                }
            }
        }
    </script>
    <style>
        /* Modern Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: #CBD5E1; border-radius: 10px; }
        ::-webkit-scrollbar-track { background: transparent; }
        
        .glass { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(16px); border-bottom: 1px solid rgba(255, 255, 255, 0.8); }
        .glass-nav { background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(16px); border: 1px solid rgba(255, 255, 255, 0.1); }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        /* Smooth Toast */
        .toast-enter { transform: translateY(100%); opacity: 0; }
        .toast-enter-active { transform: translateY(0); opacity: 1; transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        .toast-leave { transform: translateY(0); opacity: 1; }
        .toast-leave-active { transform: translateY(20px); opacity: 0; transition: all 0.3s ease-in; }

        /* Prevent rubber-banding effect on iOS */
        body { overscroll-behavior-y: none; }
        #main-scroll { overscroll-behavior-y: contain; }
    </style>
</head>
<!-- Menggunakan h-[100dvh] untuk handling mobile browser address bar -->
<body class="bg-slate-50 text-slate-800 font-sans overflow-hidden h-[100dvh] w-full" x-data="appData">

    <!-- Background Blobs (Fixed) -->
    <div class="fixed top-0 left-0 w-full h-full overflow-hidden -z-10 pointer-events-none">
        <div class="absolute top-[-10%] left-[-10%] w-96 h-96 bg-emerald-400/10 rounded-full blur-[120px] animate-float"></div>
        <div class="absolute bottom-[-10%] right-[-10%] w-96 h-96 bg-blue-400/10 rounded-full blur-[120px] animate-float" style="animation-delay: 2s;"></div>
    </div>

    <div class="flex h-full w-full">
        <!-- === SIDEBAR (Desktop) === -->
        <aside class="hidden md:flex flex-col w-72 bg-white border-r border-slate-200 h-full z-30 shadow-sm shrink-0">
            <div class="p-8 flex items-center gap-3">
                <div class="w-10 h-10 bg-emerald-500 rounded-xl shadow-lg shadow-emerald-200 flex items-center justify-center overflow-hidden text-white font-bold text-xl">S</div>
                <div>
                    <h1 class="font-bold text-xl tracking-tight text-slate-900 leading-none">SORTIQ</h1>
                    <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest mt-1">Smart Recycle</p>
                </div>
            </div>

            <nav class="flex-1 px-4 space-y-1 overflow-y-auto no-scrollbar py-4">
                <p class="px-4 text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2">Navigasi Utama</p>
                <template x-for="item in navItems" :key="item.id">
                    <button @click="setPage(item.id)" 
                            :class="currentPage === item.id ? 'bg-emerald-50 text-emerald-600 border-emerald-100 shadow-sm' : 'text-slate-500 hover:bg-slate-50 border-transparent'"
                            class="w-full flex items-center gap-4 px-4 py-3.5 rounded-2xl font-semibold text-sm transition-all duration-200 border group relative">
                        <i :class="item.icon" class="text-xl transition-transform group-hover:scale-110"></i>
                        <span x-text="item.label"></span>
                        <div x-show="currentPage === item.id" class="absolute right-0 top-1/2 -translate-y-1/2 w-1 h-8 bg-emerald-500 rounded-l-full"></div>
                    </button>
                </template>

                <p class="px-4 text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2 mt-6">Fitur Pintar</p>
                <button @click="notify('Fitur Scanner memerlukan akses kamera.', 'info')" class="text-slate-500 hover:bg-emerald-50 hover:text-emerald-600 w-full flex items-center gap-4 px-4 py-3.5 rounded-2xl font-semibold text-sm transition-all duration-200 border border-transparent group">
                    <i class="ph-bold ph-scan text-xl transition-transform group-hover:scale-110"></i>
                    <span>AI Scanner</span>
                    <span class="ml-auto bg-emerald-100 text-emerald-600 text-[10px] px-2 py-0.5 rounded-full">New</span>
                </button>
            </nav>

            <div class="p-4 border-t border-slate-100">
                <button @click="if(confirm('Apakah Anda yakin ingin keluar?')) window.location.reload()" class="w-full flex items-center gap-3 text-red-500 font-bold text-sm hover:bg-red-50 p-4 rounded-2xl transition group">
                    <i class="ph-bold ph-sign-out text-xl group-hover:-translate-x-1 transition"></i> Keluar Akun
                </button>
            </div>
        </aside>

        <!-- === MAIN CONTENT === -->
        <main class="flex-1 flex flex-col h-full relative overflow-hidden bg-slate-50/50">
            <!-- Header -->
            <header class="flex justify-between items-center px-5 py-4 md:px-10 md:py-6 z-20 glass sticky top-0 shrink-0">
                <div class="flex items-center gap-3 md:hidden">
                    <div class="w-9 h-9 bg-emerald-500 rounded-xl shadow-sm flex items-center justify-center text-white font-bold">S</div>
                    <div>
                        <span class="font-bold text-lg tracking-tight block leading-none">SORTIQ</span>
                        <span class="text-[10px] text-slate-500 font-medium">Dashboard</span>
                    </div>
                </div>
                <div class="hidden md:block">
                    <h2 class="text-2xl font-bold text-slate-800 tracking-tight" x-text="pageTitle"></h2>
                    <p class="text-slate-500 text-sm">Selamat datang kembali, <span x-text="username"></span>!</p>
                </div>
                <div class="flex items-center gap-3">
                    <div class="bg-white pl-2 pr-3 py-1.5 rounded-full border border-slate-200 shadow-sm flex items-center gap-2 cursor-pointer hover:bg-slate-50 transition">
                        <div class="w-7 h-7 bg-yellow-100 rounded-full flex items-center justify-center text-yellow-600"><i class="ph-fill ph-coin text-sm"></i></div>
                        <span class="font-bold text-sm text-slate-700" x-text="xp + ' XP'"></span>
                    </div>
                    <img :src="`https://ui-avatars.com/api/?name=${username}&background=10b981&color=fff`" class="w-10 h-10 rounded-full border-2 border-white shadow-sm hidden sm:block">
                </div>
            </header>

            <!-- Scrollable Content -->
            <!-- pb-40 digunakan untuk memastikan konten paling bawah tidak tertutup nav bar mobile -->
            <div class="flex-1 overflow-y-auto p-5 md:p-10 pb-40 md:pb-10 scroll-smooth" id="main-scroll">
                
                <!-- 1. HOME VIEW -->
                <div x-show="currentPage === 'home'" x-transition.opacity.duration.300ms class="space-y-6 md:space-y-8 max-w-6xl mx-auto">
                    <!-- Banner -->
                    <div class="grid md:grid-cols-3 gap-6">
                        <div class="md:col-span-2 bg-slate-900 rounded-[2rem] p-6 md:p-10 text-white relative overflow-hidden shadow-2xl group flex flex-col justify-center min-h-[220px]">
                            <div class="absolute top-0 right-0 w-64 h-64 bg-emerald-500 rounded-full blur-[100px] opacity-20 group-hover:opacity-30 transition duration-700"></div>
                            <div class="relative z-10">
                                <div class="inline-flex items-center gap-2 px-3 py-1 bg-white/10 backdrop-blur-md rounded-full text-[10px] font-bold mb-4 text-emerald-300 border border-white/10 uppercase tracking-widest">✨ Mulai Aksimu</div>
                                <h2 class="text-2xl md:text-3xl font-extrabold mb-3 leading-tight">Sudah Scan Sampah?</h2>
                                <p class="text-slate-300 mb-6 text-sm max-w-md">Kumpulkan sampah di rumah, scan dengan AI, lalu setor ke lokasi terdekat untuk dapat poin.</p>
                                <button @click="notify('Membuka kamera untuk scan...', 'success')" class="w-max bg-emerald-500 hover:bg-emerald-400 text-white px-6 py-3 rounded-2xl font-bold shadow-lg shadow-emerald-500/30 transition active:scale-95 flex items-center gap-2 text-sm">
                                    <i class="ph-bold ph-camera text-lg"></i> Scan Sekarang
                                </button>
                            </div>
                        </div>

                        <!-- KANTONG SAMPAH DIGITAL -->
                        <div class="bg-white p-6 rounded-[2rem] border border-slate-200 shadow-sm flex flex-col justify-between relative overflow-hidden min-h-[220px]">
                            <div class="absolute -right-6 -top-6 w-24 h-24 bg-blue-50 rounded-full"></div>
                            <div class="relative z-10">
                                <h3 class="font-bold text-slate-800 text-lg flex items-center gap-2">
                                    <i class="ph-duotone ph-bag text-blue-500 text-2xl"></i> Kantong Saya
                                </h3>
                                <div class="mt-6 space-y-3">
                                    <div class="flex justify-between items-end pb-2 border-b border-slate-50">
                                        <span class="text-slate-500 text-sm font-medium">Berat</span>
                                        <span class="text-xl font-black text-slate-800"><span x-text="trashBag.weight"></span> <span class="text-sm font-bold text-slate-400">Kg</span></span>
                                    </div>
                                    <div class="flex justify-between items-end">
                                        <span class="text-slate-500 text-sm font-medium">Potensi</span>
                                        <span class="text-xl font-black text-emerald-600">+<span x-text="trashBag.potentialXP"></span> <span class="text-sm font-bold text-emerald-400">XP</span></span>
                                    </div>
                                </div>
                            </div>
                            <button @click="setPage('tpa')" class="mt-4 w-full bg-slate-50 hover:bg-emerald-50 text-slate-600 hover:text-emerald-700 py-3 rounded-xl font-bold text-sm transition flex items-center justify-center gap-2">
                                <i class="ph-bold ph-map-pin"></i> Setor Sampah
                            </button>
                        </div>
                    </div>

                    <!-- FITUR UTAMA - GRID -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <!-- Card 1 -->
                        <div class="bg-white p-5 rounded-[2rem] border border-slate-200 shadow-sm hover:shadow-lg transition duration-300 flex flex-col justify-between h-full relative group min-h-[180px]">
                            <div>
                                <div class="flex justify-between items-start mb-3">
                                    <div class="w-10 h-10 bg-emerald-50 text-emerald-600 rounded-xl flex items-center justify-center text-xl shadow-sm">
                                        <i class="ph-fill ph-trash"></i>
                                    </div>
                                    <span class="text-[10px] font-bold text-slate-400 bg-slate-50 px-2 py-1 rounded-lg">LIVE</span>
                                </div>
                                <h4 class="text-slate-400 text-[10px] font-bold uppercase tracking-wider mb-1">Status Kantong</h4>
                                <p class="text-xl font-black text-slate-800 mb-2"><span x-text="trashBag.weight > 0 ? trashBag.weight : '0'"></span> kg</p>
                                <div class="w-full bg-slate-100 h-1.5 rounded-full overflow-hidden">
                                    <div class="h-full bg-emerald-500 rounded-full" style="width: 45%"></div>
                                </div>
                            </div>
                            <button @click="setPage('bag')" class="mt-3 w-full py-2 text-slate-500 text-xs font-bold hover:text-emerald-600 transition flex items-center gap-1">
                                Detail <i class="ph-bold ph-caret-right"></i>
                            </button>
                        </div>

                        <!-- Card 2 -->
                        <div class="bg-white p-5 rounded-[2rem] border border-slate-200 shadow-sm hover:shadow-lg transition duration-300 flex flex-col justify-between h-full relative group min-h-[180px]">
                            <div>
                                <div class="flex justify-between items-start mb-3">
                                    <div class="w-10 h-10 bg-blue-50 text-blue-600 rounded-xl flex items-center justify-center text-xl shadow-sm">
                                        <i class="ph-fill ph-map-pin"></i>
                                    </div>
                                    <span class="text-[10px] font-bold text-blue-600 bg-blue-50 px-2 py-1 rounded-lg">~ 350m</span>
                                </div>
                                <h4 class="text-slate-400 text-[10px] font-bold uppercase tracking-wider mb-1">Terdekat</h4>
                                <p class="text-lg font-black text-slate-800 leading-tight">Unit RW 05</p>
                                <p class="text-xs text-slate-500 mt-1">Buka sampai 16:00</p>
                            </div>
                            <button @click="openGmaps()" class="mt-3 w-full py-2 text-slate-500 text-xs font-bold hover:text-blue-600 transition flex items-center gap-1">
                                Navigasi <i class="ph-bold ph-caret-right"></i>
                            </button>
                        </div>

                        <!-- Card 3 -->
                        <div class="bg-white p-5 rounded-[2rem] border border-slate-200 shadow-sm hover:shadow-lg transition duration-300 flex flex-col justify-between h-full relative group min-h-[180px]">
                            <div>
                                <div class="flex justify-between items-start mb-3">
                                    <div class="w-10 h-10 bg-purple-50 text-purple-600 rounded-xl flex items-center justify-center text-xl shadow-sm">
                                        <i class="ph-fill ph-chart-line-up"></i>
                                    </div>
                                    <span class="text-[10px] font-bold text-emerald-600 bg-emerald-50 px-2 py-1 rounded-lg">▲ 5%</span>
                                </div>
                                <h4 class="text-slate-400 text-[10px] font-bold uppercase tracking-wider mb-1">Harga Sampah</h4>
                                <p class="text-lg font-black text-slate-800">Plastik PET</p>
                                <p class="text-xs text-purple-600 font-bold">+50 XP/kg</p>
                            </div>
                            <button @click="setPage('market')" class="mt-3 w-full py-2 text-slate-500 text-xs font-bold hover:text-purple-600 transition flex items-center gap-1">
                                Cek Pasar <i class="ph-bold ph-caret-right"></i>
                            </button>
                        </div>

                        <!-- Card 4 -->
                        <div class="bg-white p-5 rounded-[2rem] border border-slate-200 shadow-sm hover:shadow-lg transition duration-300 flex flex-col justify-between h-full relative group min-h-[180px]">
                            <div>
                                <div class="flex justify-between items-start mb-3">
                                    <div class="w-10 h-10 bg-orange-50 text-orange-600 rounded-xl flex items-center justify-center text-xl shadow-sm">
                                        <i class="ph-fill ph-fire"></i>
                                    </div>
                                    <span class="text-[10px] font-bold text-orange-600 bg-orange-50 px-2 py-1 rounded-lg">3 Hari</span>
                                </div>
                                <h4 class="text-slate-400 text-[10px] font-bold uppercase tracking-wider mb-1">Daily Streak</h4>
                                <p class="text-lg font-black text-slate-800">Keep it up!</p>
                                <p class="text-xs text-slate-500 mt-1">Setor besok: +20 XP</p>
                            </div>
                            <button @click="notify('Membuka kamera...', 'success')" class="mt-3 w-full py-2 text-slate-500 text-xs font-bold hover:text-orange-600 transition flex items-center gap-1">
                                Scan <i class="ph-bold ph-caret-right"></i>
                            </button>
                        </div>
                    </div> 
                    
                    <!-- History Section -->
                    <div class="bg-white p-6 rounded-[2rem] border border-slate-200 shadow-sm">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-lg text-slate-800 flex items-center gap-2">
                                <i class="ph-fill ph-clock-counter-clockwise text-emerald-500"></i> Setoran Terakhir
                            </h3>
                            <button @click="setPage('history')" class="text-xs font-bold text-emerald-600 hover:text-emerald-700">Lihat Semua</button>
                        </div>
                        
                        <div class="space-y-3">
                            <template x-for="item in userHistory.slice(0, 3)" :key="item.id">
                                <div class="flex items-center justify-between p-4 bg-slate-50 rounded-2xl border border-slate-100 hover:bg-white hover:shadow-md transition duration-200 cursor-pointer">
                                    <div class="flex items-center gap-4">
                                        <div class="w-10 h-10 rounded-full flex items-center justify-center text-xl shrink-0" 
                                             :class="item.status === 'Approved' ? 'bg-emerald-100 text-emerald-600' : 'bg-yellow-100 text-yellow-600'">
                                            <i :class="item.status === 'Approved' ? 'ph-bold ph-check' : 'ph-bold ph-hourglass'"></i>
                                        </div>
                                        <div>
                                            <div class="flex items-center gap-2 mb-0.5">
                                                <p class="font-bold text-slate-800 text-sm" x-text="item.weight + ' Kg Sampah'"></p>
                                                <span class="text-[9px] font-bold px-1.5 py-0.5 rounded-md uppercase" 
                                                      :class="item.status === 'Approved' ? 'bg-emerald-50 text-emerald-700' : 'bg-yellow-50 text-yellow-700'"
                                                      x-text="item.status === 'Approved' ? 'SUKSES' : 'PROSES'">
                                                </span>
                                            </div>
                                            <p class="text-[10px] text-slate-500 flex items-center gap-1">
                                                <i class="ph-bold ph-calendar-blank"></i> <span x-text="formatDate(item.date)"></span>
                                            </p>
                                        </div>
                                    </div>
                                    <div class="text-right shrink-0">
                                        <p class="font-black text-emerald-600 text-sm" x-text="'+' + item.xpReward"></p>
                                        <p class="text-[10px] font-bold text-emerald-400">XP</p>
                                    </div>
                                </div>
                            </template>
                            
                            <div x-show="userHistory.length === 0" class="text-center py-8 text-slate-400 text-xs italic">
                                Belum ada riwayat setoran. Ayo mulai setor sampah!
                            </div>
                        </div>
                    </div>
                </div> 

                <!-- 2. BAG VIEW (Consistent Layout) -->
                <div x-show="currentPage === 'bag'" x-transition.opacity.duration.300ms class="space-y-6 max-w-6xl mx-auto">
                    <div class="bg-white rounded-[2.5rem] p-8 md:p-10 shadow-sm border border-slate-100 relative overflow-hidden flex flex-col md:flex-row justify-between items-end gap-6">
                        <div class="relative z-10 w-full md:w-auto">
                            <button @click="setPage('home')" class="group flex items-center gap-2 text-slate-400 hover:text-slate-800 text-sm font-bold mb-6 transition-colors">
                                <i class="ph-bold ph-arrow-left group-hover:-translate-x-1 transition-transform"></i> Kembali
                            </button>
                            <div class="space-y-1">
                                <p class="text-slate-400 font-bold uppercase tracking-widest text-[10px]">Total Akumulasi</p>
                                <div class="flex items-baseline gap-1">
                                    <h1 class="text-7xl md:text-8xl font-black text-slate-800 tracking-tighter" x-text="trashBag.weight"></h1>
                                    <span class="text-3xl font-bold text-slate-300">kg</span>
                                </div>
                            </div>
                        </div>
                        <div class="relative z-10 w-full md:w-auto flex flex-col items-end gap-4">
                            <div class="bg-gradient-to-br from-emerald-500 to-emerald-600 text-white p-6 rounded-[2rem] shadow-xl shadow-emerald-200/50 w-full md:w-64 relative overflow-hidden group">
                                <div class="relative z-10">
                                    <p class="text-emerald-100 text-[10px] font-bold uppercase tracking-widest mb-1">Estimasi Reward</p>
                                    <div class="flex items-baseline gap-1 mb-1">
                                        <span class="text-lg font-medium text-emerald-200">+</span>
                                        <h2 class="text-5xl font-black tracking-tight" x-text="trashBag.potentialXP"></h2>
                                        <span class="text-sm font-bold text-emerald-100">XP</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Categories Grid -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <template x-for="cat in trashCategories" :key="cat.name">
                            <div class="bg-white p-5 rounded-[2rem] border border-slate-200 shadow-sm flex flex-col gap-4">
                                <div class="flex items-center gap-4">
                                    <div :class="cat.lightColor + ' ' + cat.textColor" class="w-12 h-12 rounded-2xl flex items-center justify-center text-2xl">
                                        <i :class="cat.icon"></i>
                                    </div>
                                    <div class="flex-1">
                                        <h3 class="font-bold text-slate-800" x-text="cat.name"></h3>
                                        <p class="text-xs text-slate-400 font-medium"><span x-text="cat.price"></span></p>
                                    </div>
                                    <div class="text-right">
                                        <p :class="cat.textColor" class="text-lg font-black" x-text="(trashBag.weight * cat.ratio).toFixed(1) + ' kg'"></p>
                                    </div>
                                </div>
                                <div class="w-full bg-slate-100 h-2 rounded-full overflow-hidden">
                                    <div class="h-full rounded-full" :style="`width: ${(trashBag.weight * cat.ratio / 10) * 100}%; background-color: ${cat.hexColor}`"></div>
                                </div>
                            </div>
                        </template>
                    </div>
                    <button @click="setPage('tpa')" class="w-full bg-slate-800 hover:bg-emerald-600 text-white font-bold py-4 px-8 rounded-2xl transition-all flex items-center justify-center gap-3 shadow-lg active:scale-95">
                        <i class="ph-bold ph-map-pin"></i> Cari Dropbox Terdekat
                    </button>
                </div>

                <!-- 3. TPA VIEW -->
                <div x-show="currentPage === 'tpa'" x-transition.opacity.duration.300ms class="h-full flex flex-col gap-6 max-w-7xl mx-auto">
                    <!-- Search & List Container -->
                    <div class="flex flex-col gap-4">
                        <div class="bg-white p-2 rounded-2xl border border-slate-200 shadow-sm">
                            <div class="relative">
                                <i class="ph-bold ph-magnifying-glass absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
                                <input type="text" x-model="tpaSearch" placeholder="Cari Bank Sampah..." class="w-full pl-12 pr-4 py-3 bg-slate-50 rounded-xl text-sm outline-none focus:ring-2 focus:ring-emerald-500/20 border border-transparent focus:border-emerald-500 transition-all">
                            </div>
                        </div>
                        
                        <!-- List Horizontal Scroll on Mobile -->
                        <div class="flex md:grid md:grid-cols-3 gap-3 overflow-x-auto pb-2 no-scrollbar snap-x">
                            <template x-for="tpa in filteredTpa" :key="tpa.id">
                                <button @click="selectTpa(tpa.id)" 
                                        :class="selectedTpaId === tpa.id ? 'border-emerald-500 bg-emerald-50 ring-2 ring-emerald-500/20' : 'border-slate-200 bg-white'"
                                        class="min-w-[280px] md:min-w-0 text-left p-4 rounded-2xl border transition-all snap-center">
                                    <div class="flex justify-between items-start mb-2">
                                        <span class="font-bold text-sm leading-tight text-slate-800 line-clamp-1" x-text="tpa.nama"></span>
                                        <div :class="tpa.tipe.includes('Recycling') ? 'bg-emerald-500' : 'bg-slate-400'" class="w-2 h-2 rounded-full shrink-0 mt-1"></div>
                                    </div>
                                    <p class="text-[10px] text-slate-500 mb-3 line-clamp-1" x-text="tpa.alamat"></p>
                                    <span class="text-[9px] bg-slate-200 text-slate-600 px-2 py-1 rounded-lg font-bold uppercase" x-text="tpa.jarak"></span>
                                </button>
                            </template>
                        </div>
                    </div>

                    <!-- Map Container (Takes remaining height) -->
                    <div class="flex-1 bg-white rounded-[2rem] border border-slate-200 shadow-sm overflow-hidden flex flex-col min-h-[400px]">
                        <div class="flex-1 relative">
                            <iframe :src="`https://maps.google.com/maps?q=${selectedTpa.lat},${selectedTpa.lng}&t=m&z=${selectedTpa.zoom}&ie=UTF8&iwloc=&output=embed`" width="100%" height="100%" frameborder="0"></iframe>
                        </div>
                        <div class="p-6 bg-white border-t border-slate-100 shrink-0">
                            <div class="flex flex-col gap-4">
                                <div>
                                    <h3 class="text-xl font-bold text-slate-800" x-text="selectedTpa.nama"></h3>
                                    <p class="text-slate-500 text-sm flex items-center gap-1 mt-1"><i class="ph-bold ph-map-pin text-emerald-500"></i> <span x-text="selectedTpa.alamat"></span></p>
                                </div>
                                <div class="flex gap-3">
                                    <button @click="openDepositModal()" class="flex-1 bg-emerald-600 text-white px-6 py-3.5 rounded-xl font-bold shadow-lg shadow-emerald-200 active:scale-95 transition">Setor Di Sini</button>
                                    <button @click="openGmaps()" class="bg-slate-100 text-slate-600 px-4 py-3.5 rounded-xl font-bold hover:bg-slate-200 active:scale-95 transition"><i class="ph-bold ph-navigation-arrow text-xl"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 3. CHAT BOT VIEW -->
                <div x-show="currentPage === 'bot'" x-transition.opacity.duration.300ms class="flex flex-col h-full bg-white rounded-[2rem] border border-slate-200 shadow-sm overflow-hidden max-w-4xl mx-auto">
                    <div class="p-4 bg-white border-b border-slate-100 flex items-center gap-3 shrink-0">
                        <div class="w-10 h-10 bg-emerald-600 rounded-xl flex items-center justify-center text-white shadow-sm"><i class="ph-bold ph-robot text-xl"></i></div>
                        <div><h3 class="font-bold text-slate-800">SORTIQ Assistant</h3><p class="text-[10px] text-emerald-500 font-bold">Online</p></div>
                    </div>
                    <div class="flex-1 bg-slate-50/50 p-4 overflow-y-auto space-y-4 no-scrollbar" id="chat-container">
                        <template x-for="msg in chatMessages" :key="msg.id">
                            <div :class="msg.sender === 'bot' ? 'flex justify-start' : 'flex justify-end'">
                                <div :class="msg.sender === 'bot' ? 'bg-white border border-slate-200 text-slate-700 rounded-tl-sm' : 'bg-slate-900 text-white rounded-tr-sm'" class="p-3.5 rounded-2xl shadow-sm max-w-[85%] text-sm leading-relaxed">
                                    <p x-html="msg.text"></p>
                                    <p class="text-[9px] mt-1 opacity-60 text-right" x-text="msg.time"></p>
                                </div>
                            </div>
                        </template>
                        <div x-show="isTyping" class="flex justify-start"><div class="bg-white border border-slate-200 px-4 py-3 rounded-2xl rounded-tl-sm text-xs text-slate-400 font-bold tracking-wide">Mengetik...</div></div>
                    </div>
                    <div class="p-4 bg-white border-t border-slate-100 shrink-0 mb-safe">
                        <form @submit.prevent="sendMessage" class="flex gap-2">
                            <input type="text" x-model="chatInput" placeholder="Ketik pesan..." class="flex-1 bg-slate-100 rounded-xl px-4 py-3 text-sm outline-none focus:ring-2 focus:ring-emerald-500 transition">
                            <button type="submit" :disabled="!chatInput" class="bg-slate-900 text-white w-12 h-12 rounded-xl flex items-center justify-center shadow-lg active:scale-95 disabled:opacity-50 transition"><i class="ph-bold ph-paper-plane-right"></i></button>
                        </form>
                    </div>
                </div>

                <!-- 4. ECO MARKET VIEW -->
                <div x-show="currentPage === 'market'" x-transition.opacity.duration.300ms class="max-w-6xl mx-auto space-y-6">
                    <div class="flex justify-center">
                        <div class="bg-slate-100 p-1 rounded-xl flex w-full max-w-md">
                            <button @click="marketTab = 'redeem'" :class="marketTab === 'redeem' ? 'bg-white text-emerald-600 shadow-sm' : 'text-slate-500'" class="flex-1 py-2.5 rounded-lg font-bold text-sm transition-all">Tukar Poin</button>
                            <button @click="marketTab = 'shop'" :class="marketTab === 'shop' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500'" class="flex-1 py-2.5 rounded-lg font-bold text-sm transition-all">Toko Hijau</button>
                        </div>
                    </div>

                    <div class="flex justify-between items-end px-2">
                        <div>
                            <h2 class="text-xl font-bold text-slate-800" x-text="marketTab === 'redeem' ? 'Rewards Kamu' : 'Belanja Produk'"></h2>
                            <p class="text-xs text-slate-500">Saldo: <span class="font-black text-emerald-600" x-text="xp + ' XP'"></span></p>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <template x-for="item in marketItems" :key="item.id">
                            <div x-show="marketTab === item.category" class="bg-white p-4 rounded-[1.5rem] border border-slate-200 shadow-sm flex flex-col h-full active:scale-[0.98] transition duration-200">
                                <div :class="item.bgClass" class="aspect-square rounded-2xl mb-3 flex items-center justify-center text-4xl shadow-inner relative overflow-hidden">
                                    <i :class="item.icon"></i>
                                </div>
                                <div class="flex-1">
                                    <h4 class="font-bold text-sm text-slate-800 leading-tight line-clamp-2" x-text="item.name"></h4>
                                    <p class="text-[10px] text-slate-500 mt-1 mb-2 line-clamp-2" x-text="item.desc"></p>
                                </div>
                                <div class="mt-auto pt-3 border-t border-slate-50 flex justify-between items-center">
                                    <span class="font-black text-slate-800 text-xs" x-text="item.cost"></span>
                                    <button @click="startTransaction(item)" class="w-8 h-8 rounded-full bg-slate-900 text-white flex items-center justify-center hover:bg-emerald-600 transition shadow-lg">
                                        <i class="ph-bold ph-plus"></i>
                                    </button>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- 5. MARKET ORDERS VIEW -->
                <div x-show="currentPage === 'orders'" x-transition.opacity.duration.300ms class="max-w-2xl mx-auto">
                    <h2 class="text-2xl font-bold text-slate-900 mb-6 px-2">Riwayat Belanja</h2>
                    <div class="bg-white rounded-[2rem] border border-slate-200 shadow-sm overflow-hidden">
                        <div class="divide-y divide-slate-50">
                            <template x-for="order in marketOrders" :key="order.id">
                                <div class="p-5 flex items-center justify-between">
                                    <div class="flex items-center gap-4">
                                        <div class="w-10 h-10 rounded-xl flex items-center justify-center text-lg shadow-sm" 
                                             :class="order.itemType === 'xp' ? 'bg-purple-50 text-purple-600' : 'bg-blue-50 text-blue-600'">
                                            <i :class="order.itemType === 'xp' ? 'ph-bold ph-gift' : 'ph-bold ph-shopping-bag'"></i>
                                        </div>
                                        <div>
                                            <h4 class="font-bold text-sm text-slate-800 line-clamp-1" x-text="order.itemName"></h4>
                                            <div class="flex items-center gap-2 mt-0.5">
                                                <span class="text-[9px] font-bold px-1.5 py-0.5 rounded uppercase" 
                                                      :class="order.status === 'Selesai' ? 'bg-emerald-100 text-emerald-700' : 'bg-slate-100 text-slate-600'"
                                                      x-text="order.status">
                                                </span>
                                                <span class="text-[10px] text-slate-400" x-text="formatDate(order.date)"></span>
                                            </div>
                                        </div>
                                    </div>
                                    <p class="font-bold text-xs" :class="order.itemType === 'xp' ? 'text-purple-600' : 'text-slate-800'" x-text="order.costDisplay"></p>
                                </div>
                            </template>
                             <div x-show="marketOrders.length === 0" class="text-center py-12 px-4">
                                <div class="w-16 h-16 bg-slate-50 rounded-full mx-auto mb-3 flex items-center justify-center text-2xl text-slate-400"><i class="ph-duotone ph-shopping-cart"></i></div>
                                <p class="text-sm text-slate-400">Belum Ada Transaksi</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 6. HISTORY VIEW -->
                <div x-show="currentPage === 'history'" x-transition.opacity.duration.300ms class="max-w-2xl mx-auto">
                    <div class="flex items-center gap-4 mb-6 px-2">
                        <button @click="setPage('home')" class="w-10 h-10 rounded-xl bg-white border border-slate-200 flex items-center justify-center hover:bg-slate-50 transition shadow-sm text-slate-600">
                            <i class="ph-bold ph-arrow-left text-lg"></i>
                        </button>
                        <h2 class="text-2xl font-bold text-slate-800">Riwayat Setoran</h2>
                    </div>

                    <div class="bg-white rounded-[2rem] border border-slate-200 shadow-sm overflow-hidden">
                        <div class="divide-y divide-slate-50">
                            <template x-for="item in userHistory" :key="item.id">
                                <div class="p-5 flex items-center justify-between hover:bg-slate-50 transition">
                                    <div class="flex items-center gap-4">
                                        <div class="w-10 h-10 rounded-full flex items-center justify-center text-lg shrink-0" 
                                             :class="item.status === 'Approved' ? 'bg-emerald-100 text-emerald-600' : 'bg-yellow-100 text-yellow-600'">
                                            <i :class="item.status === 'Approved' ? 'ph-bold ph-check' : 'ph-bold ph-hourglass'"></i>
                                        </div>
                                        <div>
                                            <h4 class="font-bold text-slate-800 text-sm" x-text="item.weight + ' Kg Sampah'"></h4>
                                            <p class="text-[10px] text-slate-500 mt-0.5"><i class="ph-fill ph-calendar text-slate-400"></i> <span x-text="formatDate(item.date)"></span></p>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <p class="font-black text-sm text-emerald-600" x-text="'+' + item.xpReward"></p>
                                        <p class="text-[9px] font-bold text-slate-400">XP</p>
                                    </div>
                                </div>
                            </template>
                             <div x-show="userHistory.length === 0" class="text-center py-12">
                                <p class="text-sm text-slate-400">Belum ada riwayat.</p>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- === FLOATING MOBILE NAVIGATION (BLURRED) === -->
    <!-- Safe-area-bottom handled by pb-safe in styles if needed, or manual adjustment -->
    <div class="md:hidden fixed bottom-6 left-4 right-4 glass-nav backdrop-blur-xl rounded-[2rem] p-2 flex justify-between items-center shadow-2xl z-50">
        <button @click="setPage('home')" :class="currentPage === 'home' ? 'text-white bg-white/20' : 'text-slate-400'" class="w-12 h-12 flex items-center justify-center rounded-full transition-all active:scale-90"><i class="ph-bold ph-squares-four text-2xl"></i></button>
        <button @click="setPage('tpa')" :class="currentPage === 'tpa' ? 'text-white bg-white/20' : 'text-slate-400'" class="w-12 h-12 flex items-center justify-center rounded-full transition-all active:scale-90"><i class="ph-bold ph-map-trifold text-2xl"></i></button>
        
        <!-- Center Action Button -->
        <div class="relative -top-6">
            <button @click="notify('Fitur Scanner Aktif', 'success')" class="w-16 h-16 bg-gradient-to-tr from-emerald-500 to-emerald-400 rounded-full flex items-center justify-center text-white shadow-xl shadow-emerald-500/40 border-[4px] border-slate-50 transition active:scale-90"><i class="ph-bold ph-scan text-2xl"></i></button>
        </div>
        
        <button @click="setPage('market')" :class="currentPage === 'market' ? 'text-white bg-white/20' : 'text-slate-400'" class="w-12 h-12 flex items-center justify-center rounded-full transition-all active:scale-90"><i class="ph-bold ph-storefront text-2xl"></i></button>
        <button @click="setPage('bot')" :class="currentPage === 'bot' ? 'text-white bg-white/20' : 'text-slate-400'" class="w-12 h-12 flex items-center justify-center rounded-full transition-all active:scale-90"><i class="ph-bold ph-chat-centered-text text-2xl"></i></button>
    </div>

    <!-- === TOAST NOTIFICATION === -->
    <div class="fixed top-4 left-4 right-4 z-[60] flex flex-col gap-2 pointer-events-none" x-show="notification.show" x-transition:enter="toast-enter" x-transition:enter-start="toast-enter" x-transition:enter-end="toast-enter-active" x-transition:leave="toast-leave" x-transition:leave-start="toast-leave" x-transition:leave-end="toast-leave-active" style="display: none;">
        <div class="bg-slate-900/90 backdrop-blur-md text-white px-4 py-3 rounded-2xl shadow-xl flex items-center gap-3 mx-auto w-full max-w-sm pointer-events-auto border border-white/10">
            <i class="ph-fill text-xl shrink-0" :class="notification.type === 'success' ? 'ph-check-circle text-emerald-400' : (notification.type === 'error' ? 'ph-warning-circle text-red-400' : 'ph-info text-blue-400')"></i>
            <div>
                <p class="text-xs font-medium text-slate-200" x-text="notification.message"></p>
            </div>
        </div>
    </div>

    <!-- === MODAL SETOR SAMPAH === -->
    <div x-show="showDepositModal" class="fixed inset-0 z-50 flex items-center justify-center px-4" style="display: none;">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" @click="showDepositModal = false"></div>
        <div class="bg-white w-full max-w-sm rounded-[2.5rem] shadow-2xl relative z-10 p-6 text-center transform transition-all">
            <div x-show="depositStep === 1">
                <div class="w-16 h-16 bg-emerald-100 rounded-full mx-auto mb-4 flex items-center justify-center text-3xl text-emerald-600"><i class="ph-duotone ph-recycle"></i></div>
                <h3 class="text-xl font-bold text-slate-900 mb-2">Konfirmasi</h3>
                <p class="text-sm text-slate-500 mb-6 px-4">Masukkan alamat penjemputan untuk <b x-text="selectedTpa?.nama"></b>.</p>
                <div class="bg-slate-50 p-4 rounded-2xl mb-4 border border-slate-100 text-left">
                    <label class="block text-xs font-bold text-slate-400 mb-1">Alamat</label>
                    <textarea x-model="depositData.address" placeholder="Jl. Mawar No. 12..." class="w-full bg-transparent text-sm resize-none outline-none font-medium h-12 placeholder-slate-300"></textarea>
                </div>
                <button @click="processDeposit()" class="w-full bg-emerald-600 text-white py-4 rounded-xl font-bold shadow-lg hover:bg-emerald-700 active:scale-95 transition">Request Jemput</button>
            </div>
            <!-- Steps 2, 3, 4 simplified for brevity (same logic) -->
            <div x-show="depositStep > 1" class="py-10">
                <div class="w-20 h-20 bg-emerald-500 rounded-full mx-auto mb-4 flex items-center justify-center text-4xl text-white animate-bounce"><i class="ph-bold ph-check"></i></div>
                <h3 class="text-xl font-bold text-emerald-700">Berhasil!</h3>
                <p class="text-sm text-slate-500 mt-2">Permintaan telah dikirim.</p>
                <button @click="showDepositModal = false" class="mt-6 text-slate-400 font-bold text-sm">Tutup</button>
            </div>
        </div>
    </div>

    <!-- === MODAL PEMBAYARAN === -->
    <div x-show="showPaymentModal" class="fixed inset-0 z-50 flex items-center justify-center px-4" style="display: none;">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" @click="closePayment()"></div>
        <div class="bg-white w-full max-w-sm rounded-[2.5rem] shadow-2xl relative z-10 p-6 flex flex-col max-h-[80vh]">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-bold text-slate-800 text-lg">Checkout</h3>
                <button @click="closePayment()" class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center"><i class="ph-bold ph-x"></i></button>
            </div>
            <div class="flex-1 overflow-y-auto no-scrollbar">
                <div x-show="paymentStep === 1">
                    <div class="flex gap-4 mb-6 bg-slate-50 p-4 rounded-2xl border border-slate-100 items-center">
                        <div class="w-14 h-14 bg-white rounded-xl flex items-center justify-center text-2xl shadow-sm shrink-0"><i :class="selectedItem?.icon" :class="selectedItem?.bgClass.replace('bg-', 'text-').split(' ')[1]"></i></div>
                        <div>
                            <h4 class="font-bold text-slate-900 leading-tight" x-text="selectedItem?.name"></h4>
                            <p class="text-sm font-black text-emerald-600 mt-0.5" x-text="selectedItem?.cost"></p>
                        </div>
                    </div>
                    <button @click="processPayment()" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-bold shadow-lg active:scale-95 transition">Konfirmasi</button>
                </div>
                <div x-show="paymentStep > 1" class="text-center py-8">
                    <div class="w-16 h-16 bg-emerald-100 rounded-full mx-auto mb-4 flex items-center justify-center text-3xl text-emerald-600"><i class="ph-fill ph-check-circle"></i></div>
                    <h3 class="font-bold text-slate-800">Transaksi Sukses!</h3>
                    <button @click="closePayment()" class="mt-6 w-full bg-slate-100 py-3 rounded-xl font-bold text-sm text-slate-600">Selesai</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Alpine JS Logic (Same logic, minified visuals) -->
    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.data('appData', () => ({
                currentPage: 'home', pageTitle: 'Dashboard', xp: 1500, username: 'Tamu', email: '',
                showPaymentModal: false, selectedItem: null, paymentStep: 1, 
                showDepositModal: false, depositStep: 1, marketTab: 'redeem', isTyping: false,
                trashBag: { weight: 0, potentialXP: 0 }, shippingData: { address: '', method: 'pickup', note: '' },
                depositData: { address: '' }, userHistory: [], marketOrders: [],
                notification: { show: false, message: '', type: 'info' },
                trashCategories: [
                    { name: 'Plastik', ratio: 0.45, price: 'Rp 3.500/kg', lightColor: 'bg-emerald-50', textColor: 'text-emerald-600', hexColor: '#10b981', icon: 'ph-bold ph-recycle' },
                    { name: 'Kertas', ratio: 0.30, price: 'Rp 2.000/kg', lightColor: 'bg-blue-50', textColor: 'text-blue-600', hexColor: '#3b82f6', icon: 'ph-bold ph-file-text' },
                    { name: 'Organik', ratio: 0.25, price: 'Rp 1.500/kg', lightColor: 'bg-orange-50', textColor: 'text-orange-600', hexColor: '#f97316', icon: 'ph-bold ph-leaf' }
                ],
                navItems: [
                    { id: 'home', label: 'Dashboard', icon: 'ph-bold ph-squares-four' },
                    { id: 'tpa', label: 'Lokasi', icon: 'ph-bold ph-map-trifold' },
                    { id: 'bot', label: 'AI Chat', icon: 'ph-bold ph-robot' },
                    { id: 'market', label: 'Market', icon: 'ph-bold ph-storefront' },
                    { id: 'orders', label: 'Riwayat', icon: 'ph-bold ph-receipt' } 
                ],
                selectedTpaId: 1, tpaSearch: '',
                tpaData: [
                    { id: 1, nama: "Bank Sampah Induk", alamat: "Jl. Ngagel Tim., Pucang Sewu", lat: -7.289166, lng: 112.756549, status: "Buka", tipe: "Recycling Center", jarak: "2.1 km", zoom: 16 },
                    { id: 2, nama: "SORTIQ Hub Barat", alamat: "Surabaya Barat", lat: -7.275432, lng: 112.792331, status: "Segera", tipe: "Smart Hub", jarak: "3.5 km", zoom: 15 },
                    { id: 3, nama: "Unit Bintang Mangrove", alamat: "Gunung Anyar Tambak", lat: -7.339243, lng: 112.822231, status: "Buka", tipe: "Unit", jarak: "7.8 km", zoom: 16 }
                ],
                get selectedTpa() { return this.tpaData.find(t => t.id === this.selectedTpaId); },
                get filteredTpa() { return this.tpaData.filter(t => t.nama.toLowerCase().includes(this.tpaSearch.toLowerCase())); },
                marketItems: [
                    { id: 1, name: 'Gopay 10k', desc: 'E-Wallet', cost: '1000 XP', type: 'xp', category: 'redeem', priceValue: 1000, bgClass: 'bg-blue-50 text-blue-500', icon: 'ph-duotone ph-wallet' },
                    { id: 2, name: 'Bibit Pohon', desc: 'Go Green', cost: '500 XP', type: 'xp', category: 'redeem', priceValue: 500, bgClass: 'bg-green-50 text-green-600', icon: 'ph-duotone ph-plant' },
                    { id: 3, name: 'Kit Kompos', desc: 'Alat rumah', cost: 'Rp 150k', type: 'money', category: 'shop', priceValue: 150000, bgClass: 'bg-orange-50 text-orange-500', icon: 'ph-duotone ph-recycle' },
                    { id: 4, name: 'Totebag', desc: 'Kanvas', cost: 'Rp 25k', type: 'money', category: 'shop', priceValue: 25000, bgClass: 'bg-purple-50 text-purple-500', icon: 'ph-duotone ph-bag' }
                ],
                chatMessages: [], chatInput: '',
                init() {
                    if (window.fbBridge) window.fbBridge.init(this);
                    const storedBag = localStorage.getItem('sortiq_trashbag');
                    if (storedBag) this.trashBag = JSON.parse(storedBag);
                    else this.trashBag = { weight: 5.5, potentialXP: 550 };
                    this.chatMessages = [{ id: 1, text: `Halo! Ada yang bisa saya bantu?`, sender: 'bot', time: '10:00' }];
                    if(this.userHistory.length === 0) this.userHistory = [{id: 'demo1', weight: 2.5, xpReward: 250, status: 'Approved', date: new Date().toISOString()}];
                },
                notify(msg, type = 'info') {
                    this.notification.message = msg; this.notification.type = type; this.notification.show = true;
                    setTimeout(() => { this.notification.show = false }, 3000);
                },
                setPage(pageId) {
                    this.currentPage = pageId;
                    const titles = { 'home': 'Dashboard', 'bag': 'Detail Kantong', 'tpa': 'Lokasi Setor', 'bot': 'Asisten AI', 'market': 'Eco Market', 'orders': 'Riwayat Belanja', 'history': 'Riwayat' };
                    this.pageTitle = titles[pageId] || 'Dashboard';
                    document.getElementById('main-scroll').scrollTop = 0;
                },
                formatDate(isoString) {
                    if(!isoString) return '-'; const d = new Date(isoString); if (isNaN(d.getTime())) return '-';
                    return d.toLocaleString('id-ID', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' });
                },
                selectTpa(id) { this.selectedTpaId = id; },
                openGmaps() { window.open(`https://www.google.com/maps/dir/?api=1&destination=${this.selectedTpa.lat},${this.selectedTpa.lng}`, '_blank'); },
                async sendMessage() {
                    if (!this.chatInput.trim()) return;
                    const userText = this.chatInput;
                    this.chatMessages.push({ id: Date.now(), text: userText, sender: 'user', time: 'Sekarang' });
                    this.chatInput = ''; this.isTyping = true;
                    setTimeout(() => {
                        this.isTyping = false;
                        this.chatMessages.push({ id: Date.now()+1, text: "Maaf, saya hanya demo AI saat ini.", sender: 'bot', time: 'Sekarang' });
                    }, 1000);
                },
                startTransaction(item) { this.selectedItem = item; this.paymentStep = 1; this.showPaymentModal = true; },
                processPayment() { this.paymentStep = 2; setTimeout(() => { this.paymentStep = 3; }, 1500); },
                closePayment() { this.showPaymentModal = false; this.selectedItem = null; this.paymentStep = 1; },
                openDepositModal() { if (this.trashBag.weight <= 0) return this.notify("Kantong kosong!", "error"); this.depositStep = 1; this.depositData.address = ''; this.showDepositModal = true; },
                processDeposit() { 
                    if (!this.depositData.address.trim()) return this.notify("Isi alamat!", "error");
                    this.depositStep = 2; 
                    setTimeout(() => { 
                        this.depositStep = 4; this.trashBag = { weight: 0, potentialXP: 0 }; 
                        localStorage.setItem('sortiq_trashbag', JSON.stringify(this.trashBag));
                    }, 2000); 
                }
            }));
        });
    </script>
</body>
</html>
