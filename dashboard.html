<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SORTIQ - Dashboard</title>
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    
    <!-- Firebase Libraries (Compatible with Module Script) -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
        import { getFirestore, collection, doc, onSnapshot, addDoc, updateDoc, setDoc, serverTimestamp, query } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

        // --- 1. SETUP FIREBASE ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app';
        
        let db, auth, userUid;

        if (firebaseConfig) {
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } else {
            console.error("Firebase Config not found!");
        }

        // --- 2. LOGIC BRIDGE (Menghubungkan Firebase ke AlpineJS) ---
        window.fbBridge = {
            init: async (alpineScope) => {
                if (!auth) return;

                // A. Authentication Flow
                const initAuth = async () => {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                };
                await initAuth();

                // B. Listen to Auth State
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userUid = user.uid;
                        alpineScope.username = "User " + userUid.substring(0, 5); // Default name

                        // C. Listen to User Profile (XP & Data Diri)
                        const userDocRef = doc(db, 'artifacts', appId, 'users', userUid, 'profile', 'data');
                        
                        onSnapshot(userDocRef, (docSnap) => {
                            if (docSnap.exists()) {
                                const data = docSnap.data();
                                alpineScope.xp = data.xp || 0;
                                alpineScope.username = data.name || alpineScope.username;
                                alpineScope.email = data.email || '';
                            } else {
                                // Create default profile if not exists
                                setDoc(userDocRef, {
                                    xp: 0,
                                    name: "Pengguna Baru",
                                    email: "",
                                    joinedAt: serverTimestamp()
                                });
                            }
                        });

                        // D. Listen to Deposits (History Setor Sampah)
                        const depositsRef = collection(db, 'artifacts', appId, 'public', 'data', 'deposits');
                        onSnapshot(depositsRef, (snapshot) => {
                            const allDeposits = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            const myDeposits = allDeposits
                                .filter(d => d.uid === userUid)
                                .sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                            alpineScope.userHistory = myDeposits;
                        });

                        // E. Listen to Market Orders (Riwayat Belanja) - NEW FEATURE
                        const ordersRef = collection(db, 'artifacts', appId, 'public', 'data', 'market_orders');
                        onSnapshot(ordersRef, (snapshot) => {
                            const allOrders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            const myOrders = allOrders
                                .filter(d => d.uid === userUid)
                                .sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                            alpineScope.marketOrders = myOrders;
                        });

                    }
                });
            },

            // F. Function: Kirim Setoran (Create Deposit)
            submitDeposit: async (data) => {
                if (!userUid || !db) return false;
                try {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'deposits'), {
                        uid: userUid,
                        weight: parseFloat(data.weight),
                        xpReward: parseInt(data.xpReward),
                        address: data.address,
                        status: 'Pending', 
                        tpaName: data.tpaName,
                        timestamp: serverTimestamp(),
                        date: new Date().toISOString()
                    });
                    return true;
                } catch (e) {
                    console.error("Deposit failed:", e);
                    return false;
                }
            },

            // G. Function: Process Market Order (Potong XP & Simpan Transaksi)
            submitOrder: async (orderData, currentXP) => {
                if (!userUid || !db) return false;
                
                // 1. Potong XP jika metode bayar pakai XP
                if (orderData.type === 'xp') {
                     const newXP = currentXP - orderData.priceValue;
                     if (newXP < 0) return false; // XP Kurang
                     try {
                        const userDocRef = doc(db, 'artifacts', appId, 'users', userUid, 'profile', 'data');
                        await updateDoc(userDocRef, { xp: newXP });
                     } catch(e) { 
                         console.error("Failed deduct XP", e);
                         return false; 
                     }
                }

                // 2. Simpan Catatan Transaksi
                try {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'market_orders'), {
                        uid: userUid,
                        itemName: orderData.name,
                        itemType: orderData.type, // 'xp' or 'money'
                        costDisplay: orderData.cost, // e.g. "1000 XP" or "Rp 50.000"
                        priceValue: orderData.priceValue,
                        status: 'Diproses', // Status awal
                        shippingMethod: orderData.method,
                        timestamp: serverTimestamp(),
                        date: new Date().toISOString()
                    });
                    return true;
                } catch (e) {
                    console.error("Order failed:", e);
                    return false;
                }
            }
        };
    </script>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Config & Styles -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Plus Jakarta Sans', 'sans-serif'] },
                    animation: { 'float': 'float 6s ease-in-out infinite' },
                    keyframes: { float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-10px)' } } }
                }
            }
        }
    </script>
    <style>
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #CBD5E1; border-radius: 10px; }
        .glass { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(12px); border-bottom: 1px solid rgba(255, 255, 255, 0.6); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .tooltip { visibility: hidden; opacity: 0; position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); background-color: #1e293b; color: white; padding: 0.5rem; border-radius: 0.5rem; font-size: 0.75rem; white-space: nowrap; z-index: 50; transition: opacity 0.2s; margin-bottom: 0.5rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .has-tooltip:hover .tooltip { visibility: visible; opacity: 1; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans overflow-hidden" x-data="appData">

    <!-- Background Blobs -->
    <div class="fixed top-0 left-0 w-full h-full overflow-hidden -z-10 pointer-events-none">
        <div class="absolute top-[-10%] left-[-10%] w-96 h-96 bg-emerald-400/20 rounded-full blur-[100px] animate-float"></div>
        <div class="absolute bottom-[-10%] right-[-10%] w-96 h-96 bg-blue-400/20 rounded-full blur-[100px] animate-float" style="animation-delay: 2s;"></div>
    </div>

    <div class="flex h-screen w-full">
        <!-- === SIDEBAR === -->
        <aside class="hidden md:flex flex-col w-72 bg-white border-r border-slate-200 h-full z-30 shadow-sm">
            <div class="p-8 flex items-center gap-3">
                <!-- LOGO UPDATE -->
                <div class="w-10 h-10 bg-white rounded-xl shadow-md flex items-center justify-center overflow-hidden">
                    <img src="logo.png" onerror="this.src='https://ui-avatars.com/api/?name=S&background=10b981&color=fff'" alt="Logo" class="w-full h-full object-cover">
                </div>
                <div>
                    <h1 class="font-bold text-xl tracking-tight text-slate-900 leading-none">SORTIQ</h1>
                    <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest mt-1">Smart Recycle</p>
                </div>
            </div>

            <nav class="flex-1 px-4 space-y-1 overflow-y-auto no-scrollbar">
                <p class="px-4 text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2 mt-4">Navigasi Utama</p>
                <template x-for="item in navItems" :key="item.id">
                    <button @click="setPage(item.id)" 
                            :class="currentPage === item.id ? 'bg-emerald-50 text-emerald-600 border-emerald-100 shadow-sm' : 'text-slate-500 hover:bg-slate-50 border-transparent'"
                            class="w-full flex items-center gap-4 px-4 py-3.5 rounded-2xl font-semibold text-sm transition-all duration-200 border group relative">
                        <i :class="item.icon" class="text-xl transition-transform group-hover:scale-110"></i>
                        <span x-text="item.label"></span>
                        <div x-show="currentPage === item.id" class="absolute right-0 top-1/2 -translate-y-1/2 w-1 h-8 bg-emerald-500 rounded-l-full"></div>
                    </button>
                </template>

                <p class="px-4 text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2 mt-6">Fitur Pintar</p>
                <!-- BUTTON LINK UPDATE -->
                <button onclick="window.location.href='scan.html'" class="text-slate-500 hover:bg-emerald-50 hover:text-emerald-600 w-full flex items-center gap-4 px-4 py-3.5 rounded-2xl font-semibold text-sm transition-all duration-200 border border-transparent group">
                    <i class="ph-bold ph-scan text-xl transition-transform group-hover:scale-110"></i>
                    <span>AI Scanner</span>
                    <span class="ml-auto bg-emerald-100 text-emerald-600 text-[10px] px-2 py-0.5 rounded-full">New</span>
                </button>
            </nav>
            <button onclick="if(confirm('Apakah Anda yakin ingin keluar?')) window.location.href='index.html'" class="w-full flex items-center gap-3 text-red-500 font-bold text-sm hover:bg-red-50 p-4 rounded-2xl transition group">
                <i class="ph-bold ph-sign-out text-xl group-hover:-translate-x-1 transition"></i> Keluar Akun
            </button>
        </aside>

        <!-- === MAIN CONTENT === -->
        <main class="flex-1 flex flex-col h-full relative overflow-hidden">
            <!-- Header -->
            <header class="flex justify-between items-center px-4 py-3 md:px-10 md:py-6 z-20 glass sticky top-0">
                <div class="flex items-center gap-3 md:hidden">
                    <!-- LOGO MOBILE UPDATE -->
                    <div class="w-8 h-8 bg-white rounded-lg shadow-sm flex items-center justify-center overflow-hidden">
                        <img src="logo.png" onerror="this.src='https://ui-avatars.com/api/?name=S&background=10b981&color=fff'" alt="Logo" class="w-full h-full object-cover">
                    </div>
                    <span class="font-bold text-lg tracking-tight">SORTIQ</span>
                </div>
                <div class="hidden md:block">
                    <h2 class="text-2xl font-bold text-slate-800 tracking-tight" x-text="pageTitle"></h2>
                    <p class="text-slate-500 text-sm">Mari buat dunia lebih bersih bersama SORTIQ.</p>
                </div>
                <div class="flex items-center gap-3">
                    <div class="bg-white pl-2 pr-3 py-1 rounded-full border border-slate-200 shadow-sm flex items-center gap-2">
                        <div class="w-7 h-7 bg-yellow-100 rounded-full flex items-center justify-center text-yellow-600"><i class="ph-fill ph-coin text-sm"></i></div>
                        <span class="font-bold text-sm text-slate-700" x-text="xp + ' XP'"></span>
                    </div>
                    <img :src="`https://ui-avatars.com/api/?name=${username}&background=10b981&color=fff`" class="w-9 h-9 md:w-10 md:h-10 rounded-full border-2 border-white shadow-sm hidden sm:block">
                </div>
            </header>

            <!-- Scrollable Content -->
            <div class="flex-1 overflow-y-auto p-4 md:p-10 pb-32 md:pb-10 scroll-smooth no-scrollbar" id="main-scroll">
                
                <!-- 1. HOME VIEW -->
                <div x-show="currentPage === 'home'" x-transition.opacity.duration.300ms class="space-y-6 md:space-y-8 max-w-6xl mx-auto">
                    <!-- Banner -->
                    <div class="grid md:grid-cols-3 gap-6">
                        <div class="md:col-span-2 bg-slate-900 rounded-[2rem] md:rounded-[2.5rem] p-6 md:p-10 text-white relative overflow-hidden shadow-2xl group flex flex-col justify-center">
                            <div class="absolute top-0 right-0 w-64 h-64 bg-emerald-500 rounded-full blur-[100px] opacity-20 group-hover:opacity-30 transition duration-700"></div>
                            <div class="relative z-10">
                                <div class="inline-flex items-center gap-2 px-3 py-1 bg-white/10 backdrop-blur-md rounded-full text-[10px] font-bold mb-4 text-emerald-300 border border-white/10 uppercase tracking-widest">‚ú® Mulai Aksimu</div>
                                <h2 class="text-2xl md:text-3xl font-extrabold mb-3 leading-tight">Sudah Scan Sampah?</h2>
                                <p class="text-slate-300 mb-6 text-sm">Kumpulkan sampah di rumah, scan dengan AI, lalu setor ke lokasi terdekat untuk dapat poin.</p>
                                <!-- BUTTON LINK UPDATE -->
                                <button onclick="window.location.href='scan.html'" class="w-max bg-emerald-500 hover:bg-emerald-400 text-white px-6 py-3 rounded-2xl font-bold shadow-lg shadow-emerald-500/30 transition active:scale-95 flex items-center gap-2 text-sm md:text-base">
                                    <i class="ph-bold ph-camera text-lg"></i> Scan Sekarang
                                </button>
                            </div>
                        </div>

                        <!-- KANTONG SAMPAH DIGITAL -->
                        <div class="bg-white p-6 rounded-[2rem] md:rounded-[2.5rem] border border-slate-200 shadow-sm flex flex-col justify-between relative overflow-hidden">
                            <div class="absolute -right-6 -top-6 w-24 h-24 bg-blue-50 rounded-full"></div>
                            <div class="relative z-10">
                                <h3 class="font-bold text-slate-800 text-lg flex items-center gap-2">
                                    <i class="ph-duotone ph-bag text-blue-500 text-2xl"></i> Kantong Saya
                                </h3>
                                <p class="text-xs text-slate-400 mt-1">Sampah yang belum disetor.</p>
                                <div class="mt-6 space-y-4">
                                    <div class="flex justify-between items-end">
                                        <span class="text-slate-500 text-sm font-medium">Berat</span>
                                        <span class="text-2xl font-black text-slate-800"><span x-text="trashBag.weight"></span> <span class="text-sm font-bold text-slate-400">Kg</span></span>
                                    </div>
                                    <div class="flex justify-between items-end">
                                        <span class="text-slate-500 text-sm font-medium">Potensi Poin</span>
                                        <span class="text-2xl font-black text-emerald-600">+<span x-text="trashBag.potentialXP"></span> <span class="text-sm font-bold text-emerald-400">XP</span></span>
                                    </div>
                                </div>
                            </div>
                            <button @click="setPage('tpa')" class="mt-6 w-full bg-slate-100 hover:bg-emerald-50 text-slate-600 hover:text-emerald-700 py-3 rounded-xl font-bold text-sm transition flex items-center justify-center gap-2 border border-transparent hover:border-emerald-200">
                                <i class="ph-bold ph-map-pin"></i> Cari Lokasi Setor
                            </button>
                        </div>
                    </div>

                    <!-- FITUR UTAMA -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        
                        <!-- Card 1: Kantong Sampah -->
                        <div class="bg-white p-5 rounded-[2rem] border border-slate-200 shadow-sm hover:shadow-lg transition duration-300 flex flex-col justify-between h-full relative group">
                            <div>
                                <div class="flex justify-between items-start mb-2">
                                    <div class="w-10 h-10 bg-emerald-50 text-emerald-600 rounded-xl flex items-center justify-center text-xl shadow-sm">
                                        <i class="ph-fill ph-trash"></i>
                                    </div>
                                    <div class="has-tooltip relative cursor-help">
                                        <i class="ph-fill ph-info text-slate-300 hover:text-emerald-500"></i>
                                        <span class="tooltip w-40 whitespace-normal text-center right-0 transform-none left-auto">Total berat sampah hasil scan yang belum disetor ke bank sampah.</span>
                                    </div>
                                </div>
                                <h4 class="text-slate-400 text-[10px] font-bold uppercase tracking-wider mb-1">Total Sampah di Kantong</h4>
                                <p class="text-2xl font-black text-slate-800 mb-2"><span x-text="trashBag.weight > 0 ? trashBag.weight : '0'"></span> kg</p>
                                
                                <div class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-lg text-[10px] font-bold border"
                                     :class="trashBag.weight > 0 ? 'bg-emerald-50 text-emerald-700 border-emerald-100' : 'bg-yellow-50 text-yellow-700 border-yellow-100'">
                                    <span class="w-1.5 h-1.5 rounded-full" :class="trashBag.weight > 0 ? 'bg-emerald-500 animate-pulse' : 'bg-yellow-500'"></span>
                                    <span x-text="trashBag.weight > 0 ? 'Siap disetor' : 'Menunggu jumlah minimum'"></span>
                                </div>
                            </div>

                                <button @click="setPage('bag')" class="mt-4 w-full py-2.5 bg-slate-50 hover:bg-slate-100 text-slate-600 text-xs font-bold rounded-xl transition flex items-center justify-center gap-2 group-hover:bg-slate-900 group-hover:text-white">
                                    Lihat Detail Kantong <i class="ph-bold ph-arrow-right"></i>
                                </button>
                        </div>

                        

                        <!-- Card 2: Bank Sampah Terdekat -->
                        <div class="bg-white p-5 rounded-[2rem] border border-slate-200 shadow-sm hover:shadow-lg transition duration-300 flex flex-col justify-between h-full relative group">
                            <div>
                                <div class="flex justify-between items-start mb-2">
                                    <div class="w-10 h-10 bg-blue-50 text-blue-600 rounded-xl flex items-center justify-center text-xl shadow-sm">
                                        <i class="ph-fill ph-map-pin"></i>
                                    </div>
                                    <div class="has-tooltip relative cursor-help">
                                        <i class="ph-fill ph-info text-slate-300 hover:text-emerald-500"></i>
                                        <span class="tooltip w-40 whitespace-normal text-center right-0 transform-none left-auto">Informasi operasional dan lokasi penyetoran sampah terdekat.</span>
                                    </div>
                                </div>
                                <h4 class="text-slate-400 text-[10px] font-bold uppercase tracking-wider mb-1">Bank Sampah Terdekat</h4>
                                <div class="mb-2">
                                    <p class="text-lg font-black text-slate-800 leading-tight">üìç Unit RW 05</p>
                                    <p class="text-xs text-slate-500 font-medium">(Jarak ¬± 350 m)</p>
                                </div>
                            </div>
                            <button @click="openGmaps()" class="mt-4 w-full py-2.5 bg-slate-50 hover:bg-slate-100 text-slate-600 text-xs font-bold rounded-xl transition flex items-center justify-center gap-2 group-hover:bg-blue-600 group-hover:text-white">
                                Rute Navigasi <i class="ph-bold ph-navigation-arrow"></i>
                            </button>
                        </div>

                        <!-- Card 3: Harga Pasar Sampah -->
                        <div class="bg-white p-5 rounded-[2rem] border border-slate-200 shadow-sm hover:shadow-lg transition duration-300 flex flex-col justify-between h-full relative group">
                            <div>
                                <div class="flex justify-between items-start mb-2">
                                    <div class="w-10 h-10 bg-purple-50 text-purple-600 rounded-xl flex items-center justify-center text-xl shadow-sm">
                                        <i class="ph-fill ph-chart-line-up"></i>
                                    </div>
                                    <div class="has-tooltip relative cursor-help">
                                        <i class="ph-fill ph-info text-slate-300 hover:text-emerald-500"></i>
                                        <span class="tooltip w-40 whitespace-normal text-center right-0 transform-none left-auto">Kumpulkan sampah dengan nilai tertinggi untuk poin maksimal.</span>
                                    </div>
                                </div>
                                <h4 class="text-slate-400 text-[10px] font-bold uppercase tracking-wider mb-1">Harga Pasar Sampah</h4>
                                <div class="mb-2">
                                    <p class="text-lg font-black text-slate-800">Plastik PET</p>
                                    <p class="text-xs font-bold text-emerald-600 flex items-center gap-1">
                                        ‚ñ≤ +50 XP/kg
                                    </p>
                                </div>
                            </div>
                            <button @click="setPage('market')" class="mt-4 w-full py-2.5 bg-slate-50 hover:bg-slate-100 text-slate-600 text-xs font-bold rounded-xl transition flex items-center justify-center gap-2 group-hover:bg-purple-600 group-hover:text-white">
                                Lihat Daftar Harga <i class="ph-bold ph-list"></i>
                            </button>
                        </div>

                        <!-- Card 4: Streak Aktivitas -->
                        <div class="bg-white p-5 rounded-[2rem] border border-slate-200 shadow-sm hover:shadow-lg transition duration-300 flex flex-col justify-between h-full relative group">
                            <div>
                                <div class="flex justify-between items-start mb-2">
                                    <div class="w-10 h-10 bg-orange-50 text-orange-600 rounded-xl flex items-center justify-center text-xl shadow-sm">
                                        <i class="ph-fill ph-fire"></i>
                                    </div>
                                    <div class="has-tooltip relative cursor-help">
                                        <i class="ph-fill ph-info text-slate-300 hover:text-emerald-500"></i>
                                        <span class="tooltip w-40 whitespace-normal text-center right-0 transform-none left-auto">Scan atau setor sampah hari ini untuk mempertahankan streak.</span>
                                    </div>
                                </div>
                                <h4 class="text-slate-400 text-[10px] font-bold uppercase tracking-wider mb-1">Streak Aktivitas</h4>
                                <div class="mb-2">
                                    <p class="text-lg font-black text-slate-800">3 Hari</p>
                                    <p class="text-xs text-slate-500 font-medium">Berturut-turut</p>
                                </div>
                                <div class="bg-orange-50 px-2 py-1 rounded-lg inline-block">
                                    <p class="text-[10px] font-bold text-orange-700">üèÜ 3 hari ‚Üí <span class="font-black">+10 XP</span></p>
                                </div>
                            </div>
                            <!-- BUTTON LINK UPDATE -->
                            <button onclick="window.location.href='scan.html'" class="mt-4 w-full py-2.5 bg-slate-50 hover:bg-slate-100 text-slate-600 text-xs font-bold rounded-xl transition flex items-center justify-center gap-2 group-hover:bg-orange-500 group-hover:text-white">
                                Scan Sekarang <i class="ph-bold ph-camera"></i>
                            </button>
                        </div>

                    </div>

                    <!-- RIWAYAT SETORAN (Realtime Data) -->
                    <div class="bg-white p-6 rounded-[2rem] border border-slate-200 shadow-sm">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-lg text-slate-800 flex items-center gap-2">
                                <i class="ph-fill ph-clock-counter-clockwise text-emerald-500"></i> Setoran Terakhir
                            </h3>
                            <!-- Indikator max 2 item -->
                            <span x-show="userHistory.length > 0" class="text-[10px] font-bold bg-slate-100 text-slate-500 px-2 py-1 rounded-full uppercase tracking-wider">Terbaru</span>
                        </div>
                        
                        <div class="space-y-3">
                            <!-- Loop dengan slice(0, 2) untuk max 2 item -->
                            <template x-for="item in userHistory.slice(0, 2)" :key="item.id">
                                <div class="flex items-center justify-between p-4 bg-slate-50 rounded-2xl border border-slate-100 hover:bg-white hover:shadow-md transition duration-200">
                                    <div class="flex items-center gap-4">
                                        <div class="w-10 h-10 rounded-full flex items-center justify-center text-xl shrink-0" 
                                             :class="item.status === 'Approved' ? 'bg-emerald-100 text-emerald-600' : 'bg-yellow-100 text-yellow-600'">
                                            <i :class="item.status === 'Approved' ? 'ph-bold ph-check' : 'ph-bold ph-hourglass'"></i>
                                        </div>
                                        <div>
                                            <div class="flex items-center gap-2 mb-0.5">
                                                <p class="font-bold text-slate-800 text-sm" x-text="item.weight + ' Kg Sampah'"></p>
                                                <span class="text-[9px] font-bold px-1.5 py-0.5 rounded-md" 
                                                      :class="item.status === 'Approved' ? 'bg-emerald-50 text-emerald-700' : 'bg-yellow-50 text-yellow-700'"
                                                      x-text="item.status === 'Approved' ? 'Sukses' : 'Proses'">
                                                </span>
                                            </div>
                                            <p class="text-[10px] text-slate-500 flex items-center gap-1">
                                                <i class="ph-bold ph-calendar-blank"></i> <span x-text="formatDate(item.date)"></span>
                                            </p>
                                        </div>
                                    </div>
                                    <div class="text-right shrink-0">
                                        <p class="font-black text-emerald-600 text-sm" x-text="'+' + item.xpReward"></p>
                                        <p class="text-[10px] font-bold text-emerald-400">XP</p>
                                    </div>
                                </div>
                            </template>
                            
                            <!-- Empty State -->
                            <div x-show="userHistory.length === 0" class="text-center py-8 text-slate-400 text-xs italic">
                                Belum ada riwayat setoran. Ayo mulai setor sampah!
                            </div>

                            <!-- CTA Button (Tampil jika ada history) -->
                            <button x-show="userHistory.length > 0" @click="setPage('history')" class="w-full mt-2 py-3.5 bg-slate-50 hover:bg-emerald-50 text-slate-600 hover:text-emerald-700 rounded-xl font-bold text-sm transition flex items-center justify-center gap-2 group border border-transparent hover:border-emerald-200">
                            <span>Lihat Semua Riwayat</span>
                            <i class="ph-bold ph-arrow-right group-hover:translate-x-1 transition-transform"></i>
                        </button>
                    </div>
                </div> 
            </div> 
            <div x-show="currentPage === 'bag'" x-transition.opacity.duration.300ms class="space-y-6 max-w-6xl mx-auto">
               <div class="bg-white rounded-[2.5rem] p-8 md:p-10 shadow-sm border border-slate-100 relative overflow-hidden flex flex-col md:flex-row justify-between items-end gap-6">
    
    <div class="relative z-10 w-full md:w-auto">
        <button @click="setPage('home')" class="group flex items-center gap-2 text-slate-400 hover:text-slate-800 text-sm font-bold mb-6 transition-colors">
            <i class="ph-bold ph-arrow-left group-hover:-translate-x-1 transition-transform"></i> 
            Kembali
        </button>
        
        <div class="space-y-1">
            <p class="text-slate-400 font-bold uppercase tracking-widest text-[10px]">Total Akumulasi</p>
            <div class="flex items-baseline gap-1">
                <h1 class="text-7xl md:text-8xl font-black text-slate-800 tracking-tighter" x-text="trashBag.weight"></h1>
                <span class="text-3xl font-bold text-slate-300">kg</span>
            </div>
        </div>
    </div>

    <div class="relative z-10 w-full md:w-auto flex flex-col items-end gap-4">
        
        <div class="bg-emerald-50 text-emerald-600 border border-emerald-100 px-3 py-1.5 rounded-full flex items-center gap-2 shadow-sm">
            <span class="relative flex h-2 w-2">
              <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>
              <span class="relative inline-flex rounded-full h-2 w-2 bg-emerald-500"></span>
            </span>
            <span class="text-[10px] font-bold uppercase tracking-wider">Live Update</span>
        </div>

        <div class="bg-gradient-to-br from-emerald-500 to-emerald-600 text-white p-6 md:p-8 rounded-[2rem] shadow-xl shadow-emerald-200/50 w-full md:w-64 relative overflow-hidden group">
            <div class="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full blur-2xl -mr-10 -mt-10 transition-transform group-hover:scale-110"></div>
            
            <div class="relative z-10">
                <p class="text-emerald-100 text-[10px] font-bold uppercase tracking-widest mb-1">Estimasi Reward</p>
                <div class="flex items-baseline gap-1 mb-3">
                    <span class="text-lg font-medium text-emerald-200">+</span>
                    <h2 class="text-5xl font-black tracking-tight" x-text="trashBag.potentialXP"></h2>
                    <span class="text-sm font-bold text-emerald-100">XP</span>
                </div>
                <div class="inline-block bg-white/20 backdrop-blur-sm border border-white/10 px-3 py-1 rounded-lg">
                    <p class="text-[10px] font-bold text-white flex items-center gap-1">
                        <i class="ph-bold ph-trend-up"></i> +5.2% value minggu ini
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 space-y-6">
                        <div class="flex items-center justify-between px-2">
                            <h2 class="text-xl font-bold text-slate-800">Breakdown Kategori</h2>
                            <button class="text-blue-600 text-sm font-bold flex items-center hover:bg-blue-50 px-3 py-1 rounded-lg transition">
                                <i class="ph-bold ph-file-xls mr-2"></i> Ekspor Data
                            </button>
                        </div>

                        <div class="space-y-4">
                            <template x-for="cat in trashCategories" :key="cat.name">
                                <div class="bg-white p-5 rounded-[2rem] border border-slate-200 shadow-sm hover:shadow-md transition duration-300 relative group overflow-hidden">
                                    <div class="flex items-start justify-between mb-4 relative z-10">
                                        <div class="flex items-center gap-4">
                                            <div :class="cat.lightColor + ' ' + cat.textColor" class="w-14 h-14 rounded-2xl flex items-center justify-center text-2xl">
                                                <i :class="cat.icon"></i>
                                            </div>
                                            <div>
                                                <h3 class="font-bold text-lg text-slate-800" x-text="cat.name"></h3>
                                                <p class="text-xs text-slate-400 font-medium">Pasar: <span x-text="cat.price"></span></p>
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <p :class="cat.textColor" class="text-lg font-black" x-text="(trashBag.weight * cat.ratio).toFixed(1) + ' kg'"></p>
                                            <p class="text-[10px] font-bold text-slate-400 uppercase">Estimasi Berat</p>
                                        </div>
                                    </div>
                                    <div class="space-y-2 relative z-10">
                                        <div class="flex justify-between items-center text-[10px] font-bold uppercase tracking-widest text-slate-400">
                                            <span>Kapasitas Kantong</span>
                                            <span x-text="Math.round((trashBag.weight * cat.ratio / 10) * 100) + '%'"></span>
                                        </div>
                                        <div class="w-full bg-slate-100 h-3 rounded-full overflow-hidden">
                                            <div class="h-full rounded-full transition-all duration-1000 ease-out" 
                                                    :style="`width: ${(trashBag.weight * cat.ratio / 10) * 100}%; background-color: ${cat.hexColor}`"></div>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>

                    <div class="space-y-6">
                        <h2 class="text-xl font-bold text-slate-800">Market Watch</h2>
                        <div class="bg-white p-6 rounded-[2rem] border border-slate-200 shadow-sm">
                            <div class="flex items-center justify-between mb-4">
                                <span class="text-sm font-bold text-slate-600">Tren Harga Plastik</span>
                                <span class="text-xs font-black text-emerald-600 bg-emerald-50 px-2 py-1 rounded-lg">+5%</span>
                            </div>
                            <div class="h-32 w-full">
                                <canvas id="marketChartDetail"></canvas>
                            </div>
                            <div class="bg-blue-50 p-4 rounded-2xl border border-blue-100 mt-4 flex gap-3">
                                <i class="ph-fill ph-info text-blue-500 text-xl shrink-0"></i>
                                <p class="text-xs text-blue-700 font-medium leading-relaxed">
                                    <strong>Info:</strong> Harga Plastik PET sedang naik. Waktu yang tepat untuk setor!
                                </p>
                            </div>
                        </div>

                        <div class="bg-white p-5 rounded-[2rem] border border-slate-200 shadow-sm flex items-center gap-4">
                            <div class="w-12 h-12 bg-yellow-100 rounded-full flex items-center justify-center text-yellow-600 text-2xl"><i class="ph-fill ph-medal"></i></div>
                            <div>
                                <p class="text-xs text-slate-400 font-bold uppercase tracking-wider">Eco Level</p>
                                <p class="text-sm font-black text-slate-800">Pejuang Lingkungan</p>
                            </div>
                        </div>
                            <button @click="setPage('tpa')" class="w-full bg-slate-800 hover:bg-emerald-600 text-white font-bold py-4 px-8 rounded-2xl transition-all flex items-center justify-center gap-3 shadow-lg active:scale-95">
                            <i class="ph-bold ph-map-pin"></i> Cari Dropbox Terdekat
                        </button>
                    </div>
                </div>
            </div>

            <div x-show="currentPage === 'tpa'" x-transition.opacity.duration.300ms class="h-full flex flex-col md:flex-row gap-6 max-w-7xl mx-auto">

                <!-- 2. LOKASI SETOR VIEW -->
                <div x-show="currentPage === 'tpa'" x-transition.opacity.duration.300ms class="h-full flex flex-col md:flex-row gap-6 max-w-7xl mx-auto">
                    <div class="w-full md:w-80 flex flex-col gap-4">
                        <div class="bg-white p-4 rounded-3xl border border-slate-200 shadow-sm">
                            <div class="relative">
                                <i class="ph-bold ph-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
                                <input type="text" x-model="tpaSearch" placeholder="Cari Bank Sampah..." class="w-full pl-10 pr-4 py-3 bg-slate-50 rounded-2xl text-sm outline-none focus:ring-2 focus:ring-emerald-500/20 border border-transparent focus:border-emerald-500 transition-all">
                            </div>
                        </div>
                        
                        <div class="bg-emerald-600 p-5 rounded-[2rem] text-white shadow-lg relative overflow-hidden" x-show="trashBag.weight > 0">
                            <div class="relative z-10">
                                <p class="text-xs font-bold text-emerald-200 uppercase tracking-widest mb-1">Siap Disetor</p>
                                <div class="flex justify-between items-end">
                                    <h3 class="text-2xl font-black" x-text="trashBag.weight + ' Kg'"></h3>
                                    <span class="bg-white/20 px-2 py-1 rounded-lg text-xs font-bold backdrop-blur-sm">+<span x-text="trashBag.potentialXP"></span> XP</span>
                                </div>
                                <p class="text-[10px] text-emerald-100 mt-2 italic">Pilih lokasi di bawah untuk menyetor.</p>
                            </div>
                        </div>

                        <div class="flex-1 overflow-y-auto space-y-3 no-scrollbar pb-10 max-h-60 md:max-h-full">
                            <template x-for="tpa in filteredTpa" :key="tpa.id">
                                <button @click="selectTpa(tpa.id)" 
                                        :class="selectedTpaId === tpa.id ? 'border-emerald-500 bg-white ring-4 ring-emerald-500/10 shadow-lg' : 'border-white bg-white/50 hover:bg-white'"
                                        class="w-full text-left p-5 rounded-[2rem] border-2 transition-all duration-300 group">
                                    <div class="flex justify-between items-start mb-2">
                                        <span :class="selectedTpaId === tpa.id ? 'text-emerald-700' : 'text-slate-800'" class="font-bold text-base leading-tight" x-text="tpa.nama"></span>
                                        <div :class="tpa.tipe.includes('Recycling') ? 'bg-emerald-500' : 'bg-slate-400'" class="w-2 h-2 rounded-full transition-all"></div>
                                    </div>
                                    <p class="text-[10px] text-slate-400 font-medium mb-4 line-clamp-1" x-text="tpa.alamat"></p>
                                    <div class="flex items-center justify-between">
                                        <div class="flex gap-2">
                                            <span class="text-[9px] bg-slate-100 text-slate-600 px-2 py-1 rounded-lg font-bold uppercase" x-text="tpa.jarak"></span>
                                            <span :class="tpa.tipe.includes('Recycling') ? 'bg-emerald-100 text-emerald-700' : 'bg-slate-100 text-slate-600'" class="text-[9px] px-2 py-1 rounded-lg font-bold uppercase" x-text="tpa.tipe"></span>
                                        </div>
                                        <i class="ph-bold ph-arrow-right text-emerald-500 opacity-0 group-hover:opacity-100 transition-all"></i>
                                    </div>
                                </button>
                            </template>
                        </div>
                    </div>

                    <div class="flex-1 flex flex-col bg-white rounded-[2rem] md:rounded-[3rem] border border-slate-200 shadow-xl overflow-hidden min-h-[400px] md:min-h-[500px]">
                        <div class="flex-1 relative">
                            <div class="absolute top-6 left-6 z-10 bg-white/90 backdrop-blur-md px-4 py-2 rounded-full shadow-lg border border-white flex items-center gap-2">
                                <span class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></span>
                                <span class="text-[10px] font-black uppercase tracking-widest text-slate-700">Satelit Live</span>
                            </div>
                            <iframe :src="`https://maps.google.com/maps?q=${selectedTpa.lat},${selectedTpa.lng}&t=k&z=${selectedTpa.zoom}&ie=UTF8&iwloc=&output=embed`" width="100%" height="100%" frameborder="0" class="filter contrast-[1.1] brightness-[0.95]"></iframe>
                        </div>
                        <div class="p-6 md:p-8 bg-white border-t border-slate-100">
                            <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-6">
                                <div class="flex-1">
                                    <div class="flex items-center gap-3 mb-2">
                                        <h3 class="text-xl md:text-2xl font-black text-slate-800 tracking-tighter" x-text="selectedTpa.nama"></h3>
                                        <span :class="selectedTpa.status.includes('Setor') ? 'bg-emerald-100 text-emerald-600' : 'bg-slate-100 text-slate-600'" class="px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-widest" x-text="selectedTpa.status"></span>
                                    </div>
                                    <p class="text-slate-500 text-sm font-medium flex items-center gap-2"><i class="ph-bold ph-map-pin text-emerald-500"></i> <span x-text="selectedTpa.alamat"></span></p>
                                </div>
                                <div class="flex gap-3 w-full lg:w-auto">
                                    <button @click="openDepositModal()" class="flex-1 lg:flex-none bg-emerald-600 hover:bg-emerald-700 text-white px-6 py-4 rounded-2xl font-bold flex items-center justify-center gap-2 shadow-xl shadow-emerald-200 transition active:scale-95 text-sm md:text-base" x-show="selectedTpa.tipe.includes('Recycling') || selectedTpa.tipe.includes('Hub')">
                                        <i class="ph-bold ph-recycle text-xl"></i> SETOR DI SINI
                                    </button>
                                    <button @click="openGmaps()" class="bg-slate-100 hover:bg-slate-200 text-slate-600 px-4 py-4 rounded-2xl font-bold flex items-center justify-center transition active:scale-95">
                                        <i class="ph-bold ph-navigation-arrow text-xl"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 3. CHAT BOT VIEW -->
                <div x-show="currentPage === 'bot'" x-transition.opacity.duration.300ms class="h-[calc(100vh-160px)] md:h-[calc(100vh-180px)] flex flex-col bg-white rounded-[2rem] md:rounded-[2.5rem] border border-slate-200 shadow-lg overflow-hidden max-w-4xl mx-auto">
                    <div class="p-6 bg-white border-b border-slate-100 flex items-center gap-4">
                        <div class="w-12 h-12 bg-emerald-600 rounded-2xl flex items-center justify-center text-white shadow-lg"><i class="ph-bold ph-robot text-2xl"></i></div>
                        <div><h3 class="font-bold text-slate-800 text-lg">SORTIQ Assistant</h3><p class="text-[10px] text-green-500 font-bold flex items-center gap-1"><span class="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></span> AKTIF SEKARANG</p></div>
                    </div>
                    <div class="flex-1 bg-slate-50/50 p-6 overflow-y-auto space-y-6 no-scrollbar" id="chat-container">
                        <template x-for="msg in chatMessages" :key="msg.id">
                            <div :class="msg.sender === 'bot' ? 'flex justify-start' : 'flex justify-end'">
                                <div :class="msg.sender === 'bot' ? 'bg-white border border-slate-100 text-slate-700 rounded-tl-none' : 'bg-slate-900 text-white rounded-tr-none'" class="p-4 rounded-3xl shadow-sm max-w-[85%] text-sm leading-relaxed">
                                    <p x-html="msg.text"></p>
                                    <p class="text-[9px] mt-2 opacity-50 font-bold uppercase text-right" x-text="msg.time"></p>
                                </div>
                            </div>
                        </template>
                        <div x-show="isTyping" class="flex justify-start"><div class="bg-white border border-slate-100 p-4 rounded-3xl rounded-tl-none animate-pulse text-[10px] text-slate-400 font-bold tracking-widest">MENGETIK...</div></div>
                    </div>
                    <div class="p-6 bg-white border-t border-slate-100">
                        <form @submit.prevent="sendMessage" class="flex gap-3">
                            <input type="text" x-model="chatInput" placeholder="Tanya sesuatu..." class="flex-1 bg-slate-100 rounded-2xl px-5 py-4 text-sm outline-none focus:ring-2 focus:ring-emerald-500 transition">
                            <button type="submit" :disabled="!chatInput" class="bg-slate-900 text-white w-14 h-14 rounded-2xl flex items-center justify-center shadow-xl hover:bg-emerald-600 transition disabled:opacity-50"><i class="ph-bold ph-paper-plane-right text-xl"></i></button>
                        </form>
                    </div>
                </div>

                <!-- 4. ECO MARKET VIEW -->
                <div x-show="currentPage === 'market'" x-transition.opacity.duration.300ms class="max-w-6xl mx-auto">
                    <div class="flex justify-center mb-8">
                        <div class="bg-slate-100 p-1 rounded-2xl flex w-full md:w-auto">
                            <button @click="marketTab = 'redeem'" :class="marketTab === 'redeem' ? 'bg-white text-emerald-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'" class="flex-1 md:flex-none justify-center px-6 py-2.5 rounded-xl font-bold text-sm transition-all flex items-center gap-2"><i class="ph-bold ph-gift"></i> Tukar Poin</button>
                            <button @click="marketTab = 'shop'" :class="marketTab === 'shop' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'" class="flex-1 md:flex-none justify-center px-6 py-2.5 rounded-xl font-bold text-sm transition-all flex items-center gap-2"><i class="ph-bold ph-shopping-bag"></i> Toko Hijau</button>
                        </div>
                    </div>

                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <h2 class="text-2xl font-bold text-slate-800 tracking-tight" x-text="marketTab === 'redeem' ? 'Rewards Kamu' : 'Belanja Produk'"></h2>
                            <p class="text-sm text-slate-500 font-medium" x-text="marketTab === 'redeem' ? 'Gunakan poin XP untuk klaim hadiah.' : 'Produk ramah lingkungan terbaik.'"></p>
                        </div>
                        <div class="text-right" x-show="marketTab === 'redeem'">
                            <p class="text-[10px] font-bold text-slate-400 uppercase">Saldo Kamu</p>
                            <p class="text-xl font-black text-emerald-600" x-text="xp + ' XP'"></p>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <template x-for="item in marketItems" :key="item.id">
                            <div x-show="marketTab === item.category" class="bg-white p-5 rounded-[2rem] border border-slate-200 shadow-sm flex flex-col h-full hover:shadow-2xl hover:-translate-y-1 transition duration-300">
                                <div :class="item.bgClass" class="h-40 rounded-[1.5rem] mb-4 flex items-center justify-center text-5xl shadow-inner relative overflow-hidden">
                                    <i :class="item.icon"></i>
                                    <div x-show="item.type === 'money'" class="absolute top-3 right-3 bg-white/50 backdrop-blur-sm px-2 py-1 rounded-lg text-[10px] font-bold uppercase tracking-widest text-slate-600 border border-white/20">Beli</div>
                                </div>
                                <div class="flex-1 px-2">
                                    <h4 class="font-bold text-lg text-slate-800 leading-tight" x-text="item.name"></h4>
                                    <p class="text-xs text-slate-500 mt-1 mb-4 leading-relaxed" x-text="item.desc"></p>
                                </div>
                                <div class="flex justify-between items-center pt-4 border-t border-slate-50 px-1">
                                    <span class="font-black text-slate-800 text-sm" x-text="item.cost"></span>
                                    <button @click="startTransaction(item)" class="bg-slate-900 text-white px-5 py-2 rounded-xl text-xs font-bold hover:bg-emerald-600 transition active:scale-95 shadow-lg shadow-slate-200">
                                        <span x-text="item.type === 'xp' ? 'Klaim' : 'Beli'"></span>
                                    </button>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- 5. MARKET ORDERS VIEW (NEW) -->
                <div x-show="currentPage === 'orders'" x-transition.opacity.duration.300ms class="max-w-2xl mx-auto">
                    <div class="text-center mb-10">
                        <div class="w-20 h-20 bg-blue-100 rounded-3xl mx-auto flex items-center justify-center text-blue-600 text-4xl mb-4 shadow-sm"><i class="ph-duotone ph-receipt"></i></div>
                        <h2 class="text-3xl font-black text-slate-900 tracking-tight">Riwayat Belanja</h2>
                        <p class="text-slate-500 mt-2 font-medium">Pantau status penukaran poin dan pembelianmu.</p>
                    </div>

                    <div class="bg-white rounded-[2rem] border border-slate-200 shadow-sm overflow-hidden">
                        <div class="p-1">
                            <template x-for="order in marketOrders" :key="order.id">
                                <div class="p-5 border-b border-slate-50 last:border-0 hover:bg-slate-50 transition flex items-center justify-between group">
                                    <div class="flex items-center gap-4">
                                        <div class="w-12 h-12 rounded-2xl flex items-center justify-center text-xl shadow-sm transition-transform group-hover:scale-105" 
                                             :class="order.itemType === 'xp' ? 'bg-purple-100 text-purple-600' : 'bg-blue-100 text-blue-600'">
                                            <i :class="order.itemType === 'xp' ? 'ph-bold ph-gift' : 'ph-bold ph-shopping-bag'"></i>
                                        </div>
                                        <div>
                                            <div class="flex items-center gap-2 mb-1">
                                                <h4 class="font-bold text-slate-800" x-text="order.itemName"></h4>
                                                <span class="text-[10px] font-bold px-2 py-0.5 rounded-md uppercase tracking-wider" 
                                                      :class="order.status === 'Selesai' ? 'bg-emerald-100 text-emerald-700' : 'bg-slate-100 text-slate-600'"
                                                      x-text="order.status">
                                                </span>
                                            </div>
                                            <p class="text-xs text-slate-500 font-medium flex items-center gap-1.5">
                                                <span x-text="order.shippingMethod === 'pickup' ? 'Ambil Sendiri' : 'Kurir'"></span>
                                                <span class="text-slate-300">‚Ä¢</span>
                                                <span x-text="formatDate(order.date)"></span>
                                            </p>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <p class="font-black text-sm" :class="order.itemType === 'xp' ? 'text-purple-600' : 'text-slate-800'" x-text="order.costDisplay"></p>
                                    </div>
                                </div>
                            </template>
                             <div x-show="marketOrders.length === 0" class="text-center py-12">
                                <div class="w-20 h-20 bg-slate-100 rounded-full mx-auto mb-4 flex items-center justify-center text-3xl text-slate-400"><i class="ph-duotone ph-shopping-cart"></i></div>
                                <h3 class="font-bold text-slate-600">Belum Ada Transaksi</h3>
                                <p class="text-sm text-slate-400 mt-1">Tukarkan poinmu di Eco Market sekarang!</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 6. HISTORY VIEW -->
                <div x-show="currentPage === 'history'" x-transition.opacity.duration.300ms class="max-w-2xl mx-auto min-h-screen">
                    <!-- Header with Back Button -->
                    <div class="flex items-center gap-4 mb-6">
                        <button @click="setPage('home')" class="w-10 h-10 rounded-xl bg-white border border-slate-200 flex items-center justify-center hover:bg-slate-50 transition shadow-sm text-slate-600">
                            <i class="ph-bold ph-arrow-left text-lg"></i>
                        </button>
                        <div>
                            <h2 class="text-2xl font-bold text-slate-800">Riwayat Lengkap</h2>
                            <p class="text-sm text-slate-500">Semua aktivitas setoran sampahmu.</p>
                        </div>
                    </div>

                    <div class="bg-white rounded-[2rem] border border-slate-200 shadow-sm overflow-hidden">
                        <div class="p-1">
                            <template x-for="item in userHistory" :key="item.id">
                                <div class="p-5 border-b border-slate-50 last:border-0 hover:bg-slate-50 transition flex items-center justify-between group">
                                    <div class="flex items-center gap-4">
                                        <div class="w-12 h-12 rounded-2xl flex items-center justify-center text-xl shadow-sm transition-transform group-hover:scale-105" 
                                             :class="item.status === 'Approved' ? 'bg-emerald-100 text-emerald-600' : 'bg-yellow-100 text-yellow-600'">
                                            <i :class="item.status === 'Approved' ? 'ph-bold ph-check' : 'ph-bold ph-hourglass'"></i>
                                        </div>
                                        <div>
                                            <div class="flex items-center gap-2 mb-1">
                                                <h4 class="font-bold text-slate-800" x-text="item.weight + ' Kg Sampah'"></h4>
                                                <span class="text-[10px] font-bold px-2 py-0.5 rounded-md uppercase tracking-wider" 
                                                      :class="item.status === 'Approved' ? 'bg-emerald-100 text-emerald-700' : 'bg-yellow-100 text-yellow-700'"
                                                      x-text="item.status === 'Approved' ? 'Selesai' : 'Pending'">
                                                </span>
                                            </div>
                                            <p class="text-xs text-slate-500 font-medium flex items-center gap-1.5">
                                                <i class="ph-fill ph-calendar text-slate-400"></i> <span x-text="formatDate(item.date)"></span>
                                            </p>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <p class="font-black text-lg text-emerald-600" x-text="'+' + item.xpReward"></p>
                                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Poin XP</p>
                                    </div>
                                </div>
                            </template>
                             <div x-show="userHistory.length === 0" class="text-center py-12">
                                <div class="w-20 h-20 bg-slate-100 rounded-full mx-auto mb-4 flex items-center justify-center text-3xl text-slate-400"><i class="ph-duotone ph-list-dashes"></i></div>
                                <h3 class="font-bold text-slate-600">Belum Ada Riwayat</h3>
                                <p class="text-sm text-slate-400 mt-1">Lakukan setoran pertamamu sekarang!</p>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- === MODAL SETOR SAMPAH === -->
    <div x-show="showDepositModal" class="fixed inset-0 z-50 flex items-center justify-center px-4" style="display: none;">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" @click="showDepositModal = false"></div>
        <div class="bg-white w-full max-w-sm rounded-[2rem] shadow-2xl relative z-10 p-6 text-center">
            
            <div x-show="depositStep === 1">
                <div class="w-16 h-16 bg-emerald-100 rounded-full mx-auto mb-4 flex items-center justify-center text-3xl text-emerald-600"><i class="ph-duotone ph-recycle"></i></div>
                <h3 class="text-xl font-bold text-slate-900 mb-2">Konfirmasi Setoran</h3>
                <p class="text-sm text-slate-500 mb-4">Setor ke <b x-text="selectedTpa?.nama"></b>.</p>
                
                <div class="bg-slate-50 p-4 rounded-xl mb-4 border border-slate-100 text-left">
                    <label class="block text-xs font-bold text-slate-400 mb-1">Alamat Penjemputan</label>
                    <textarea x-model="depositData.address" placeholder="Masukkan alamat lengkap..." class="w-full p-2 bg-white rounded-lg border border-slate-200 text-sm h-16 resize-none focus:ring-1 focus:ring-emerald-500 outline-none"></textarea>
                </div>
                
                <div class="flex justify-between items-center bg-emerald-50 p-3 rounded-xl mb-6">
                    <span class="text-xs font-bold text-emerald-700">Total Berat: <span x-text="trashBag.weight"></span> Kg</span>
                    <span class="text-xs font-bold text-emerald-700">Estimasi: +<span x-text="trashBag.potentialXP"></span> XP</span>
                </div>

                <button @click="processDeposit()" class="w-full bg-emerald-600 text-white py-3.5 rounded-xl font-bold shadow-lg hover:bg-emerald-700 transition">Minta Penjemputan</button>
                <button @click="showDepositModal = false" class="w-full text-slate-400 font-bold text-sm mt-4">Batal</button>
            </div>

            <div x-show="depositStep === 2" class="py-8">
                <div class="w-16 h-16 bg-yellow-100 rounded-full mx-auto mb-4 flex items-center justify-center text-3xl text-yellow-600 animate-pulse"><i class="ph-duotone ph-clock"></i></div>
                <h3 class="text-lg font-bold text-slate-800">Menunggu Konfirmasi...</h3>
                <p class="text-xs text-slate-500 mt-2">Mengirim data ke database...</p>
            </div>

            <div x-show="depositStep === 3" class="py-8">
                <div class="w-16 h-16 bg-blue-100 rounded-full mx-auto mb-4 flex items-center justify-center text-3xl text-blue-600"><i class="ph-duotone ph-moped"></i></div>
                <h3 class="text-lg font-bold text-slate-800">Tim Menuju Lokasi</h3>
                <p class="text-xs text-slate-500 mt-2">Kurir SORTIQ sedang dalam perjalanan ke alamatmu.</p>
            </div>

            <div x-show="depositStep === 4">
                <div class="w-20 h-20 bg-emerald-500 rounded-full mx-auto mb-4 flex items-center justify-center text-4xl text-white animate-bounce"><i class="ph-bold ph-check"></i></div>
                <h3 class="text-xl font-bold text-emerald-700 mb-2">Permintaan Terkirim!</h3>
                <p class="text-sm text-slate-500 mb-6">Data tersimpan di database. Menunggu persetujuan Admin.</p>
                <button @click="showDepositModal = false" class="w-full bg-slate-900 text-white py-3.5 rounded-xl font-bold shadow-lg">Selesai</button>
            </div>
        </div>
    </div>


    <!-- === MODAL PEMBAYARAN & LOGISTIK === -->
    <div x-show="showPaymentModal" class="fixed inset-0 z-50 flex items-center justify-center px-4" style="display: none;">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" @click="closePayment()"></div>
        <div class="bg-white w-full max-w-md rounded-[2rem] shadow-2xl relative z-10 overflow-hidden flex flex-col max-h-[90vh]">
            <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                <h3 class="font-bold text-slate-800 text-lg">Rincian Pesanan</h3>
                <button @click="closePayment()" class="w-8 h-8 rounded-full bg-slate-200 flex items-center justify-center hover:bg-slate-300 transition"><i class="ph-bold ph-x text-slate-600"></i></button>
            </div>
            <div class="p-6 overflow-y-auto">
                <div x-show="paymentStep === 1">
                    <div class="flex gap-4 mb-6 bg-slate-50 p-4 rounded-2xl border border-slate-100">
                        <div class="w-16 h-16 bg-white rounded-xl flex items-center justify-center text-3xl shadow-sm shrink-0"><i :class="selectedItem?.icon" :class="selectedItem?.bgClass.replace('bg-', 'text-').split(' ')[1]"></i></div>
                        <div>
                            <h4 class="font-bold text-slate-900" x-text="selectedItem?.name"></h4>
                            <p class="text-xs text-slate-500 line-clamp-1" x-text="selectedItem?.desc"></p>
                            <p class="text-sm font-black text-emerald-600 mt-1" x-text="selectedItem?.cost"></p>
                        </div>
                    </div>
                    <div class="space-y-4 mb-6">
                        <h4 class="text-xs font-bold text-slate-400 uppercase tracking-wider">Opsi Pengiriman</h4>
                        <div class="grid grid-cols-2 gap-3">
                            <button @click="shippingData.method = 'pickup'" :class="shippingData.method === 'pickup' ? 'border-emerald-500 bg-emerald-50 text-emerald-700' : 'border-slate-200 hover:border-slate-300'" class="border-2 rounded-xl p-3 text-center transition flex flex-col items-center gap-1"><i class="ph-duotone ph-storefront text-xl"></i><span class="text-xs font-bold">Ambil Sendiri</span></button>
                            <button @click="shippingData.method = 'delivery'" :class="shippingData.method === 'delivery' ? 'border-emerald-500 bg-emerald-50 text-emerald-700' : 'border-slate-200 hover:border-slate-300'" class="border-2 rounded-xl p-3 text-center transition flex flex-col items-center gap-1"><i class="ph-duotone ph-moped text-xl"></i><span class="text-xs font-bold">Kurir SORTIQ</span></button>
                        </div>
                    </div>
                    <button @click="processPayment()" class="w-full bg-slate-900 text-white py-3.5 rounded-xl font-bold shadow-lg hover:bg-slate-800 transition active:scale-95 flex items-center justify-center gap-2"><span x-text="selectedItem?.type === 'money' ? 'Bayar Sekarang' : 'Tukar Poin'"></span><i class="ph-bold ph-arrow-right"></i></button>
                </div>
                <div x-show="paymentStep === 2" class="py-10 text-center">
                    <div class="w-48 h-48 mx-auto bg-white border-2 border-slate-900 rounded-xl p-2 relative mb-4">
                        <img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=SORTIQ_PAYMENT_DEMO" class="w-full h-full opacity-50 blur-sm">
                        <div class="absolute inset-0 flex items-center justify-center"><div class="w-12 h-12 border-4 border-emerald-500 border-t-transparent rounded-full animate-spin"></div></div>
                    </div>
                    <p class="font-bold text-slate-800 animate-pulse">Menghubungkan Payment Gateway...</p>
                </div>
                <div x-show="paymentStep === 3" class="text-center">
                    <div class="w-20 h-20 bg-emerald-100 rounded-full mx-auto mb-4 flex items-center justify-center text-4xl text-emerald-600 animate-[bounce_1s]"><i class="ph-fill ph-check-circle"></i></div>
                    <h3 class="text-xl font-bold text-emerald-700 mb-1">Pesanan Diterima!</h3>
                    <p class="text-sm text-slate-500 mb-6">Kami akan segera memproses permintaanmu.</p>
                    <button @click="closePayment()" class="w-full bg-slate-900 text-white py-3.5 rounded-xl font-bold shadow-lg hover:bg-slate-800 transition">Selesai</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile Navigation (Bottom Fixed) -->
    <div class="md:hidden fixed bottom-6 left-4 right-4 bg-slate-900/90 backdrop-blur-xl rounded-[2rem] p-3 flex justify-between items-center shadow-2xl z-50 border border-white/10">
        <button @click="setPage('home')" :class="currentPage === 'home' ? 'text-white bg-white/10' : 'text-slate-500'" class="w-12 h-12 flex items-center justify-center rounded-2xl"><i class="ph-bold ph-squares-four text-2xl"></i></button>
        <button @click="setPage('tpa')" :class="currentPage === 'tpa' ? 'text-white bg-white/10' : 'text-slate-500'" class="w-12 h-12 flex items-center justify-center rounded-2xl"><i class="ph-bold ph-map-trifold text-2xl"></i></button>
        <div class="relative -top-8">
            <!-- BUTTON LINK UPDATE -->
            <button onclick="window.location.href='scan.html'" class="w-16 h-16 bg-gradient-to-tr from-emerald-500 to-emerald-400 rounded-full flex items-center justify-center text-white shadow-xl shadow-emerald-500/40 border-[6px] border-slate-50 transition active:scale-90"><i class="ph-bold ph-scan text-2xl"></i></button>
        </div>
        <button @click="setPage('market')" :class="currentPage === 'market' ? 'text-white bg-white/10' : 'text-slate-500'" class="w-12 h-12 flex items-center justify-center rounded-2xl"><i class="ph-bold ph-storefront text-2xl"></i></button>
        <button @click="setPage('bot')" :class="currentPage === 'bot' ? 'text-white bg-white/10' : 'text-slate-500'" class="w-12 h-12 flex items-center justify-center rounded-2xl"><i class="ph-bold ph-chat-centered-text text-2xl"></i></button>
    </div>

    <!-- Alpine JS Logic -->
    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.data('appData', () => ({
                currentPage: 'home', 
                pageTitle: 'Dashboard', 
                xp: 0, 
                username: 'Memuat...', 
                email: '',
                showPaymentModal: false, 
                selectedItem: null, 
                paymentStep: 1, 
                showDepositModal: false, 
                depositStep: 1, 
                marketTab: 'redeem', 
                isTyping: false,
                trashBag: { weight: 0, potentialXP: 0 }, 
                shippingData: { address: '', method: 'pickup', note: '' },
                depositData: { address: '' },
                userHistory: [], 
                marketOrders: [], // NEW
                trashCategories: [
                        { name: 'Plastik (PET/HDPE)', ratio: 0.45, price: 'Rp 3.500/kg', lightColor: 'bg-emerald-50', textColor: 'text-emerald-600', hexColor: '#10b981', icon: 'ph-bold ph-recycle' },
                        { name: 'Kertas & Karton', ratio: 0.30, price: 'Rp 2.000/kg', lightColor: 'bg-blue-50', textColor: 'text-blue-600', hexColor: '#3b82f6', icon: 'ph-bold ph-file-text' },
                        { name: 'Organik & Lainnya', ratio: 0.25, price: 'Rp 1.500/kg', lightColor: 'bg-orange-50', textColor: 'text-orange-600', hexColor: '#f97316', icon: 'ph-bold ph-leaf' }
                    ],
                    chartInstance: null,
                    // ----------------------------------------

                    navItems: [
                        { id: 'home', label: 'Dashboard', icon: 'ph-bold ph-squares-four' },
                        { id: 'tpa', label: 'Lokasi Setor', icon: 'ph-bold ph-map-trifold' },
                        { id: 'bot', label: 'Tanya AI', icon: 'ph-bold ph-robot' },
                        { id: 'market', label: 'Eco Market', icon: 'ph-bold ph-storefront' },
                        { id: 'orders', label: 'Riwayat Belanja', icon: 'ph-bold ph-receipt' }
                    ],

                    

                selectedTpaId: 1, 
                tpaSearch: '',
                tpaData: [
                    { id: 1, nama: "Bank Sampah Induk Surabaya", alamat: "Jl. Ngagel Tim., Pucang Sewu", lat: -7.289166, lng: 112.756549, status: "Terima Setor (Cuan)", tipe: "Recycling Center", jarak: "2.1 km", zoom: 18 },
                    { id: 2, nama: "SORTIQ Recycling Hub (Segera)", alamat: "Rencana Lokasi: Surabaya Barat", lat: -7.275432, lng: 112.792331, status: "Coming Soon", tipe: "Smart Hub", jarak: "3.5 km", zoom: 15 },
                    { id: 3, nama: "Bank Sampah Bintang Mangrove", alamat: "Gunung Anyar Tambak, Surabaya", lat: -7.339243, lng: 112.822231, status: "Buka", tipe: "Community Unit", jarak: "7.8 km", zoom: 16 }
                ],
                get selectedTpa() { return this.tpaData.find(t => t.id === this.selectedTpaId); },
                get filteredTpa() { return this.tpaData.filter(t => t.nama.toLowerCase().includes(this.tpaSearch.toLowerCase())); },

                marketItems: [
                    { id: 1, name: 'Voucher Gopay 10k', desc: 'Saldo E-Wallet instan.', cost: '1000 XP', type: 'xp', category: 'redeem', priceValue: 1000, bgClass: 'bg-blue-50 text-blue-500', icon: 'ph-duotone ph-wallet' },
                    { id: 2, name: 'Bibit Mangga', desc: 'Hijaukan pekaranganmu.', cost: '500 XP', type: 'xp', category: 'redeem', priceValue: 500, bgClass: 'bg-green-50 text-green-600', icon: 'ph-duotone ph-plant' },
                    { id: 3, name: 'Starter Kit Kompos', desc: 'Alat komposting rumah.', cost: 'Rp 150.000', type: 'money', category: 'shop', priceValue: 150000, bgClass: 'bg-orange-50 text-orange-500', icon: 'ph-duotone ph-recycle' },
                    { id: 4, name: 'Totebag Kanvas', desc: 'Pengganti kresek.', cost: 'Rp 25.000', type: 'money', category: 'shop', priceValue: 25000, bgClass: 'bg-purple-50 text-purple-500', icon: 'ph-duotone ph-bag' }
                ],

                logout() {
        if (confirm('Apakah Anda yakin ingin keluar dari akun?')) {
            // Hapus data sesi sementara (opsional)
            localStorage.removeItem('sortiq_trashbag');
            
            // Redirect ke halaman beranda (sesuaikan 'index.html' dengan nama file utamamu)
            window.location.href = 'index.html'; 
        }
    },

                chatMessages: [],
                chatInput: '',
                
                init() {
                    // Connect Alpine Scope to Firebase Bridge
                    if (window.fbBridge) {
                        window.fbBridge.init(this);
                    }

                    // Load Trashbag (Local Storage is fine for temporary cart)
                    const storedBag = localStorage.getItem('sortiq_trashbag');
                    if (storedBag) this.trashBag = JSON.parse(storedBag);
                    else this.trashBag = { weight: 5.5, potentialXP: 550 }; // Default for demo

                    this.chatMessages = [{ id: 1, text: `Halo! Saya AI SORTIQ. Ada yang bisa saya bantu?`, sender: 'bot', time: '10:00' }];
                },
                    setPage(pageId) {
                        this.currentPage = pageId;
                        const titles = { 'home': 'Dashboard', 'bag': 'Detail Kantong', 'tpa': 'Lokasi Setor', 'bot': 'Asisten AI', 'market': 'Eco Market', 'orders': 'Riwayat Belanja', 'history': 'Riwayat Setoran' };
                        this.pageTitle = titles[pageId] || 'Dashboard';
                        document.getElementById('main-scroll').scrollTop = 0;

                        // Render Chart jika masuk ke halaman bag
                        if (pageId === 'bag') {
                            setTimeout(() => this.renderChart(), 100); 
                        }
                    },
                    renderChart() {
                        const ctx = document.getElementById('marketChartDetail');
                        if (!ctx) return;
                        
                        if (this.chartInstance) this.chartInstance.destroy();

                        this.chartInstance = new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: ['Sen', 'Sel', 'Rab', 'Kam', 'Jum', 'Sab', 'Min'],
                                datasets: [{
                                    label: 'Harga',
                                    data: [3100, 3150, 3100, 3300, 3400, 3450, 3500],
                                    borderColor: '#10b981',
                                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                    fill: true,
                                    tension: 0.4,
                                    pointRadius: 0,
                                    borderWidth: 2
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: { legend: { display: false } },
                                scales: { x: { display: false }, y: { display: false } }
                            }
                        });
                    },

                formatDate(isoString) {
                    if(!isoString) return '-';
                    const d = new Date(isoString);
                    if (isNaN(d.getTime())) return '-';
                    return d.toLocaleString('id-ID', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' });
                },

                selectTpa(id) { this.selectedTpaId = id; },
                openGmaps() { window.open(`https://www.google.com/maps/dir/?api=1&destination=${this.selectedTpa.lat},${this.selectedTpa.lng}`, '_blank'); },

                async sendMessage() {
                    // 1. Validasi Input
                    if (!this.chatInput.trim()) return;
                    
                    // 2. Tampilkan Chat User
                    const userText = this.chatInput;
                    this.chatMessages.push({ id: Date.now(), text: userText, sender: 'user', time: 'Sekarang' });
                    this.chatInput = '';
                    this.isTyping = true;

                    try {
                        // 3. Request ke Proxy
                        const response = await fetch("proxy.php", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ prompt: userText })
                        });

                        // Cek jika proxy.php sendiri error (misal 404 atau 500)
                        if (!response.ok) {
                            throw new Error(`Server Error: ${response.status} ${response.statusText}`);
                        }

                        const data = await response.json();
                        console.log("Respon Asli dari Proxy:", data); // Cek Console browser (F12) untuk lihat detail

                        let botReply = "";

                        // 4. Logika Pengecekan Error
                        if (data.error) {
                            // Jika Google ngasih pesan error (misal API Key salah)
                            botReply = "‚ö†Ô∏è Error dari Google: " + (data.error.message || JSON.stringify(data.error));
                        } 
                        else if (data.candidates && data.candidates[0].content && data.candidates[0].content.parts) {
                            // Jika Sukses
                            botReply = data.candidates[0].content.parts[0].text;
                        } 
                        else {
                            // Jika format JSON aneh/kosong
                            botReply = "‚ö†Ô∏è Respon kosong atau format salah. Cek Console (F12).";
                        }

                        // 5. Tampilkan Balasan Bot
                        this.isTyping = false;
                        this.chatMessages.push({ 
                            id: Date.now() + 1, 
                            text: botReply, 
                            sender: 'bot', 
                            time: 'Sekarang' 
                        });

                    } catch (error) {
                        console.error("Error Fetch:", error);
                        this.isTyping = false;
                        this.chatMessages.push({ 
                            id: Date.now() + 1, 
                            text: "‚ö†Ô∏è Gagal terhubung: " + error.message, 
                            sender: 'bot', 
                            time: 'Error' 
                        });
                    }
                },
                
                startTransaction(item) {
                    this.selectedItem = item;
                    this.shippingData = { address: '', method: 'pickup', note: '' };
                    this.paymentStep = 1;
                    this.showPaymentModal = true;
                },

                async processPayment() {
                    if (this.selectedItem.type === 'xp') {
                        if (this.xp >= this.selectedItem.priceValue) {
                            // REAL DB TRANSACTION (XP)
                            const success = await window.fbBridge.submitOrder({
                                ...this.selectedItem,
                                method: this.shippingData.method
                            }, this.xp);

                            if(success) {
                                this.paymentStep = 3;
                            } else {
                                alert("Gagal memproses transaksi. Coba lagi.");
                            }
                        } else {
                            alert("Poin XP tidak mencukupi.");
                        }
                    } else {
                        // MONEY TRANSACTION (Simulated but saved to DB)
                        this.paymentStep = 2;
                        setTimeout(async () => {
                             const success = await window.fbBridge.submitOrder({
                                ...this.selectedItem,
                                method: this.shippingData.method
                            }, this.xp);
                            
                            if(success) this.paymentStep = 3;
                            else alert("Gagal menyimpan pesanan.");
                        }, 3000);
                    }
                },
                

                closePayment() { this.showPaymentModal = false; this.selectedItem = null; this.paymentStep = 1; },
                
                openDepositModal() {
                    if (this.trashBag.weight <= 0) return alert("Kantong kosong!");
                    this.depositStep = 1;
                    this.depositData.address = '';
                    this.showDepositModal = true;
                },

                async processDeposit() {
                    if (!this.depositData.address.trim()) return alert("Alamat harus diisi!");
                    this.depositStep = 2; // Pending UI
                    
                    // SEND TO DATABASE
                    const success = await window.fbBridge.submitDeposit({
                        weight: this.trashBag.weight,
                        xpReward: this.trashBag.potentialXP,
                        address: this.depositData.address,
                        tpaName: this.selectedTpa.nama
                    });

                    

                    if(success) {
                        setTimeout(() => this.depositStep = 3, 1500); 
                        setTimeout(() => {
                            this.depositStep = 4; // Done
                            this.trashBag = { weight: 0, potentialXP: 0 };
                            localStorage.setItem('sortiq_trashbag', JSON.stringify(this.trashBag));
                        }, 4000);
                    } else {
                        alert("Gagal mengirim data ke server.");
                        this.showDepositModal = false;
                        
                    }
                    
                }
                
            }));
        });
    </script>
</body>
</html>