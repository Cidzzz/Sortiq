<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SORTIQ - Dashboard</title>
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    
    <!-- Firebase Libraries & Logic -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
        import { getFirestore, collection, doc, onSnapshot, addDoc, updateDoc, setDoc, serverTimestamp, query } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

        // --- 1. SETUP FIREBASE ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app';
        
        let db, auth, userUid;

        if (firebaseConfig) {
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            
            // --- 2. LOGIC BRIDGE (REAL FIREBASE) ---
            window.fbBridge = {
                init: async (alpineScope) => {
                    if (!auth) return;

                    const initAuth = async () => {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    };
                    await initAuth();

                    onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            userUid = user.uid;
                            alpineScope.username = "User " + userUid.substring(0, 5);

                            const userDocRef = doc(db, 'artifacts', appId, 'users', userUid, 'profile', 'data');
                            onSnapshot(userDocRef, (docSnap) => {
                                if (docSnap.exists()) {
                                    const data = docSnap.data();
                                    alpineScope.xp = data.xp || 0;
                                    alpineScope.username = data.name || alpineScope.username;
                                    alpineScope.email = data.email || '';
                                    alpineScope.phone = data.phone || '0812-3456-7890'; // Default phone
                                } else {
                                    setDoc(userDocRef, {
                                        xp: 0,
                                        name: "Pengguna Baru",
                                        email: "",
                                        phone: "",
                                        joinedAt: serverTimestamp()
                                    });
                                }
                            });

                            const depositsRef = collection(db, 'artifacts', appId, 'public', 'data', 'deposits');
                            onSnapshot(depositsRef, (snapshot) => {
                                const allDeposits = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                                const myDeposits = allDeposits
                                    .filter(d => d.uid === userUid)
                                    .sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                                alpineScope.userHistory = myDeposits;
                            });

                            const ordersRef = collection(db, 'artifacts', appId, 'public', 'data', 'market_orders');
                            onSnapshot(ordersRef, (snapshot) => {
                                const allOrders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                                const myOrders = allOrders
                                    .filter(d => d.uid === userUid)
                                    .sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                                alpineScope.marketOrders = myOrders;
                            });
                        }
                    });
                },

                submitDeposit: async (data) => {
                    if (!userUid || !db) return false;
                    try {
                        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'deposits'), {
                            uid: userUid,
                            weight: parseFloat(data.weight),
                            xpReward: parseInt(data.xpReward),
                            address: data.address,
                            status: 'Approved', 
                            tpaName: data.tpaName,
                            timestamp: serverTimestamp(),
                            date: new Date().toISOString()
                        });
                        
                        // Auto add XP immediately for this demo flow
                        const userDocRef = doc(db, 'artifacts', appId, 'users', userUid, 'profile', 'data');
                        return true;
                    } catch (e) {
                        console.error("Deposit failed:", e);
                        return false;
                    }
                },

                submitOrder: async (orderData, currentXP) => {
                    if (!userUid || !db) return false;
                    if (orderData.type === 'xp') {
                         const newXP = currentXP - orderData.priceValue;
                         if (newXP < 0) return false;
                         try {
                            const userDocRef = doc(db, 'artifacts', appId, 'users', userUid, 'profile', 'data');
                            await updateDoc(userDocRef, { xp: newXP });
                         } catch(e) { 
                             console.error("Failed deduct XP", e);
                             return false; 
                         }
                    }
                    try {
                        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'market_orders'), {
                            uid: userUid,
                            itemName: orderData.name,
                            itemType: orderData.type,
                            costDisplay: orderData.cost,
                            priceValue: orderData.priceValue,
                            status: orderData.status || 'Diproses',
                            shippingMethod: orderData.method,
                            meta: orderData.meta || {},
                            timestamp: serverTimestamp(),
                            date: new Date().toISOString()
                        });
                        return true;
                    } catch (e) {
                        console.error("Order failed:", e);
                        return false;
                    }
                }
            };
        } else {
            // --- MOCK BRIDGE (DEMO MODE) ---
            let _scope = null;
            window.fbBridge = {
                init: (alpineScope) => {
                    _scope = alpineScope;
                    setTimeout(() => {
                        alpineScope.username = "Demo User";
                        alpineScope.email = "user@sortiq.demo";
                        alpineScope.phone = "081234567890";
                        alpineScope.xp = 15000;
                        alpineScope.userHistory = [
                            { id: 1, weight: 2.5, status: 'Approved', xpReward: 125, date: new Date().toISOString() }
                        ];
                    }, 500);
                },
                submitDeposit: async (data) => {
                    await new Promise(r => setTimeout(r, 500)); 
                    if (_scope) {
                        _scope.userHistory.unshift({
                            id: Date.now(),
                            uid: 'demo-user',
                            weight: parseFloat(data.weight),
                            xpReward: parseInt(data.xpReward),
                            address: data.address,
                            status: 'Approved',
                            tpaName: data.tpaName,
                            timestamp: { seconds: Date.now() / 1000 },
                            date: new Date().toISOString()
                        });
                         _scope.xp = (_scope.xp || 0) + parseInt(data.xpReward);
                    }
                    return true;
                },
                submitOrder: async (data, currentXP) => {
                    await new Promise(r => setTimeout(r, 1500));
                    if (_scope) {
                        const newOrder = {
                            id: Date.now(),
                            uid: 'demo-user',
                            itemName: data.name,
                            itemType: data.type,
                            costDisplay: data.cost,
                            priceValue: data.priceValue,
                            status: data.status || 'Berhasil',
                            shippingMethod: data.method,
                            meta: data.meta || {},
                            timestamp: { seconds: Date.now() / 1000 },
                            date: new Date().toISOString()
                        };
                        _scope.marketOrders.unshift(newOrder); 
                        
                        if (data.type === 'xp') {
                            _scope.xp = (_scope.xp || 0) - data.priceValue;
                        }
                    }
                    return true;
                }
            };
        }
    </script>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Config & Styles -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Plus Jakarta Sans', 'sans-serif'] },
                    animation: { 'float': 'float 6s ease-in-out infinite' },
                    keyframes: { float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-10px)' } } }
                }
            }
        }
    </script>
    <style>
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #CBD5E1; border-radius: 10px; }
        .glass { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(12px); border-bottom: 1px solid rgba(255, 255, 255, 0.6); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .tooltip { visibility: hidden; opacity: 0; position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); background-color: #1e293b; color: white; padding: 0.5rem; border-radius: 0.5rem; font-size: 0.75rem; white-space: nowrap; z-index: 50; transition: opacity 0.2s; margin-bottom: 0.5rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .has-tooltip:hover .tooltip { visibility: visible; opacity: 1; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans overflow-hidden" x-data="appData">

    <!-- Background Blobs -->
    <div class="fixed top-0 left-0 w-full h-full overflow-hidden -z-10 pointer-events-none">
        <div class="absolute top-[-10%] left-[-10%] w-96 h-96 bg-emerald-400/20 rounded-full blur-[100px] animate-float"></div>
        <div class="absolute bottom-[-10%] right-[-10%] w-96 h-96 bg-blue-400/20 rounded-full blur-[100px] animate-float" style="animation-delay: 2s;"></div>
    </div>

    <div class="flex h-screen w-full">
        <!-- === SIDEBAR === -->
        <aside class="hidden md:flex flex-col w-72 bg-white border-r border-slate-200 h-full z-30 shadow-sm">
            <div class="p-8 flex items-center gap-3">
                <div class="w-10 h-10 bg-white rounded-xl shadow-md flex items-center justify-center overflow-hidden">
                    <img src="https://ui-avatars.com/api/?name=S&background=10b981&color=fff" alt="Logo" class="w-full h-full object-cover">
                </div>
                <div>
                    <h1 class="font-bold text-xl tracking-tight text-slate-900 leading-none">SORTIQ</h1>
                    <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest mt-1">Smart Recycle</p>
                </div>
            </div>

            <nav class="flex-1 px-4 space-y-1 overflow-y-auto no-scrollbar">
                <p class="px-4 text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2 mt-4">Navigasi Utama</p>
                <template x-for="item in navItems" :key="item.id">
                    <button @click="setPage(item.id)" 
                            :class="currentPage === item.id ? 'bg-emerald-50 text-emerald-600 border-emerald-100 shadow-sm' : 'text-slate-500 hover:bg-slate-50 border-transparent'"
                            class="w-full flex items-center gap-4 px-4 py-3.5 rounded-2xl font-semibold text-sm transition-all duration-200 border group relative">
                        <i :class="item.icon" class="text-xl transition-transform group-hover:scale-110"></i>
                        <span x-text="item.label"></span>
                        <div x-show="currentPage === item.id" class="absolute right-0 top-1/2 -translate-y-1/2 w-1 h-8 bg-emerald-500 rounded-l-full"></div>
                    </button>
                </template>

                <p class="px-4 text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2 mt-6">Fitur Pintar</p>
                <button @click="alert('Fitur Camera Scan akan membuka kamera di perangkat mobile.')" class="text-slate-500 hover:bg-emerald-50 hover:text-emerald-600 w-full flex items-center gap-4 px-4 py-3.5 rounded-2xl font-semibold text-sm transition-all duration-200 border border-transparent group">
                    <i class="ph-bold ph-scan text-xl transition-transform group-hover:scale-110"></i>
                    <span>AI Scanner</span>
                    <span class="ml-auto bg-emerald-100 text-emerald-600 text-[10px] px-2 py-0.5 rounded-full">New</span>
                </button>
            </nav>

            <div class="p-4 border-t border-slate-100">
                <button onclick="if(confirm('Apakah Anda yakin ingin keluar?')) location.reload()" class="w-full flex items-center gap-3 text-red-500 font-bold text-sm hover:bg-red-50 p-4 rounded-2xl transition group">
                    <i class="ph-bold ph-sign-out text-xl group-hover:-translate-x-1 transition"></i> Keluar Akun
                </button>
            </div>
        </aside>

        <!-- === MAIN CONTENT === -->
        <main class="flex-1 flex flex-col h-full relative overflow-hidden">
            <!-- Header -->
            <header class="flex justify-between items-center px-4 py-3 md:px-10 md:py-6 z-20 glass sticky top-0">
                <div class="flex items-center gap-3 md:hidden">
                    <div class="w-8 h-8 bg-white rounded-lg shadow-sm flex items-center justify-center overflow-hidden">
                         <img src="logo.png" alt="Logo" class="w-full h-full object-cover">
                    </div>
                    <span class="font-bold text-lg tracking-tight">SORTIQ</span>
                </div>
                <div class="hidden md:block">
                    <h2 class="text-2xl font-bold text-slate-800 tracking-tight" x-text="pageTitle"></h2>
                    <p class="text-slate-500 text-sm">Mari buat dunia lebih bersih bersama SORTIQ.</p>
                </div>
                <div class="flex items-center gap-3">
                    <!-- Cart Icon in Header -->
                    <button @click="showCartModal = true" class="relative w-10 h-10 bg-white border border-slate-200 rounded-full shadow-sm flex items-center justify-center text-slate-600 hover:text-emerald-600 transition">
                        <i class="ph-bold ph-shopping-cart text-lg"></i>
                        <span x-show="cart.length > 0" class="absolute -top-1 -right-1 bg-red-500 text-white text-[9px] w-4 h-4 flex items-center justify-center rounded-full font-bold shadow-sm" x-text="cart.length"></span>
                    </button>

                    <div class="bg-white pl-2 pr-3 py-1 rounded-full border border-slate-200 shadow-sm flex items-center gap-2">
                        <div class="w-7 h-7 bg-yellow-100 rounded-full flex items-center justify-center text-yellow-600"><i class="ph-fill ph-coin text-sm"></i></div>
                        <span class="font-bold text-sm text-slate-700" x-text="xp + ' XP'"></span>
                    </div>
                    
                    <!-- Profile Dropdown Trigger -->
                    <div class="relative" x-data="{ open: false }">
                        <button @click="open = !open" class="focus:outline-none">
                            <img :src="`https://ui-avatars.com/api/?name=${username}&background=10b981&color=fff`" class="w-9 h-9 md:w-10 md:h-10 rounded-full border-2 border-white shadow-sm hidden sm:block cursor-pointer hover:opacity-80 transition">
                        </button>
                        
                        <!-- Profile Popup Menu -->
                        <div x-show="open" @click.outside="open = false" x-transition.origin.top.right class="absolute right-0 mt-2 w-56 bg-white rounded-2xl shadow-xl border border-slate-100 overflow-hidden z-50">
                            <div class="p-4 border-b border-slate-50 bg-slate-50/50">
                                <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Halo,</p>
                                <p class="font-bold text-slate-800 truncate" x-text="username"></p>
                            </div>
                            <div class="p-2 space-y-1">
                                <button @click="setPage('account'); open = false" class="w-full text-left px-3 py-2 rounded-xl text-sm font-medium text-slate-600 hover:bg-emerald-50 hover:text-emerald-600 flex items-center gap-2 transition">
                                    <i class="ph-bold ph-gear"></i> Pengaturan Akun
                                </button>
                                <button @click="setPage('orders'); open = false" class="w-full text-left px-3 py-2 rounded-xl text-sm font-medium text-slate-600 hover:bg-blue-50 hover:text-blue-600 flex items-center gap-2 transition">
                                    <i class="ph-bold ph-receipt"></i> Pesanan Saya
                                </button>
                                <div class="h-px bg-slate-100 my-1"></div>
                                <button onclick="if(confirm('Keluar akun?')) location.reload()" class="w-full text-left px-3 py-2 rounded-xl text-sm font-medium text-red-500 hover:bg-red-50 flex items-center gap-2 transition">
                                    <i class="ph-bold ph-sign-out"></i> Keluar Akun
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Scrollable Content -->
            <div class="flex-1 overflow-y-auto p-4 md:p-10 pb-32 md:pb-10 scroll-smooth no-scrollbar" id="main-scroll">
                
                <!-- 1. HOME VIEW -->
                <div x-show="currentPage === 'home'" x-transition.opacity.duration.300ms class="space-y-6 md:space-y-8 max-w-6xl mx-auto">
                    <!-- Banner -->
                    <div class="grid md:grid-cols-3 gap-6">
                        <div class="md:col-span-2 bg-slate-900 rounded-[2rem] md:rounded-[2.5rem] p-6 md:p-10 text-white relative overflow-hidden shadow-2xl group flex flex-col justify-center">
                            <div class="absolute top-0 right-0 w-64 h-64 bg-emerald-500 rounded-full blur-[100px] opacity-20 group-hover:opacity-30 transition duration-700"></div>
                            <div class="relative z-10">
                                <div class="inline-flex items-center gap-2 px-3 py-1 bg-white/10 backdrop-blur-md rounded-full text-[10px] font-bold mb-4 text-emerald-300 border border-white/10 uppercase tracking-widest">‚ú® Mulai Aksimu</div>
                                <h2 class="text-2xl md:text-3xl font-extrabold mb-3 leading-tight">Sudah Scan Sampah?</h2>
                                <p class="text-slate-300 mb-6 text-sm">Kumpulkan sampah di rumah, scan dengan AI, lalu setor ke lokasi terdekat untuk dapat poin.</p>
                                <button @click="alert('Membuka kamera... (Simulasi)')" class="w-max bg-emerald-500 hover:bg-emerald-400 text-white px-6 py-3 rounded-2xl font-bold shadow-lg shadow-emerald-500/30 transition active:scale-95 flex items-center gap-2 text-sm md:text-base">
                                    <i class="ph-bold ph-camera text-lg"></i> Scan Sekarang
                                </button>
                            </div>
                        </div>

                        <!-- KANTONG SAMPAH DIGITAL -->
                        <div class="bg-white p-6 rounded-[2rem] md:rounded-[2.5rem] border border-slate-200 shadow-sm flex flex-col justify-between relative overflow-hidden">
                            <div class="absolute -right-6 -top-6 w-24 h-24 bg-blue-50 rounded-full"></div>
                            <div class="relative z-10">
                                <h3 class="font-bold text-slate-800 text-lg flex items-center gap-2">
                                    <i class="ph-duotone ph-bag text-blue-500 text-2xl"></i> Kantong Saya
                                </h3>
                                <p class="text-xs text-slate-400 mt-1">Sampah yang belum disetor.</p>
                                <div class="mt-6 space-y-4">
                                    <div class="flex justify-between items-end">
                                        <span class="text-slate-500 text-sm font-medium">Berat</span>
                                        <span class="text-2xl font-black text-slate-800"><span x-text="trashBag.weight"></span> <span class="text-sm font-bold text-slate-400">Kg</span></span>
                                    </div>
                                    <div class="flex justify-between items-end">
                                        <span class="text-slate-500 text-sm font-medium">Potensi Poin</span>
                                        <span class="text-2xl font-black text-emerald-600">+<span x-text="trashBag.potentialXP"></span> <span class="text-sm font-bold text-emerald-400">XP</span></span>
                                    </div>
                                </div>
                            </div>
                            <button @click="setPage('tpa')" class="mt-6 w-full bg-slate-100 hover:bg-emerald-50 text-slate-600 hover:text-emerald-700 py-3 rounded-xl font-bold text-sm transition flex items-center justify-center gap-2 border border-transparent hover:border-emerald-200">
                                <i class="ph-bold ph-map-pin"></i> Cari Lokasi Setor
                            </button>
                        </div>
                    </div>

                    <!-- FITUR UTAMA -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                         <div class="bg-white p-5 rounded-[2rem] border border-slate-200 shadow-sm hover:shadow-lg transition duration-300 flex flex-col justify-between h-full relative group">
                            <div>
                                <div class="flex justify-between items-start mb-2">
                                    <div class="w-10 h-10 bg-emerald-50 text-emerald-600 rounded-xl flex items-center justify-center text-xl shadow-sm">
                                        <i class="ph-fill ph-trash"></i>
                                    </div>
                                    <div class="has-tooltip relative cursor-help">
                                        <i class="ph-fill ph-info text-slate-300 hover:text-emerald-500"></i>
                                        <span class="tooltip w-40 whitespace-normal text-center right-0 transform-none left-auto">Total berat sampah hasil scan yang belum disetor ke bank sampah.</span>
                                    </div>
                                </div>
                                <h4 class="text-slate-400 text-[10px] font-bold uppercase tracking-wider mb-1">Total Sampah di Kantong</h4>
                                <p class="text-2xl font-black text-slate-800 mb-2"><span x-text="trashBag.weight > 0 ? trashBag.weight : '0'"></span> kg</p>
                                
                                <div class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-lg text-[10px] font-bold border"
                                     :class="trashBag.weight > 0 ? 'bg-emerald-50 text-emerald-700 border-emerald-100' : 'bg-yellow-50 text-yellow-700 border-yellow-100'">
                                    <span class="w-1.5 h-1.5 rounded-full" :class="trashBag.weight > 0 ? 'bg-emerald-500 animate-pulse' : 'bg-yellow-500'"></span>
                                    <span x-text="trashBag.weight > 0 ? 'Siap disetor' : 'Menunggu jumlah minimum'"></span>
                                </div>
                            </div>
                            <button @click="setPage('bag')" class="mt-4 w-full py-2.5 bg-slate-50 hover:bg-slate-100 text-slate-600 text-xs font-bold rounded-xl transition flex items-center justify-center gap-2 group-hover:bg-slate-900 group-hover:text-white">
                                Lihat Detail Kantong <i class="ph-bold ph-arrow-right"></i>
                            </button>
                        </div>
                        
                        <div class="bg-white p-5 rounded-[2rem] border border-slate-200 shadow-sm hover:shadow-lg transition duration-300 flex flex-col justify-between h-full relative group">
                            <div>
                                <div class="flex justify-between items-start mb-2">
                                    <div class="w-10 h-10 bg-blue-50 text-blue-600 rounded-xl flex items-center justify-center text-xl shadow-sm">
                                        <i class="ph-fill ph-map-pin"></i>
                                    </div>
                                    <div class="has-tooltip relative cursor-help">
                                        <i class="ph-fill ph-info text-slate-300 hover:text-emerald-500"></i>
                                        <span class="tooltip w-40 whitespace-normal text-center right-0 transform-none left-auto">Informasi operasional dan lokasi penyetoran sampah terdekat.</span>
                                    </div>
                                </div>
                                <h4 class="text-slate-400 text-[10px] font-bold uppercase tracking-wider mb-1">Bank Sampah Terdekat</h4>
                                <div class="mb-2">
                                    <div>
                                        <!-- FIXED: Use safe accessor -->
                                        <p class="text-lg font-black text-slate-800 leading-tight" x-text="'üìç ' + nearestTpa.nama"></p>
                                        <p class="text-xs text-slate-500 font-medium" x-text="'(Jarak ¬± ' + nearestTpa.jarak + ')'"></p>
                                    </div>
                                </div>
                            </div>
                            <button @click="setPage('tpa')" class="mt-4 w-full py-2.5 bg-slate-50 hover:bg-slate-100 text-slate-600 text-xs font-bold rounded-xl transition flex items-center justify-center gap-2 group-hover:bg-blue-600 group-hover:text-white">
                                Lihat Lokasi Setor <i class="ph-bold ph-arrow-right"></i>
                            </button>
                        </div>

                        <div class="bg-white p-5 rounded-[2rem] border border-slate-200 shadow-sm hover:shadow-lg transition duration-300 flex flex-col justify-between h-full relative group">
                            <div>
                                <div class="flex justify-between items-start mb-2">
                                    <div class="w-10 h-10 bg-purple-50 text-purple-600 rounded-xl flex items-center justify-center text-xl shadow-sm">
                                        <i class="ph-fill ph-chart-line-up"></i>
                                    </div>
                                    <div class="has-tooltip relative cursor-help">
                                        <i class="ph-fill ph-info text-slate-300 hover:text-emerald-500"></i>
                                        <span class="tooltip w-40 whitespace-normal text-center right-0 transform-none left-auto">Kumpulkan sampah dengan nilai tertinggi untuk poin maksimal.</span>
                                    </div>
                                </div>
                                <h4 class="text-slate-400 text-[10px] font-bold uppercase tracking-wider mb-1">Harga Pasar Sampah</h4>
                                <div class="mb-2">
                                    <p class="text-lg font-black text-slate-800">Plastik PET</p>
                                    <p class="text-xs font-bold text-emerald-600 flex items-center gap-1">
                                        ‚ñ≤ +50 XP/kg
                                    </p>
                                </div>
                            </div>
                            <button @click="setPage('prices')" class="mt-4 w-full py-2.5 bg-slate-50 hover:bg-slate-100 text-slate-600 text-xs font-bold rounded-xl transition flex items-center justify-center gap-2 group-hover:bg-purple-600 group-hover:text-white">
                                Lihat Bursa Harga <i class="ph-bold ph-chart-line-up"></i>
                            </button>
                        </div>

                        <div class="bg-white p-5 rounded-[2rem] border border-slate-200 shadow-sm hover:shadow-lg transition duration-300 flex flex-col justify-between h-full relative group">
                            <div>
                                <div class="flex justify-between items-start mb-2">
                                    <div class="w-10 h-10 bg-orange-50 text-orange-600 rounded-xl flex items-center justify-center text-xl shadow-sm">
                                        <i class="ph-fill ph-fire"></i>
                                    </div>
                                    <div class="has-tooltip relative cursor-help">
                                        <i class="ph-fill ph-info text-slate-300 hover:text-emerald-500"></i>
                                        <span class="tooltip w-40 whitespace-normal text-center right-0 transform-none left-auto">Scan atau setor sampah hari ini untuk mempertahankan streak.</span>
                                    </div>
                                </div>
                                <h4 class="text-slate-400 text-[10px] font-bold uppercase tracking-wider mb-1">Streak Aktivitas</h4>
                                <div class="mb-2">
                                    <p class="text-lg font-black text-slate-800">3 Hari</p>
                                    <p class="text-xs text-slate-500 font-medium">Berturut-turut</p>
                                </div>
                                <div class="bg-orange-50 px-2 py-1 rounded-lg inline-block">
                                    <p class="text-[10px] font-bold text-orange-700">üèÜ 3 hari ‚Üí <span class="font-black">+10 XP</span></p>
                                </div>
                            </div>
                            <button @click="alert('Membuka kamera...')" class="mt-4 w-full py-2.5 bg-slate-50 hover:bg-slate-100 text-slate-600 text-xs font-bold rounded-xl transition flex items-center justify-center gap-2 group-hover:bg-orange-500 group-hover:text-white">
                                Scan Sekarang <i class="ph-bold ph-camera"></i>
                            </button>
                        </div>
                    </div> 
                    
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2 bg-white p-6 rounded-[2rem] border border-slate-200 shadow-sm">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="font-bold text-lg text-slate-800 flex items-center gap-2">
                                    <i class="ph-fill ph-clock-counter-clockwise text-emerald-500"></i> Setoran Terakhir
                                </h3>
                                <span x-show="userHistory.length > 0" class="text-[10px] font-bold bg-slate-100 text-slate-500 px-2 py-1 rounded-full uppercase tracking-wider">Terbaru</span>
                            </div>
                            
                            <div class="space-y-3">
                                <template x-for="item in userHistory.slice(0, 2)" :key="item.id">
                                    <div class="flex items-center justify-between p-4 bg-slate-50 rounded-2xl border border-slate-100 hover:bg-white hover:shadow-md transition duration-200">
                                        <div class="flex items-center gap-4">
                                            <div class="w-10 h-10 rounded-full flex items-center justify-center text-xl shrink-0" 
                                                 :class="item.status === 'Approved' ? 'bg-emerald-100 text-emerald-600' : 'bg-yellow-100 text-yellow-600'">
                                                <i :class="item.status === 'Approved' ? 'ph-bold ph-check' : 'ph-bold ph-hourglass'"></i>
                                            </div>
                                            <div>
                                                <div class="flex items-center gap-2 mb-0.5">
                                                    <p class="font-bold text-slate-800 text-sm" x-text="item.weight + ' Kg Sampah'"></p>
                                                    <span class="text-[9px] font-bold px-1.5 py-0.5 rounded-md" 
                                                          :class="item.status === 'Approved' ? 'bg-emerald-50 text-emerald-700' : 'bg-yellow-50 text-yellow-700'"
                                                          x-text="item.status === 'Approved' ? 'Sukses' : 'Proses'">
                                                    </span>
                                                </div>
                                                <p class="text-[10px] text-slate-500 flex items-center gap-1">
                                                    <i class="ph-bold ph-calendar-blank"></i> <span x-text="formatDate(item.date)"></span>
                                                </p>
                                            </div>
                                        </div>
                                        <div class="text-right shrink-0">
                                            <p class="font-black text-emerald-600 text-sm" x-text="'+' + item.xpReward"></p>
                                            <p class="text-[10px] font-bold text-emerald-400">XP</p>
                                        </div>
                                    </div>
                                </template>
                                
                                <div x-show="userHistory.length === 0" class="text-center py-8 text-slate-400 text-xs italic">
                                    Belum ada riwayat setoran. Ayo mulai setor sampah!
                                </div>

                                <button x-show="userHistory.length > 0" @click="setPage('history')" class="w-full mt-2 py-3.5 bg-slate-50 hover:bg-emerald-50 text-slate-600 hover:text-emerald-700 rounded-xl font-bold text-sm transition flex items-center justify-center gap-2 group border border-transparent hover:border-emerald-200">
                                    <span>Lihat Semua Riwayat</span>
                                    <i class="ph-bold ph-arrow-right group-hover:translate-x-1 transition-transform"></i>
                                </button>
                            </div>
                        </div>

                        <!-- NEW: Nearest Location Map Widget -->
                        <div class="lg:col-span-1 bg-white rounded-[2rem] border border-slate-200 shadow-sm overflow-hidden group">
                            <!-- Map Header -->
                            <div class="h-32 relative w-full bg-slate-100">
                                <!-- SAFE GUARD HERE -->
                                <iframe :src="nearestTpa.lat ? `https://maps.google.com/maps?q=${nearestTpa.lat},${nearestTpa.lng}&t=m&z=15&ie=UTF8&iwloc=&output=embed` : ''" width="100%" height="100%" frameborder="0" class="filter contrast-[1.05] grayscale-[0.1] opacity-80 group-hover:opacity-100 transition duration-500"></iframe>
                                <div class="absolute top-3 right-3 bg-white/90 backdrop-blur px-2 py-1 rounded-lg text-[10px] font-bold shadow-sm text-emerald-600 border border-emerald-100 flex items-center gap-1">
                                    <span class="w-1.5 h-1.5 bg-emerald-500 rounded-full animate-pulse"></span> Terdekat
                                </div>
                            </div>
                            
                            <!-- Content -->
                            <div class="p-5">
                                <div class="flex justify-between items-start mb-3">
                                    <div>
                                        <h3 class="font-bold text-slate-800 leading-tight" x-text="nearestTpa.nama"></h3>
                                        <p class="text-xs text-slate-500 mt-1" x-text="nearestTpa.alamat"></p>
                                    </div>
                                    <span class="bg-slate-100 text-slate-600 text-[10px] font-bold px-2 py-1 rounded-lg" x-text="nearestTpa.jarak"></span>
                                </div>
                                
                                <div class="grid grid-cols-2 gap-3 mt-4">
                                    <button @click="setPage('tpa')" class="py-2.5 rounded-xl border border-slate-200 text-slate-600 text-xs font-bold hover:bg-slate-50 transition">
                                        Lihat Peta
                                    </button>
                                    <button @click="selectTpa(1); openDepositModal()" class="py-2.5 rounded-xl bg-emerald-600 text-white text-xs font-bold hover:bg-emerald-700 transition shadow-lg shadow-emerald-200">
                                        Setor Disini
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div> 

                <!-- 2. BAG VIEW (DETAIL KANTONG) -->
                <div x-show="currentPage === 'bag'" x-transition.opacity.duration.300ms class="space-y-6 max-w-6xl mx-auto">
                    <div class="bg-white rounded-[2.5rem] p-8 md:p-10 shadow-sm border border-slate-100 relative overflow-hidden flex flex-col md:flex-row justify-between items-end gap-6">
                        <div class="relative z-10 w-full md:w-auto">
                            <button @click="setPage('home')" class="group flex items-center gap-2 text-slate-400 hover:text-slate-800 text-sm font-bold mb-6 transition-colors">
                                <i class="ph-bold ph-arrow-left group-hover:-translate-x-1 transition-transform"></i> Kembali
                            </button>
                            
                            <div class="space-y-1">
                                <p class="text-slate-400 font-bold uppercase tracking-widest text-[10px]">Total Akumulasi</p>
                                <div class="flex items-baseline gap-1">
                                    <h1 class="text-7xl md:text-8xl font-black text-slate-800 tracking-tighter" x-text="trashBag.weight"></h1>
                                    <span class="text-3xl font-bold text-slate-300">kg</span>
                                </div>
                            </div>
                        </div>

                        <div class="relative z-10 w-full md:w-auto flex flex-col items-end gap-4">
                            <div class="bg-emerald-50 text-emerald-600 border border-emerald-100 px-3 py-1.5 rounded-full flex items-center gap-2 shadow-sm">
                                <span class="relative flex h-2 w-2">
                                <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>
                                <span class="relative inline-flex rounded-full h-2 w-2 bg-emerald-500"></span>
                                </span>
                                <span class="text-[10px] font-bold uppercase tracking-wider">Live Update</span>
                            </div>

                            <div class="bg-gradient-to-br from-emerald-500 to-emerald-600 text-white p-6 md:p-8 rounded-[2rem] shadow-xl shadow-emerald-200/50 w-full md:w-64 relative overflow-hidden group">
                                <div class="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full blur-2xl -mr-10 -mt-10 transition-transform group-hover:scale-110"></div>
                                <div class="relative z-10">
                                    <p class="text-emerald-100 text-[10px] font-bold uppercase tracking-widest mb-1">Estimasi Reward</p>
                                    <div class="flex items-baseline gap-1 mb-3">
                                        <span class="text-lg font-medium text-emerald-200">+</span>
                                        <h2 class="text-5xl font-black tracking-tight" x-text="trashBag.potentialXP"></h2>
                                        <span class="text-sm font-bold text-emerald-100">XP</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 3. TPA/MAP VIEW (REDESIGNED) -->
                <div x-show="currentPage === 'tpa'" x-transition.opacity.duration.300ms class="h-[calc(100vh-140px)] md:h-[calc(100vh-120px)] flex flex-col lg:flex-row gap-4 max-w-7xl mx-auto overflow-hidden">
                    
                    <!-- LEFT SIDEBAR: LIST & SEARCH -->
                    <div class="w-full lg:w-96 flex flex-col gap-4 h-full shrink-0">
                        
                        <!-- Search & Status Header -->
                        <div class="bg-white p-4 rounded-3xl border border-slate-200 shadow-sm shrink-0 space-y-3">
                            <!-- Compact Trash Status -->
                            <div class="flex items-center justify-between bg-emerald-50 px-4 py-3 rounded-2xl border border-emerald-100" x-show="trashBag.weight > 0">
                                <div class="flex items-center gap-3">
                                    <div class="w-8 h-8 bg-emerald-500 rounded-full flex items-center justify-center text-white shadow-sm shadow-emerald-200">
                                        <i class="ph-bold ph-trash"></i>
                                    </div>
                                    <div>
                                        <p class="text-[10px] font-bold text-emerald-600 uppercase tracking-wider">Muatan</p>
                                        <p class="text-sm font-black text-slate-800"><span x-text="trashBag.weight"></span> Kg</p>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <p class="text-[10px] font-bold text-emerald-600 uppercase tracking-wider">Reward</p>
                                    <p class="text-sm font-black text-emerald-600">+<span x-text="trashBag.potentialXP"></span> XP</p>
                                </div>
                            </div>

                            <!-- Search Bar -->
                            <div class="relative group">
                                <i class="ph-bold ph-magnifying-glass absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-emerald-500 transition-colors"></i>
                                <input type="text" x-model="tpaSearch" placeholder="Cari SORTIQ point..." class="w-full pl-11 pr-4 py-3 bg-slate-50 rounded-xl text-sm outline-none focus:ring-2 focus:ring-emerald-500/20 border border-transparent focus:border-emerald-500 transition-all font-medium text-slate-700 placeholder:text-slate-400">
                            </div>
                        </div>

                        <!-- Scrollable List -->
                        <div class="flex-1 bg-white rounded-[2rem] border border-slate-200 shadow-sm overflow-hidden flex flex-col">
                            <div class="p-4 border-b border-slate-50">
                                <h3 class="font-bold text-slate-800 text-sm">Lokasi Terdekat</h3>
                            </div>
                            <div class="flex-1 overflow-y-auto p-2 space-y-2 no-scrollbar">
                                <template x-for="tpa in filteredTpa" :key="tpa.id">
                                    <button @click="selectTpa(tpa.id)" 
                                            :class="selectedTpaId === tpa.id ? 'bg-emerald-50 border-emerald-500 ring-1 ring-emerald-500 shadow-sm' : 'bg-white border-transparent hover:bg-slate-50'"
                                            class="w-full text-left p-3 rounded-2xl border transition-all duration-200 group relative overflow-hidden">
                                        
                                        <div class="flex justify-between items-start relative z-10">
                                            <div>
                                                <h4 :class="selectedTpaId === tpa.id ? 'text-emerald-900' : 'text-slate-800'" class="font-bold text-sm line-clamp-1" x-text="tpa.nama"></h4>
                                                <p class="text-[10px] text-slate-500 mt-0.5 line-clamp-1" x-text="tpa.alamat"></p>
                                            </div>
                                            <!-- Fullness Indicator -->
                                            <div class="flex flex-col items-end gap-1">
                                                <span class="text-[10px] font-bold px-2 py-1 rounded-lg shrink-0 bg-slate-100 text-slate-500" x-text="tpa.jarak"></span>
                                                <div class="flex items-center gap-1">
                                                    <span class="w-2 h-2 rounded-full" 
                                                          :class="tpa.fullness === 'low' ? 'bg-green-500' : (tpa.fullness === 'medium' ? 'bg-yellow-500' : 'bg-red-500')"></span>
                                                    <span class="text-[9px] font-bold uppercase" 
                                                          :class="tpa.fullness === 'low' ? 'text-green-600' : (tpa.fullness === 'medium' ? 'text-yellow-600' : 'text-red-600')"
                                                          x-text="tpa.fullness === 'low' ? 'Rendah' : (tpa.fullness === 'medium' ? 'Sedang' : 'Penuh')"></span>
                                                </div>
                                            </div>
                                        </div>
                                    </button>
                                </template>
                            </div>
                        </div>
                    </div>

                    <!-- RIGHT MAIN: MAP & FLOATING DETAILS -->
                    <div class="flex-1 bg-slate-200 rounded-[2rem] overflow-hidden relative shadow-inner isolate group">
                        
                        <!-- Map Layer -->
                        <div class="absolute inset-0 z-0">
                            <!-- SAFE GUARD HERE -->
                            <iframe :src="selectedTpa.lat ? `https://maps.google.com/maps?q=${selectedTpa.lat},${selectedTpa.lng}&t=m&z=${selectedTpa.zoom}&ie=UTF8&iwloc=&output=embed` : ''" width="100%" height="100%" frameborder="0" class="filter contrast-[1.05] grayscale-[0.1]"></iframe>
                        </div>

                        <!-- Top Overlay: Status -->
                        <div class="absolute top-4 left-4 right-4 flex justify-between items-start pointer-events-none z-10">
                            <div class="bg-white/90 backdrop-blur-md px-3 py-1.5 rounded-full shadow-sm border border-white flex items-center gap-2 pointer-events-auto">
                                <span class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></span>
                                <span class="text-[10px] font-black uppercase tracking-widest text-slate-700">Live View</span>
                            </div>
                            
                            <button @click="openGmaps()" class="bg-white/90 backdrop-blur-md w-10 h-10 rounded-full shadow-sm border border-white flex items-center justify-center hover:bg-white transition pointer-events-auto text-slate-600 hover:text-blue-600">
                                <i class="ph-bold ph-arrow-square-out text-lg"></i>
                            </button>
                        </div>

                        <!-- Bottom Floating Card: Details & Action -->
                        <div class="absolute bottom-4 left-4 right-4 z-20">
                            <template x-if="selectedTpa.id">
                                <div class="bg-white/95 backdrop-blur-xl p-5 rounded-[1.5rem] shadow-2xl border border-white/50 flex flex-col md:flex-row gap-5 items-center md:items-end transition-all duration-300 transform translate-y-0">
                                    <div class="flex-1 w-full text-center md:text-left">
                                        <div class="flex flex-col md:flex-row items-center md:items-start gap-3 mb-2">
                                            <h2 class="text-xl font-black text-slate-800 leading-tight" x-text="selectedTpa.nama"></h2>
                                            <span class="px-2 py-0.5 rounded-md text-[10px] font-bold uppercase tracking-widest shrink-0 border"
                                                :class="selectedTpa.fullness === 'low' ? 'bg-green-50 text-green-700 border-green-200' : (selectedTpa.fullness === 'medium' ? 'bg-yellow-50 text-yellow-700 border-yellow-200' : 'bg-red-50 text-red-700 border-red-200')">
                                                <span x-text="selectedTpa.fullness === 'low' ? 'Kapasitas Tersedia' : (selectedTpa.fullness === 'medium' ? 'Hampir Penuh' : 'Penuh')"></span>
                                            </span>
                                        </div>
                                        <p class="text-sm text-slate-500 font-medium leading-relaxed" x-text="selectedTpa.alamat"></p>
                                        
                                        <div class="flex items-center justify-center md:justify-start gap-4 mt-3">
                                            <div class="flex items-center gap-1.5 text-xs font-bold text-slate-400">
                                                <i class="ph-fill ph-clock"></i> 08:00 - 16:00
                                            </div>
                                        </div>
                                    </div>

                                    <div class="flex gap-3 w-full md:w-auto shrink-0">
                                        <button @click="openDepositModal()" 
                                                class="flex-1 md:flex-none bg-slate-900 hover:bg-emerald-600 text-white h-12 px-6 rounded-2xl font-bold flex items-center justify-center gap-2 shadow-lg hover:shadow-emerald-200 transition active:scale-95 border border-transparent" 
                                                :disabled="selectedTpa.fullness === 'high'"
                                                :class="selectedTpa.fullness === 'high' ? 'opacity-50 cursor-not-allowed bg-slate-400 hover:bg-slate-400' : ''">
                                            <span>Setor Di Sini</span>
                                            <i class="ph-bold ph-arrow-right"></i>
                                        </button>
                                    </div>
                                </div>
                            </template>
                        </div>

                    </div>
                </div>

                <!-- 4. PRICES VIEW -->
                <div x-show="currentPage === 'prices'" x-transition.opacity.duration.300ms class="max-w-6xl mx-auto pb-20">
                    <div class="mb-8 text-center md:text-left">
                        <h1 class="text-3xl font-bold text-slate-800 mb-2">Bursa Sampah Modern</h1>
                        <p class="text-slate-500">Pantau harga pasar sampah hari ini secara real-time.</p>
                        
                        <div class="mt-6 flex flex-wrap justify-center md:justify-start gap-3">
                            <template x-for="filter in ['Semua', 'Plastik', 'Kertas', 'Logam', 'Elektronik']">
                                <button @click="priceFilter = filter" 
                                        :class="priceFilter === filter ? 'bg-emerald-600 text-white shadow-lg shadow-emerald-200' : 'bg-white text-slate-600 border border-slate-200 hover:border-emerald-500'"
                                        class="px-5 py-2.5 rounded-xl font-medium transition text-sm">
                                    <span x-text="filter"></span>
                                </button>
                            </template>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-2 space-y-6">
                            
                            <div x-show="priceFilter === 'Semua' || priceFilter === 'Plastik'" class="bg-white/90 backdrop-blur-sm border border-slate-200 rounded-3xl p-8 hover:shadow-xl transition relative overflow-hidden group">
                                <div class="flex justify-between items-start mb-6 relative z-10">
                                    <div class="flex gap-5">
                                        <div class="w-16 h-16 bg-blue-50 rounded-2xl flex items-center justify-center text-blue-500 text-3xl"><i class="ph-fill ph-bottle"></i></div>
                                        <div>
                                            <h3 class="font-bold text-xl text-slate-800">Plastik PET</h3>
                                            <p class="text-xs text-slate-400 font-medium">Polyethylene Terephthalate</p>
                                            <span class="mt-2 inline-block px-2 py-0.5 bg-orange-100 text-orange-600 text-[10px] font-bold rounded uppercase tracking-tighter">üî• Hot Item</span>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-3xl font-black text-emerald-500">+50 XP/kg</div>
                                        <div class="flex items-center justify-end gap-1 text-emerald-500 font-bold animate-pulse">
                                            <i class="ph-bold ph-caret-up"></i><span class="text-[10px] uppercase">Trend Naik</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="h-16 w-full flex items-end gap-2 opacity-50">
                                    <div class="flex-1 bg-emerald-100 h-1/2 rounded-t-lg"></div>
                                    <div class="flex-1 bg-emerald-200 h-3/4 rounded-t-lg"></div>
                                    <div class="flex-1 bg-emerald-300 h-4/5 rounded-t-lg"></div>
                                    <div class="flex-1 bg-emerald-400 h-full rounded-t-lg"></div>
                                </div>
                            </div>
                        </div>

                        <div class="space-y-8">
                            <div class="bg-white rounded-3xl p-6 border border-slate-200 shadow-sm sticky top-24">
                                <h3 class="font-bold text-lg mb-4 flex items-center gap-2 text-slate-800">
                                    <i class="ph-duotone ph-calculator text-emerald-500 text-2xl"></i> Kalkulator Potensi
                                </h3>
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Jenis Sampah</label>
                                        <select x-model="calcType" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none text-sm font-bold text-slate-700">
                                            <option value="50">Plastik PET (+50 XP)</option>
                                            <option value="25">Kaleng Aluminium (+25 XP)</option>
                                            <option value="-10">Kertas Karton (-10 XP)</option>
                                            <option value="150">E-Waste (+150 XP)</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Berat (kg)</label>
                                        <input type="number" x-model="calcWeight" placeholder="0.0" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none text-sm font-bold">
                                    </div>
                                    <div class="p-4 bg-emerald-50 rounded-2xl border border-emerald-100 flex justify-between items-center">
                                        <span class="font-medium text-emerald-800 text-sm">Potensi:</span>
                                        <span class="text-xl font-black text-emerald-600" x-text="(calcWeight * calcType).toLocaleString('id-ID') + ' XP'"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 5. CHAT BOT VIEW -->
                <div x-show="currentPage === 'bot'" x-transition.opacity.duration.300ms class="h-[calc(100vh-160px)] md:h-[calc(100vh-180px)] flex flex-col bg-white rounded-[2rem] md:rounded-[2.5rem] border border-slate-200 shadow-lg overflow-hidden max-w-4xl mx-auto">
                    <div class="p-6 bg-white border-b border-slate-100 flex items-center gap-4">
                        <div class="w-12 h-12 bg-emerald-600 rounded-2xl flex items-center justify-center text-white shadow-lg"><i class="ph-bold ph-robot text-2xl"></i></div>
                        <div><h3 class="font-bold text-slate-800 text-lg">SORTIQ Assistant</h3><p class="text-[10px] text-green-500 font-bold flex items-center gap-1"><span class="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></span> AKTIF SEKARANG</p></div>
                    </div>
                    <div class="flex-1 bg-slate-50/50 p-6 overflow-y-auto space-y-6 no-scrollbar" id="chat-container">
                        <template x-for="msg in chatMessages" :key="msg.id">
                            <div :class="msg.sender === 'bot' ? 'flex justify-start' : 'flex justify-end'">
                                <div :class="msg.sender === 'bot' ? 'bg-white border border-slate-100 text-slate-700 rounded-tl-none' : 'bg-slate-900 text-white rounded-tr-none'" class="p-4 rounded-3xl shadow-sm max-w-[85%] text-sm leading-relaxed">
                                    <p x-html="msg.text"></p>
                                    <p class="text-[9px] mt-2 opacity-50 font-bold uppercase text-right" x-text="msg.time"></p>
                                </div>
                            </div>
                        </template>
                        <div x-show="isTyping" class="flex justify-start"><div class="bg-white border border-slate-100 p-4 rounded-3xl rounded-tl-none animate-pulse text-[10px] text-slate-400 font-bold tracking-widest">MENGETIK...</div></div>
                    </div>
                    <div class="p-6 bg-white border-t border-slate-100">
                        <form @submit.prevent="sendMessage" class="flex gap-3">
                            <input type="text" x-model="chatInput" placeholder="Tanya sesuatu..." class="flex-1 bg-slate-100 rounded-2xl px-5 py-4 text-sm outline-none focus:ring-2 focus:ring-emerald-500 transition">
                            <button type="submit" :disabled="!chatInput" class="bg-slate-900 text-white w-14 h-14 rounded-2xl flex items-center justify-center shadow-xl hover:bg-emerald-600 transition disabled:opacity-50"><i class="ph-bold ph-paper-plane-right text-xl"></i></button>
                        </form>
                    </div>
                </div>

                <!-- 6. ECO MARKET VIEW (UPDATED FOR REDEEM REWARDS) -->
                <div x-show="currentPage === 'market'" x-transition.opacity.duration.300ms class="max-w-6xl mx-auto">
                    <div class="flex justify-center mb-8">
                        <div class="bg-slate-100 p-1 rounded-2xl flex w-full md:w-auto">
                            <button @click="marketTab = 'redeem'" :class="marketTab === 'redeem' ? 'bg-white text-emerald-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'" class="flex-1 md:flex-none justify-center px-6 py-2.5 rounded-xl font-bold text-sm transition-all flex items-center gap-2"><i class="ph-bold ph-gift"></i> Tukar Poin</button>
                            <button @click="marketTab = 'shop'" :class="marketTab === 'shop' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'" class="flex-1 md:flex-none justify-center px-6 py-2.5 rounded-xl font-bold text-sm transition-all flex items-center gap-2"><i class="ph-bold ph-shopping-bag"></i> Toko Hijau</button>
                        </div>
                    </div>

                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <h2 class="text-2xl font-bold text-slate-800 tracking-tight" x-text="marketTab === 'redeem' ? 'Rewards Kamu' : 'Belanja Produk'"></h2>
                            <p class="text-sm text-slate-500 font-medium" x-text="marketTab === 'redeem' ? 'Gunakan poin XP untuk klaim hadiah.' : 'Produk ramah lingkungan terbaik.'"></p>
                        </div>
                        <div class="text-right" x-show="marketTab === 'redeem'">
                            <p class="text-[10px] font-bold text-slate-400 uppercase">Saldo Kamu</p>
                            <p class="text-xl font-black text-emerald-600" x-text="xp + ' XP'"></p>
                        </div>
                         <!-- VOUCHER SORTING DROPDOWN (Visible only in redeem tab and when Vouchers are shown) -->
                        <div x-show="marketTab === 'redeem'" class="relative" x-data="{ sortOpen: false }">
                             <button @click="sortOpen = !sortOpen" class="flex items-center gap-2 text-sm font-bold text-slate-600 bg-white border border-slate-200 px-4 py-2 rounded-xl hover:border-emerald-500 transition">
                                <i class="ph-bold ph-sort-ascending"></i> Sortir
                             </button>
                             <div x-show="sortOpen" @click.outside="sortOpen = false" class="absolute right-0 mt-2 w-40 bg-white rounded-xl shadow-xl border border-slate-100 overflow-hidden z-20">
                                 <button @click="voucherSort = 'lowest'; sortOpen = false" class="w-full text-left px-4 py-2.5 text-xs font-bold hover:bg-slate-50">Poin Terendah</button>
                                 <button @click="voucherSort = 'popular'; sortOpen = false" class="w-full text-left px-4 py-2.5 text-xs font-bold hover:bg-slate-50">Terpopuler</button>
                             </div>
                        </div>
                    </div>

                    <!-- REDEEM SECTION: DIGITAL SERVICES GRID -->
                    <div x-show="marketTab === 'redeem'" class="mb-8">
                        <h3 class="font-bold text-slate-800 mb-4 text-lg">Layanan Digital</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <!-- Pulsa Card -->
                            <button @click="openRedeemModal('pulsa')" class="bg-gradient-to-br from-red-500 to-red-600 p-6 rounded-[2rem] text-white relative overflow-hidden group shadow-lg hover:scale-[1.02] transition-transform text-left">
                                <div class="relative z-10">
                                    <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center text-2xl mb-4 backdrop-blur-sm"><i class="ph-bold ph-device-mobile"></i></div>
                                    <h4 class="font-bold text-lg">Pulsa & Data</h4>
                                    <p class="text-xs text-red-100 mt-1">Telkomsel, Indosat, XL, dll.</p>
                                </div>
                                <i class="ph-fill ph-device-mobile absolute -right-4 -bottom-4 text-9xl text-white/10 group-hover:scale-110 transition-transform duration-500"></i>
                            </button>

                            <!-- PLN Card -->
                            <button @click="openRedeemModal('pln')" class="bg-gradient-to-br from-yellow-400 to-orange-500 p-6 rounded-[2rem] text-white relative overflow-hidden group shadow-lg hover:scale-[1.02] transition-transform text-left">
                                <div class="relative z-10">
                                    <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center text-2xl mb-4 backdrop-blur-sm"><i class="ph-bold ph-lightning"></i></div>
                                    <h4 class="font-bold text-lg">Token Listrik</h4>
                                    <p class="text-xs text-yellow-100 mt-1">Prabayar & Pascabayar.</p>
                                </div>
                                <i class="ph-fill ph-lightning absolute -right-4 -bottom-4 text-9xl text-white/10 group-hover:scale-110 transition-transform duration-500"></i>
                            </button>

                            <!-- Withdraw Card -->
                            <button @click="openRedeemModal('withdraw')" class="bg-gradient-to-br from-emerald-500 to-teal-600 p-6 rounded-[2rem] text-white relative overflow-hidden group shadow-lg hover:scale-[1.02] transition-transform text-left">
                                <div class="relative z-10">
                                    <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center text-2xl mb-4 backdrop-blur-sm"><i class="ph-bold ph-money"></i></div>
                                    <h4 class="font-bold text-lg">Tarik Tunai</h4>
                                    <p class="text-xs text-emerald-100 mt-1">Transfer Bank & E-Wallet.</p>
                                </div>
                                <i class="ph-fill ph-wallet absolute -right-4 -bottom-4 text-9xl text-white/10 group-hover:scale-110 transition-transform duration-500"></i>
                            </button>
                        </div>
                    </div>

                    <!-- REDEEM SECTION: VOUCHERS GRID -->
                    <div x-show="marketTab === 'redeem'" class="mt-8">
                         <h3 class="font-bold text-slate-800 mb-4 text-lg">Katalog Voucher</h3>
                         <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                            <template x-for="item in sortedVouchers" :key="item.id">
                                <div class="bg-white p-5 rounded-[2rem] border border-slate-200 shadow-sm flex flex-col h-full hover:shadow-2xl hover:-translate-y-1 transition duration-300">
                                    <div :class="item.bgClass" class="h-40 rounded-[1.5rem] mb-4 flex items-center justify-center text-5xl shadow-inner relative overflow-hidden">
                                        <i :class="item.icon"></i>
                                    </div>
                                    <div class="flex-1 px-2">
                                        <h4 class="font-bold text-lg text-slate-800 leading-tight" x-text="item.name"></h4>
                                        <p class="text-xs text-slate-500 mt-1 mb-4 leading-relaxed line-clamp-2" x-text="item.desc"></p>
                                    </div>
                                    <div class="flex justify-between items-center pt-4 border-t border-slate-50 px-1">
                                        <span class="font-black text-slate-800 text-sm" x-text="item.cost"></span>
                                        <button @click="openVoucherModal(item)" class="bg-slate-900 text-white px-5 py-2 rounded-xl text-xs font-bold hover:bg-emerald-600 transition active:scale-95 shadow-lg shadow-slate-200">
                                            Klaim
                                        </button>
                                    </div>
                                </div>
                            </template>
                         </div>
                    </div>

                    <!-- SHOP TAB GRID (Existing) -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6" x-show="marketTab === 'shop'">
                        <template x-for="item in marketItems" :key="item.id">
                            <div x-show="item.category === 'shop'" class="bg-white p-5 rounded-[2rem] border border-slate-200 shadow-sm flex flex-col h-full hover:shadow-2xl hover:-translate-y-1 transition duration-300">
                                <div :class="item.bgClass" class="h-40 rounded-[1.5rem] mb-4 flex items-center justify-center text-5xl shadow-inner relative overflow-hidden">
                                    <i :class="item.icon"></i>
                                    <div x-show="item.type === 'money'" class="absolute top-3 right-3 bg-white/50 backdrop-blur-sm px-2 py-1 rounded-lg text-[10px] font-bold uppercase tracking-widest text-slate-600 border border-white/20">Beli</div>
                                </div>
                                <div class="flex-1 px-2">
                                    <h4 class="font-bold text-lg text-slate-800 leading-tight" x-text="item.name"></h4>
                                    <p class="text-xs text-slate-500 mt-1 mb-4 leading-relaxed line-clamp-2" x-text="item.desc"></p>
                                </div>
                                <div class="flex justify-between items-center pt-4 border-t border-slate-50 px-1">
                                    <span class="font-black text-slate-800 text-sm" x-text="item.cost"></span>
                                    <div class="flex gap-2">
                                        <button x-show="item.category === 'shop'" @click="addToCart(item)" class="bg-slate-100 text-slate-600 w-10 h-10 rounded-xl flex items-center justify-center hover:bg-slate-200 transition group/cart">
                                            <i class="ph-bold ph-shopping-cart group-hover/cart:text-emerald-600"></i>
                                        </button>
                                        <button @click="openProductModal(item)" class="bg-slate-900 text-white px-5 py-2 rounded-xl text-xs font-bold hover:bg-emerald-600 transition active:scale-95 shadow-lg shadow-slate-200">
                                            Lihat
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- 7. ORDERS, 8. HISTORY, 9. ACCOUNT, 10. TRACKING views kept same ... -->
                 <div x-show="currentPage === 'orders'" x-transition.opacity.duration.300ms class="max-w-3xl mx-auto">
                    <!-- ... Orders Content ... -->
                    <div class="text-center mb-8">
                        <div class="w-16 h-16 bg-blue-100 rounded-3xl mx-auto flex items-center justify-center text-blue-600 text-3xl mb-3 shadow-sm"><i class="ph-duotone ph-receipt"></i></div>
                        <h2 class="text-2xl font-black text-slate-900 tracking-tight">Riwayat Transaksi</h2>
                        <p class="text-slate-500 mt-1 font-medium text-sm">Semua aktivitas belanja dan penukaran poinmu.</p>
                    </div>

                    <div class="flex justify-center mb-6">
                        <div class="bg-white p-1.5 rounded-2xl border border-slate-200 shadow-sm inline-flex">
                            <button @click="historyFilter = 'all'" :class="historyFilter === 'all' ? 'bg-slate-900 text-white shadow-md' : 'text-slate-500 hover:bg-slate-50'" class="px-4 py-2 rounded-xl text-xs font-bold transition">Semua</button>
                            <button @click="historyFilter = 'shop'" :class="historyFilter === 'shop' ? 'bg-blue-600 text-white shadow-md' : 'text-slate-500 hover:bg-slate-50'" class="px-4 py-2 rounded-xl text-xs font-bold transition">Pesanan</button>
                            <button @click="historyFilter = 'redeem'" :class="historyFilter === 'redeem' ? 'bg-purple-600 text-white shadow-md' : 'text-slate-500 hover:bg-slate-50'" class="px-4 py-2 rounded-xl text-xs font-bold transition">Tukar Poin</button>
                            <button @click="historyFilter = 'withdraw'" :class="historyFilter === 'withdraw' ? 'bg-emerald-600 text-white shadow-md' : 'text-slate-500 hover:bg-slate-50'" class="px-4 py-2 rounded-xl text-xs font-bold transition">Withdraw</button>
                        </div>
                    </div>

                    <div class="bg-white rounded-[2rem] border border-slate-200 shadow-sm overflow-hidden">
                        <div class="p-1">
                            <template x-for="order in filteredOrders" :key="order.id">
                                <div class="p-5 border-b border-slate-50 last:border-0 hover:bg-slate-50 transition flex items-center justify-between group">
                                    <div class="flex items-center gap-4">
                                        <div class="w-12 h-12 rounded-2xl flex items-center justify-center text-xl shadow-sm transition-transform group-hover:scale-105" 
                                             :class="order.itemType === 'xp' ? (order.itemName.toLowerCase().includes('voucher') ? 'bg-purple-100 text-purple-600' : 'bg-emerald-100 text-emerald-600') : 'bg-blue-100 text-blue-600'">
                                            <i :class="order.itemType === 'xp' ? (order.itemName.toLowerCase().includes('voucher') ? 'ph-bold ph-gift' : 'ph-bold ph-money') : 'ph-bold ph-shopping-bag'"></i>
                                        </div>
                                        <div>
                                            <div class="flex items-center gap-2 mb-1">
                                                <h4 class="font-bold text-slate-800" x-text="order.itemName"></h4>
                                                <span class="text-[10px] font-bold px-2 py-0.5 rounded-md uppercase tracking-wider" 
                                                      :class="order.status === 'Selesai' ? 'bg-emerald-100 text-emerald-700' : (order.status === 'Dalam Pengiriman' ? 'bg-blue-100 text-blue-700' : 'bg-slate-100 text-slate-600')"
                                                      x-text="order.status">
                                                </span>
                                            </div>
                                            <p class="text-xs text-slate-500 font-medium flex items-center gap-1.5">
                                                <span x-text="order.shippingMethod === 'pickup' ? 'Ambil Sendiri' : (order.itemName.toLowerCase().includes('voucher') ? 'Digital' : 'Kurir')"></span>
                                                <span class="text-slate-300">‚Ä¢</span>
                                                <span x-text="formatDate(order.date)"></span>
                                            </p>
                                        </div>
                                    </div>
                                    <div class="flex items-center gap-3">
                                        <div class="text-right">
                                            <p class="font-black text-sm" :class="order.itemType === 'xp' ? 'text-purple-600' : 'text-slate-800'" x-text="order.costDisplay"></p>
                                        </div>
                                        <!-- TRACKING BUTTON -->
                                        <button x-show="order.status === 'Dalam Pengiriman' || (order.shippingMethod === 'delivery' && order.status !== 'Selesai')" 
                                                @click="trackOrder(order)" 
                                                class="bg-blue-600 text-white px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-blue-700 shadow-sm flex items-center gap-1">
                                            <i class="ph-bold ph-moped"></i> Pantau
                                        </button>
                                    </div>
                                </div>
                            </template>
                             <div x-show="filteredOrders.length === 0" class="text-center py-12">
                                <div class="w-16 h-16 bg-slate-50 rounded-full mx-auto mb-4 flex items-center justify-center text-3xl text-slate-300"><i class="ph-duotone ph-list-magnifying-glass"></i></div>
                                <h3 class="font-bold text-slate-600 text-sm">Tidak ada transaksi</h3>
                                <p class="text-xs text-slate-400 mt-1">Belum ada riwayat untuk kategori ini.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div x-show="currentPage === 'history'" x-transition.opacity.duration.300ms class="max-w-2xl mx-auto min-h-screen">
                    <!-- ... History Content ... -->
                     <div class="flex items-center gap-4 mb-6">
                        <button @click="setPage('home')" class="w-10 h-10 rounded-xl bg-white border border-slate-200 flex items-center justify-center hover:bg-slate-50 transition shadow-sm text-slate-600">
                            <i class="ph-bold ph-arrow-left text-lg"></i>
                        </button>
                        <div>
                            <h2 class="text-2xl font-bold text-slate-800">Riwayat Lengkap</h2>
                            <p class="text-sm text-slate-500">Semua aktivitas setoran sampahmu.</p>
                        </div>
                    </div>

                    <div class="bg-white rounded-[2rem] border border-slate-200 shadow-sm overflow-hidden">
                        <div class="p-1">
                            <template x-for="item in userHistory" :key="item.id">
                                <div class="p-5 border-b border-slate-50 last:border-0 hover:bg-slate-50 transition flex items-center justify-between group">
                                    <div class="flex items-center gap-4">
                                        <div class="w-12 h-12 rounded-2xl flex items-center justify-center text-xl shadow-sm transition-transform group-hover:scale-105" 
                                             :class="item.status === 'Approved' ? 'bg-emerald-100 text-emerald-600' : 'bg-yellow-100 text-yellow-600'">
                                            <i :class="item.status === 'Approved' ? 'ph-bold ph-check' : 'ph-bold ph-hourglass'"></i>
                                        </div>
                                        <div>
                                            <div class="flex items-center gap-2 mb-1">
                                                <h4 class="font-bold text-slate-800" x-text="item.weight + ' Kg Sampah'"></h4>
                                                <span class="text-[10px] font-bold px-2 py-0.5 rounded-md uppercase tracking-wider" 
                                                      :class="item.status === 'Approved' ? 'bg-emerald-50 text-emerald-700' : 'bg-yellow-50 text-yellow-700'"
                                                      x-text="item.status === 'Approved' ? 'Selesai' : 'Pending'">
                                                </span>
                                            </div>
                                            <p class="text-xs text-slate-500 font-medium flex items-center gap-1.5">
                                                <i class="ph-fill ph-calendar text-slate-400"></i> <span x-text="formatDate(item.date)"></span>
                                            </p>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <p class="font-black text-lg text-emerald-600" x-text="'+' + item.xpReward"></p>
                                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Poin XP</p>
                                    </div>
                                </div>
                            </template>
                             <div x-show="userHistory.length === 0" class="text-center py-12">
                                <div class="w-20 h-20 bg-slate-100 rounded-full mx-auto mb-4 flex items-center justify-center text-3xl text-slate-400"><i class="ph-duotone ph-list-dashes"></i></div>
                                <h3 class="font-bold text-slate-600">Belum Ada Riwayat</h3>
                                <p class="text-sm text-slate-400 mt-1">Lakukan setoran pertamamu sekarang!</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div x-show="currentPage === 'account'" x-transition.opacity.duration.300ms class="max-w-4xl mx-auto space-y-6">
                    <!-- ... Account Content ... -->
                     <div class="bg-white rounded-[2rem] p-6 border border-slate-200 shadow-sm flex flex-col md:flex-row items-center gap-6">
                        <div class="relative group">
                            <img :src="`https://ui-avatars.com/api/?name=${username}&background=10b981&color=fff&size=128`" class="w-24 h-24 rounded-full border-4 border-emerald-100 shadow-sm">
                            <button class="absolute bottom-0 right-0 bg-slate-900 text-white w-8 h-8 rounded-full flex items-center justify-center shadow-lg hover:scale-110 transition">
                                <i class="ph-bold ph-camera"></i>
                            </button>
                        </div>
                        <div class="text-center md:text-left flex-1">
                            <h2 class="text-2xl font-black text-slate-900" x-text="username"></h2>
                            <p class="text-slate-500 text-sm mb-4" x-text="email || 'Belum ada email'"></p>
                            <div class="flex justify-center md:justify-start gap-3">
                                <span class="bg-emerald-100 text-emerald-700 px-3 py-1 rounded-lg text-xs font-bold flex items-center gap-1"><i class="ph-fill ph-star"></i> Member</span>
                                <span class="bg-slate-100 text-slate-600 px-3 py-1 rounded-lg text-xs font-bold" x-text="xp + ' XP'"></span>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Left Column: Menu -->
                        <div class="space-y-6">
                            <!-- Personal Info -->
                            <div class="bg-white rounded-[2rem] p-6 border border-slate-200 shadow-sm">
                                <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2"><i class="ph-bold ph-user"></i> Informasi Pribadi</h3>
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Nama Lengkap</label>
                                        <input type="text" x-model="username" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-2.5 text-sm font-medium focus:ring-2 focus:ring-emerald-500 outline-none">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Email</label>
                                        <input type="email" x-model="email" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-2.5 text-sm font-medium focus:ring-2 focus:ring-emerald-500 outline-none">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Nomor Telepon</label>
                                        <input type="text" x-model="phone" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-2.5 text-sm font-medium focus:ring-2 focus:ring-emerald-500 outline-none">
                                    </div>
                                    <button class="w-full bg-slate-900 text-white py-2.5 rounded-xl text-xs font-bold hover:bg-slate-800 transition">Simpan Perubahan</button>
                                </div>
                            </div>

                            <!-- Security -->
                            <div class="bg-white rounded-[2rem] p-6 border border-slate-200 shadow-sm">
                                <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2"><i class="ph-bold ph-shield-check"></i> Keamanan</h3>
                                <div class="space-y-3">
                                    <button class="w-full flex items-center justify-between p-3 rounded-xl hover:bg-slate-50 border border-transparent hover:border-slate-100 transition group">
                                        <span class="text-sm font-medium text-slate-600">Ubah Kata Sandi</span>
                                        <i class="ph-bold ph-caret-right text-slate-400 group-hover:text-slate-600"></i>
                                    </button>
                                    <div class="flex items-center justify-between p-3">
                                        <span class="text-sm font-medium text-slate-600">Autentikasi 2 Faktor</span>
                                        <div class="relative inline-flex h-6 w-11 items-center rounded-full bg-slate-200">
                                            <span class="translate-x-1 inline-block h-4 w-4 transform rounded-full bg-white transition"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Right Column: Orders & Payment -->
                        <div class="lg:col-span-2 space-y-6">
                            <!-- Payment Methods -->
                            <div class="bg-white rounded-[2rem] p-6 border border-slate-200 shadow-sm">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="font-bold text-slate-800 flex items-center gap-2"><i class="ph-bold ph-credit-card"></i> Metode Pembayaran</h3>
                                    <button @click="showAddPaymentModal = true" class="text-xs font-bold text-emerald-600 hover:underline">+ Tambah Baru</button>
                                </div>
                                
                                <div class="space-y-3">
                                    <!-- Saved Cards List -->
                                    <template x-for="(card, index) in paymentMethods" :key="index">
                                        <div class="flex items-center justify-between p-4 bg-slate-50 rounded-xl border border-slate-200 group">
                                            <div class="flex items-center gap-4">
                                                <div class="w-12 h-8 bg-blue-600 rounded-md shadow-sm relative overflow-hidden flex items-center justify-center text-white text-[10px] font-bold tracking-widest">
                                                    <div class="absolute top-0 right-0 w-6 h-6 bg-white/20 rounded-full -mr-2 -mt-2"></div>
                                                    <span x-text="card.type">VISA</span>
                                                </div>
                                                <div>
                                                    <p class="text-sm font-bold text-slate-800" x-text="card.name"></p>
                                                    <p class="text-xs text-slate-500 font-mono" x-text="'‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ' + card.last4"></p>
                                                </div>
                                            </div>
                                            <button class="text-slate-400 hover:text-red-500 p-2 opacity-0 group-hover:opacity-100 transition"><i class="ph-bold ph-trash"></i></button>
                                        </div>
                                    </template>
                                </div>
                            </div>

                            <!-- My Recent Orders (Embedded) -->
                            <div class="bg-white rounded-[2rem] p-6 border border-slate-200 shadow-sm">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="font-bold text-slate-800 flex items-center gap-2"><i class="ph-bold ph-package"></i> Pesanan Saya</h3>
                                    <button @click="setPage('orders')" class="text-xs font-bold text-slate-500 hover:text-slate-800">Lihat Semua</button>
                                </div>
                                <div class="space-y-3">
                                    <template x-for="order in marketOrders.slice(0,3)" :key="order.id">
                                        <div class="flex items-center justify-between p-3 rounded-xl hover:bg-slate-50 transition border border-transparent hover:border-slate-100">
                                            <div class="flex items-center gap-3">
                                                <div class="w-10 h-10 bg-white rounded-lg border border-slate-200 flex items-center justify-center text-lg text-slate-500">
                                                    <i :class="order.itemType === 'xp' ? 'ph-bold ph-gift' : 'ph-bold ph-shopping-bag'"></i>
                                                </div>
                                                <div>
                                                    <p class="text-sm font-bold text-slate-800" x-text="order.itemName"></p>
                                                    <p class="text-[10px] text-slate-500" x-text="formatDate(order.date)"></p>
                                                </div>
                                            </div>
                                            <span class="text-[10px] font-bold px-2 py-1 rounded-md bg-emerald-50 text-emerald-700" x-text="order.status"></span>
                                        </div>
                                    </template>
                                    <div x-show="marketOrders.length === 0" class="text-center py-6 text-slate-400 text-xs italic">Belum ada pesanan.</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 10. NEW: TRACKING PAGE -->
                <div x-show="currentPage === 'tracking'" x-transition.opacity.duration.300ms class="max-w-4xl mx-auto h-[calc(100vh-100px)] flex flex-col md:flex-row gap-6 overflow-hidden">
                    <div class="flex-1 bg-slate-200 rounded-[2rem] overflow-hidden relative shadow-inner isolate group">
                        <iframe src="https://maps.google.com/maps?q=-7.289166,112.756549&t=m&z=15&ie=UTF8&iwloc=&output=embed" width="100%" height="100%" frameborder="0" class="filter contrast-[1.05] grayscale-[0.1]"></iframe>
                        <button @click="setPage('orders')" class="absolute top-4 left-4 bg-white/90 backdrop-blur-md w-10 h-10 rounded-full shadow-sm flex items-center justify-center hover:bg-white transition text-slate-600"><i class="ph-bold ph-arrow-left"></i></button>
                    </div>
                    <div class="w-full md:w-96 bg-white rounded-[2rem] p-6 border border-slate-200 shadow-sm flex flex-col gap-6 overflow-y-auto">
                        <div class="text-center">
                            <h2 class="text-xl font-black text-slate-800">Lacak Pengiriman</h2>
                            <p class="text-xs text-slate-500 font-medium mt-1">Estimasi tiba: <span class="text-emerald-600 font-bold">15 Menit</span></p>
                        </div>
                        
                        <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100 flex items-center gap-4">
                            <div class="relative">
                                <img src="https://ui-avatars.com/api/?name=Budi+Santoso&background=random" class="w-14 h-14 rounded-full border-2 border-white shadow-sm">
                                <div class="absolute -bottom-1 -right-1 bg-emerald-500 text-white text-[10px] px-1.5 rounded-full border-2 border-white font-bold">4.9‚òÖ</div>
                            </div>
                            <div class="flex-1">
                                <h4 class="font-bold text-slate-900">Budi Santoso</h4>
                                <p class="text-xs text-slate-500">Honda Beat ‚Ä¢ L 1234 XY</p>
                            </div>
                            <div class="flex gap-2">
                                <button class="w-9 h-9 rounded-full bg-white border border-slate-200 flex items-center justify-center text-blue-500 hover:bg-blue-50 hover:border-blue-200 transition"><i class="ph-fill ph-phone"></i></button>
                                <button class="w-9 h-9 rounded-full bg-white border border-slate-200 flex items-center justify-center text-emerald-500 hover:bg-emerald-50 hover:border-emerald-200 transition"><i class="ph-fill ph-chat-circle-dots"></i></button>
                            </div>
                        </div>

                        <div class="space-y-4 flex-1">
                            <h4 class="font-bold text-slate-800 text-sm uppercase tracking-wider border-b border-slate-100 pb-2">Status Pesanan</h4>
                            <div class="relative pl-6 space-y-6 before:content-[''] before:absolute before:left-2 before:top-2 before:bottom-2 before:w-0.5 before:bg-slate-200">
                                <div class="relative">
                                    <div class="absolute -left-6 top-1 w-4 h-4 rounded-full bg-emerald-500 border-2 border-white shadow-sm z-10 animate-pulse"></div>
                                    <p class="text-sm font-bold text-slate-800">Kurir Menuju Lokasi</p>
                                    <p class="text-[10px] text-slate-400">12:45 PM ‚Ä¢ Posisi saat ini di Jl. Dharmawangsa</p>
                                </div>
                                <div class="relative">
                                    <div class="absolute -left-6 top-1 w-4 h-4 rounded-full bg-slate-300 border-2 border-white z-10"></div>
                                    <p class="text-sm font-bold text-slate-400">Pesanan Diproses</p>
                                    <p class="text-[10px] text-slate-400">12:30 PM ‚Ä¢ Pesanan dikemas oleh penjual</p>
                                </div>
                                <div class="relative">
                                    <div class="absolute -left-6 top-1 w-4 h-4 rounded-full bg-slate-300 border-2 border-white z-10"></div>
                                    <p class="text-sm font-bold text-slate-400">Pesanan Diterima</p>
                                    <p class="text-[10px] text-slate-400">12:28 PM ‚Ä¢ Pembayaran berhasil diverifikasi</p>
                                </div>
                            </div>
                        </div>

                        <div class="pt-4 border-t border-slate-100">
                            <h4 class="font-bold text-slate-800 text-sm mb-2">Ringkasan</h4>
                            <div class="flex justify-between items-center text-sm mb-1">
                                <span class="text-slate-500" x-text="selectedOrder?.itemName || 'Paket Belanja'"></span>
                                <span class="font-bold text-slate-800" x-text="selectedOrder?.costDisplay || '-'"></span>
                            </div>
                            <div class="flex justify-between items-center text-xs text-slate-400">
                                <span>Ongkos Kirim</span>
                                <span>Rp 10.000</span>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- === NEW: REDEEM SERVICE MODAL === -->
    <div x-show="showRedeemModal" class="fixed inset-0 z-50 flex items-center justify-center px-4" style="display: none;">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" @click="showRedeemModal = false"></div>
        <div class="bg-white w-full max-w-sm rounded-[2rem] shadow-2xl relative z-10 overflow-hidden">
             <!-- Modal Header -->
            <div class="p-6 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center">
                <h3 class="font-bold text-slate-800 text-lg" x-text="redeemType === 'pulsa' ? 'Isi Pulsa' : (redeemType === 'pln' ? 'Token Listrik' : 'Tarik Tunai')"></h3>
                <button @click="showRedeemModal = false" class="w-8 h-8 rounded-full bg-slate-200 flex items-center justify-center hover:bg-slate-300 transition"><i class="ph-bold ph-x text-slate-600"></i></button>
            </div>
            
            <div class="p-6 space-y-4">
                <!-- STEP 1: INPUT -->
                <div x-show="redeemStep === 1">
                    <!-- Pulsa Form -->
                    <template x-if="redeemType === 'pulsa'">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Nomor Handphone</label>
                                <div class="relative">
                                     <input type="text" x-model="redeemData.phoneNumber" class="w-full bg-slate-50 border border-slate-200 rounded-xl pl-10 pr-4 py-3 text-sm font-bold focus:ring-2 focus:ring-emerald-500 outline-none" placeholder="08xx xxxx xxxx">
                                     <i class="ph-bold ph-phone absolute left-3 top-3.5 text-slate-400"></i>
                                </div>
                                <p class="text-[10px] text-emerald-600 font-bold mt-1" x-show="redeemData.phoneNumber.length > 9">‚úÖ Provider terdeteksi: Telkomsel</p>
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <button @click="redeemData.nominal = 5000; redeemData.cost = 500" :class="redeemData.nominal === 5000 ? 'bg-emerald-50 border-emerald-500 text-emerald-700' : 'border-slate-200'" class="border-2 rounded-xl p-3 text-center transition">
                                    <p class="font-bold text-sm">5.000</p>
                                    <p class="text-xs text-slate-500">500 XP</p>
                                </button>
                                <button @click="redeemData.nominal = 10000; redeemData.cost = 1000" :class="redeemData.nominal === 10000 ? 'bg-emerald-50 border-emerald-500 text-emerald-700' : 'border-slate-200'" class="border-2 rounded-xl p-3 text-center transition">
                                    <p class="font-bold text-sm">10.000</p>
                                    <p class="text-xs text-slate-500">1.000 XP</p>
                                </button>
                                <button @click="redeemData.nominal = 25000; redeemData.cost = 2500" :class="redeemData.nominal === 25000 ? 'bg-emerald-50 border-emerald-500 text-emerald-700' : 'border-slate-200'" class="border-2 rounded-xl p-3 text-center transition">
                                    <p class="font-bold text-sm">25.000</p>
                                    <p class="text-xs text-slate-500">2.500 XP</p>
                                </button>
                                <button @click="redeemData.nominal = 50000; redeemData.cost = 5000" :class="redeemData.nominal === 50000 ? 'bg-emerald-50 border-emerald-500 text-emerald-700' : 'border-slate-200'" class="border-2 rounded-xl p-3 text-center transition">
                                    <p class="font-bold text-sm">50.000</p>
                                    <p class="text-xs text-slate-500">5.000 XP</p>
                                </button>
                            </div>
                        </div>
                    </template>

                    <!-- PLN Form -->
                    <template x-if="redeemType === 'pln'">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-xs font-bold text-slate-400 uppercase mb-1">ID Pelanggan / No. Meter</label>
                                <div class="flex gap-2">
                                    <input type="text" x-model="redeemData.customerId" class="flex-1 bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-sm font-bold focus:ring-2 focus:ring-emerald-500 outline-none" placeholder="1234567890">
                                    <button @click="processInquiry()" class="bg-blue-100 text-blue-600 px-4 rounded-xl font-bold text-xs hover:bg-blue-200 transition">Cek</button>
                                </div>
                                <p x-show="inquiryResult" class="text-[10px] bg-slate-100 p-2 rounded-lg mt-2 text-slate-600">
                                    <span class="font-bold text-slate-800" x-text="inquiryResult"></span>
                                </p>
                            </div>
                             <div class="grid grid-cols-2 gap-3" x-show="inquiryResult">
                                <button @click="redeemData.nominal = 20000; redeemData.cost = 2500" :class="redeemData.nominal === 20000 ? 'bg-emerald-50 border-emerald-500 text-emerald-700' : 'border-slate-200'" class="border-2 rounded-xl p-3 text-center transition">
                                    <p class="font-bold text-sm">20.000</p>
                                    <p class="text-xs text-slate-500">2.500 XP</p>
                                </button>
                                <button @click="redeemData.nominal = 50000; redeemData.cost = 6000" :class="redeemData.nominal === 50000 ? 'bg-emerald-50 border-emerald-500 text-emerald-700' : 'border-slate-200'" class="border-2 rounded-xl p-3 text-center transition">
                                    <p class="font-bold text-sm">50.000</p>
                                    <p class="text-xs text-slate-500">6.000 XP</p>
                                </button>
                            </div>
                        </div>
                    </template>

                    <!-- Withdraw Form -->
                    <template x-if="redeemType === 'withdraw'">
                        <div class="space-y-4">
                            <div class="grid grid-cols-2 gap-3 mb-2">
                                <button @click="redeemData.bank = 'BCA'" :class="redeemData.bank === 'BCA' ? 'border-emerald-500 bg-emerald-50' : 'border-slate-200'" class="border-2 rounded-xl py-2 font-bold text-xs text-slate-600">BCA</button>
                                <button @click="redeemData.bank = 'Mandiri'" :class="redeemData.bank === 'Mandiri' ? 'border-emerald-500 bg-emerald-50' : 'border-slate-200'" class="border-2 rounded-xl py-2 font-bold text-xs text-slate-600">Mandiri</button>
                                <button @click="redeemData.bank = 'Gopay'" :class="redeemData.bank === 'Gopay' ? 'border-emerald-500 bg-emerald-50' : 'border-slate-200'" class="border-2 rounded-xl py-2 font-bold text-xs text-slate-600">Gopay</button>
                                <button @click="redeemData.bank = 'OVO'" :class="redeemData.bank === 'OVO' ? 'border-emerald-500 bg-emerald-50' : 'border-slate-200'" class="border-2 rounded-xl py-2 font-bold text-xs text-slate-600">OVO</button>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Nomor Rekening/HP</label>
                                <div class="flex gap-2">
                                    <input type="text" x-model="redeemData.accountNumber" class="flex-1 bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-sm font-bold focus:ring-2 focus:ring-emerald-500 outline-none">
                                    <button @click="processInquiry()" class="bg-blue-100 text-blue-600 px-4 rounded-xl font-bold text-xs hover:bg-blue-200 transition">Cek</button>
                                </div>
                                <p x-show="inquiryResult" class="text-[10px] text-green-600 font-bold mt-1">‚úì <span x-text="inquiryResult"></span></p>
                            </div>
                             <div class="grid grid-cols-2 gap-3" x-show="inquiryResult">
                                <button @click="redeemData.nominal = 10000; redeemData.cost = 1500" :class="redeemData.nominal === 10000 ? 'bg-emerald-50 border-emerald-500 text-emerald-700' : 'border-slate-200'" class="border-2 rounded-xl p-3 text-center transition">
                                    <p class="font-bold text-sm">Rp 10.000</p>
                                    <p class="text-xs text-slate-500">1.500 XP</p>
                                </button>
                                <button @click="redeemData.nominal = 50000; redeemData.cost = 6500" :class="redeemData.nominal === 50000 ? 'bg-emerald-50 border-emerald-500 text-emerald-700' : 'border-slate-200'" class="border-2 rounded-xl p-3 text-center transition">
                                    <p class="font-bold text-sm">Rp 50.000</p>
                                    <p class="text-xs text-slate-500">6.500 XP</p>
                                </button>
                            </div>
                        </div>
                    </template>

                    <div class="mt-6 pt-4 border-t border-slate-100">
                        <button @click="confirmRedemption()" :disabled="!redeemData.nominal || xp < redeemData.cost" class="w-full bg-slate-900 text-white py-3.5 rounded-xl font-bold shadow-lg hover:bg-emerald-600 transition disabled:opacity-50 disabled:cursor-not-allowed">
                            <span x-text="xp < redeemData.cost ? 'Poin Tidak Cukup' : 'Tukar Sekarang'"></span>
                        </button>
                    </div>
                </div>

                <!-- STEP 2: PIN Verification -->
                <div x-show="redeemStep === 2">
                    <div class="text-center">
                        <div class="w-16 h-16 bg-slate-100 rounded-full mx-auto mb-4 flex items-center justify-center text-2xl text-slate-500"><i class="ph-bold ph-lock-key"></i></div>
                        <h3 class="font-bold text-slate-800">Verifikasi Keamanan</h3>
                        <p class="text-xs text-slate-500 mt-1 mb-6">Masukkan PIN transaksi Anda.</p>
                        <input type="password" maxlength="6" class="w-3/4 mx-auto bg-slate-50 border border-slate-300 rounded-xl px-4 py-3 text-center text-xl font-bold tracking-[0.5em] focus:ring-2 focus:ring-emerald-500 outline-none mb-6" placeholder="******">
                        <button @click="executeRedemption()" class="w-full bg-emerald-600 text-white py-3.5 rounded-xl font-bold shadow-lg">Konfirmasi</button>
                    </div>
                </div>

                 <!-- STEP 3: Success -->
                <div x-show="redeemStep === 3" class="text-center">
                    <div class="w-20 h-20 bg-emerald-100 rounded-full mx-auto mb-4 flex items-center justify-center text-4xl text-emerald-600 animate-[bounce_1s]"><i class="ph-fill ph-check-circle"></i></div>
                    <h3 class="text-xl font-bold text-emerald-700 mb-1">Transaksi Berhasil!</h3>
                    <p class="text-sm text-slate-500 mb-6">Permintaan Anda sedang diproses.</p>
                    
                    <template x-if="redeemType === 'pln'">
                         <div class="bg-slate-100 p-4 rounded-xl border border-slate-200 mb-4">
                            <p class="text-xs text-slate-500 uppercase font-bold mb-1">Kode Token</p>
                            <div class="flex items-center justify-between">
                                <span class="font-mono text-lg font-bold text-slate-800">4123 5678 9012 3456</span>
                                <button @click="alert('Tersalin!')" class="text-blue-600 font-bold text-xs"><i class="ph-bold ph-copy"></i> Salin</button>
                            </div>
                        </div>
                    </template>

                    <button @click="showRedeemModal = false" class="w-full bg-slate-100 text-slate-600 py-3.5 rounded-xl font-bold hover:bg-slate-200 transition">Tutup</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals (Add Payment, Cart, Deposit, Product, Payment) kept same ... -->
    <div x-show="showAddPaymentModal" class="fixed inset-0 z-50 flex items-center justify-center px-4" style="display: none;">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" @click="showAddPaymentModal = false"></div>
        <div class="bg-white w-full max-w-sm rounded-[2rem] shadow-2xl relative z-10 p-6">
            <h3 class="font-bold text-slate-800 text-lg mb-4">Tambah Kartu Baru</h3>
            <form @submit.prevent="addPaymentMethod" class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Nama Pemilik Kartu</label>
                    <input type="text" x-model="newPayment.holder" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-2.5 text-sm font-bold outline-none focus:ring-2 focus:ring-emerald-500" required>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Nomor Kartu</label>
                    <div class="relative">
                        <input type="text" x-model="newPayment.number" placeholder="0000 0000 0000 0000" maxlength="19" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-2.5 text-sm font-bold outline-none focus:ring-2 focus:ring-emerald-500 pl-10" required>
                        <i class="ph-bold ph-credit-card absolute left-3 top-3 text-slate-400"></i>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Masa Berlaku</label>
                        <input type="text" x-model="newPayment.expiry" placeholder="MM/YY" maxlength="5" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-2.5 text-sm font-bold outline-none focus:ring-2 focus:ring-emerald-500" required>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-1">CVV</label>
                        <input type="password" maxlength="3" placeholder="123" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-2.5 text-sm font-bold outline-none focus:ring-2 focus:ring-emerald-500" required>
                    </div>
                </div>
                <div class="pt-2 flex gap-3">
                    <button type="button" @click="showAddPaymentModal = false" class="flex-1 bg-slate-100 text-slate-600 py-3 rounded-xl font-bold text-sm hover:bg-slate-200 transition">Batal</button>
                    <button type="submit" class="flex-1 bg-slate-900 text-white py-3 rounded-xl font-bold text-sm hover:bg-emerald-600 transition shadow-lg">Simpan</button>
                </div>
            </form>
        </div>
    </div>
    <div x-show="showCartModal" class="fixed inset-0 z-50 flex items-center justify-center px-4" style="display: none;">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" @click="showCartModal = false"></div>
        <div class="bg-white w-full max-w-md rounded-[2rem] shadow-2xl relative z-10 overflow-hidden flex flex-col max-h-[80vh]">
            <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                <div class="flex items-center gap-2"><i class="ph-duotone ph-shopping-cart text-xl text-emerald-600"></i><h3 class="font-bold text-slate-800 text-lg">Keranjang Saya</h3></div>
                <button @click="showCartModal = false" class="w-8 h-8 rounded-full bg-slate-200 flex items-center justify-center hover:bg-slate-300 transition"><i class="ph-bold ph-x text-slate-600"></i></button>
            </div>
            <div class="flex-1 overflow-y-auto p-4 space-y-3">
                <template x-for="(item, index) in cart" :key="index">
                    <div class="flex items-center justify-between p-4 bg-slate-50 rounded-xl border border-slate-100">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 bg-white rounded-lg flex items-center justify-center shadow-sm text-2xl"><i :class="item.icon" :class="item.bgClass.replace('bg-', 'text-').split(' ')[1]"></i></div>
                            <div><h4 class="font-bold text-slate-800 text-sm" x-text="item.name"></h4><p class="text-xs text-emerald-600 font-bold" x-text="item.cost"></p></div>
                        </div>
                        <button @click="removeFromCart(index)" class="text-slate-400 hover:text-red-500 p-2"><i class="ph-bold ph-trash"></i></button>
                    </div>
                </template>
                <div x-show="cart.length === 0" class="text-center py-10 text-slate-400"><i class="ph-duotone ph-basket text-4xl mb-2"></i><p class="text-sm font-medium">Keranjang masih kosong.</p></div>
            </div>
            <div class="p-6 border-t border-slate-100 bg-slate-50/50" x-show="cart.length > 0">
                <div class="flex justify-between items-center mb-4"><span class="text-slate-500 font-bold text-sm">Total Belanja</span><span class="text-xl font-black text-slate-900" x-text="'Rp ' + cartTotal.toLocaleString('id-ID')"></span></div>
                <button @click="checkoutCart()" class="w-full bg-slate-900 text-white py-3.5 rounded-xl font-bold shadow-lg hover:bg-emerald-600 transition flex items-center justify-center gap-2">Checkout (<span x-text="cart.length"></span>) <i class="ph-bold ph-arrow-right"></i></button>
            </div>
        </div>
    </div>
    <div x-show="showDepositModal" class="fixed inset-0 z-50 flex items-center justify-center px-4" style="display: none;">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" @click="showDepositModal = false"></div>
        <div class="bg-white w-full max-w-sm rounded-[2rem] shadow-2xl relative z-10 p-6 text-center">
            <div x-show="depositStep === 1">
                <div class="w-16 h-16 bg-emerald-100 rounded-full mx-auto mb-4 flex items-center justify-center text-3xl text-emerald-600"><i class="ph-duotone ph-recycle"></i></div>
                <h3 class="text-xl font-bold text-slate-900 mb-2">Konfirmasi Setoran</h3>
                <p class="text-sm text-slate-500 mb-4">Setor ke <b x-text="selectedTpa?.nama"></b>.</p>
                <div class="bg-slate-50 p-4 rounded-xl mb-4 border border-slate-100 text-left">
                    <label class="block text-xs font-bold text-slate-400 mb-1">Catatan Tambahan (Opsional)</label>
                    <textarea x-model="depositData.address" placeholder="Contoh: Bawa kardus tambahan..." class="w-full p-2 bg-white rounded-lg border border-slate-200 text-sm h-16 resize-none focus:ring-1 focus:ring-emerald-500 outline-none"></textarea>
                </div>
                <div class="flex justify-between items-center bg-emerald-50 p-3 rounded-xl mb-6"><span class="text-xs font-bold text-emerald-700">Berat: <span x-text="trashBag.weight"></span> Kg</span><span class="text-xs font-bold text-emerald-700">+<span x-text="trashBag.potentialXP"></span> XP</span></div>
                <button @click="processDeposit()" class="w-full bg-emerald-600 text-white py-3.5 rounded-xl font-bold shadow-lg hover:bg-emerald-700 transition">Setor Sekarang</button>
                <button @click="showDepositModal = false" class="w-full text-slate-400 font-bold text-sm mt-4">Batal</button>
            </div>
            <div x-show="depositStep === 2" class="py-8">
                <div class="relative w-20 h-20 mx-auto mb-6"><div class="absolute inset-0 rounded-full border-4 border-slate-100"></div><div class="absolute inset-0 rounded-full border-4 border-emerald-500 border-t-transparent animate-spin"></div><div class="absolute inset-0 flex items-center justify-center font-black text-2xl text-slate-800" x-text="approvalTimer"></div></div>
                <h3 class="text-lg font-bold text-slate-800">Memproses...</h3><p class="text-xs text-slate-500 mt-2">Sistem sedang memverifikasi ketersediaan lokasi.</p>
            </div>
            <div x-show="depositStep === 3">
                <div class="w-20 h-20 bg-emerald-100 rounded-full mx-auto mb-4 flex items-center justify-center text-4xl text-emerald-600 animate-[bounce_1s]"><i class="ph-bold ph-check"></i></div>
                <h3 class="text-xl font-bold text-emerald-700 mb-1">Permintaan Disetujui!</h3><p class="text-sm text-slate-500 mb-6">Silakan menuju lokasi penyetoran sekarang.</p>
                <button @click="openGmaps(); showDepositModal = false" class="w-full bg-blue-600 text-white py-3.5 rounded-xl font-bold shadow-lg hover:bg-blue-700 transition flex items-center justify-center gap-2 mb-3"><i class="ph-bold ph-navigation-arrow text-xl"></i> Mulai Navigasi</button>
                <button @click="showDepositModal = false" class="w-full bg-slate-100 text-slate-600 py-3.5 rounded-xl font-bold hover:bg-slate-200 transition">Tutup</button>
            </div>
        </div>
    </div>
    <div x-show="showProductModal" class="fixed inset-0 z-50 flex items-center justify-center px-4" style="display: none;">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" @click="showProductModal = false"></div>
        <div class="bg-white w-full max-w-lg rounded-[2rem] shadow-2xl relative z-10 overflow-hidden flex flex-col max-h-[90vh]">
            <div class="relative h-48 bg-slate-100 flex items-center justify-center">
                <button @click="showProductModal = false" class="absolute top-4 right-4 w-8 h-8 rounded-full bg-white/50 backdrop-blur flex items-center justify-center hover:bg-white transition"><i class="ph-bold ph-x text-slate-600"></i></button>
                <i :class="selectedItem?.icon" class="text-8xl" :class="selectedItem?.bgClass.replace('bg-', 'text-').split(' ')[1]"></i>
            </div>
            <div class="p-6 overflow-y-auto">
                <div class="flex justify-between items-start mb-4"><div><h3 class="text-2xl font-bold text-slate-900 leading-tight" x-text="selectedItem?.name"></h3><p class="text-lg font-black text-emerald-600 mt-1" x-text="selectedItem?.cost"></p></div><span class="bg-emerald-50 text-emerald-700 text-[10px] font-bold px-2 py-1 rounded-lg uppercase tracking-wider">Tersedia</span></div>
                <div class="space-y-4 text-sm text-slate-600 mb-6"><p x-text="selectedItem?.details?.longDesc"></p><div class="bg-slate-50 p-4 rounded-xl border border-slate-100"><h4 class="font-bold text-slate-800 mb-2 text-xs uppercase tracking-wider">Keuntungan</h4><ul class="list-disc pl-4 space-y-1"><template x-for="benefit in selectedItem?.details?.benefits"><li x-text="benefit"></li></template></ul></div><div class="grid grid-cols-2 gap-4"><div><h4 class="font-bold text-slate-800 mb-1 text-xs uppercase tracking-wider">Spesifikasi</h4><p class="text-xs" x-text="selectedItem?.details?.specs"></p></div><div><h4 class="font-bold text-slate-800 mb-1 text-xs uppercase tracking-wider">Isi Paket</h4><p class="text-xs" x-text="selectedItem?.details?.quantity"></p></div></div></div>
                <div class="flex gap-3"><button @click="startTransaction(selectedItem)" class="flex-1 bg-slate-900 hover:bg-emerald-600 text-white py-3.5 rounded-xl font-bold shadow-lg transition active:scale-95 flex items-center justify-center gap-2"><span>Checkout Sekarang</span><i class="ph-bold ph-arrow-right"></i></button></div>
            </div>
        </div>
    </div>
    <div x-show="showPaymentModal" class="fixed inset-0 z-50 flex items-center justify-center px-4" style="display: none;">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" @click="closePayment()"></div>
        <div class="bg-white w-full max-w-md rounded-[2rem] shadow-2xl relative z-10 overflow-hidden flex flex-col max-h-[90vh]">
            <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50/50"><h3 class="font-bold text-slate-800 text-lg">Checkout</h3><button @click="closePayment()" class="w-8 h-8 rounded-full bg-slate-200 flex items-center justify-center hover:bg-slate-300 transition"><i class="ph-bold ph-x text-slate-600"></i></button></div>
            <div class="p-6 overflow-y-auto">
                <div x-show="paymentStep === 1">
                    <div class="flex gap-4 mb-6 bg-slate-50 p-4 rounded-2xl border border-slate-100"><div class="w-16 h-16 bg-white rounded-xl flex items-center justify-center text-3xl shadow-sm shrink-0"><i :class="selectedItem?.icon" :class="selectedItem?.bgClass.replace('bg-', 'text-').split(' ')[1]"></i></div><div><h4 class="font-bold text-slate-900" x-text="selectedItem?.name"></h4><p class="text-xs text-slate-500 line-clamp-1" x-text="selectedItem?.desc"></p><p class="text-sm font-black text-emerald-600 mt-1" x-text="selectedItem?.cost"></p></div></div>
                    <div class="space-y-4 mb-6">
                        <h4 class="text-xs font-bold text-slate-400 uppercase tracking-wider">Metode Pengiriman</h4>
                        <div class="grid grid-cols-2 gap-3"><button @click="shippingData.method = 'pickup'" :class="shippingData.method === 'pickup' ? 'border-emerald-500 bg-emerald-50 text-emerald-700' : 'border-slate-200 hover:border-slate-300'" class="border-2 rounded-xl p-3 text-center transition flex flex-col items-center gap-1"><i class="ph-duotone ph-storefront text-xl"></i><span class="text-xs font-bold">Ambil Sendiri</span></button><button @click="shippingData.method = 'delivery'" :class="shippingData.method === 'delivery' ? 'border-emerald-500 bg-emerald-50 text-emerald-700' : 'border-slate-200 hover:border-slate-300'" class="border-2 rounded-xl p-3 text-center transition flex flex-col items-center gap-1"><i class="ph-duotone ph-moped text-xl"></i><span class="text-xs font-bold">Kurir SORTIQ</span></button></div>
                    </div>
                    <div class="space-y-4 mb-6" x-show="selectedItem?.type === 'money'">
                        <h4 class="text-xs font-bold text-slate-400 uppercase tracking-wider">Metode Pembayaran</h4>
                        <div class="space-y-2"><label class="flex items-center gap-3 p-3 border rounded-xl cursor-pointer hover:bg-slate-50" :class="shippingData.payment === 'cash' ? 'border-emerald-500 ring-1 ring-emerald-500' : 'border-slate-200'"><input type="radio" name="payment" value="cash" x-model="shippingData.payment" class="text-emerald-600 focus:ring-emerald-500"><span class="text-sm font-bold text-slate-700">Tunai (COD/Di Toko)</span></label><label class="flex items-center gap-3 p-3 border rounded-xl cursor-pointer hover:bg-slate-50" :class="shippingData.payment === 'qris' ? 'border-emerald-500 ring-1 ring-emerald-500' : 'border-slate-200'"><input type="radio" name="payment" value="qris" x-model="shippingData.payment" class="text-emerald-600 focus:ring-emerald-500"><span class="text-sm font-bold text-slate-700">QRIS / Transfer Bank</span></label></div>
                    </div>
                    <button @click="processPayment()" class="w-full bg-slate-900 text-white py-3.5 rounded-xl font-bold shadow-lg hover:bg-slate-800 transition active:scale-95 flex items-center justify-center gap-2"><span x-text="selectedItem?.type === 'money' ? 'Bayar Sekarang' : 'Tukar Poin'"></span><i class="ph-bold ph-arrow-right"></i></button>
                </div>
                <div x-show="paymentStep === 2" class="py-10 text-center">
                    <div x-show="stockStatus === 'checking'"><div class="w-16 h-16 border-4 border-slate-200 border-t-emerald-500 rounded-full animate-spin mx-auto mb-4"></div><p class="font-bold text-slate-800">Memeriksa Stok...</p><p class="text-xs text-slate-500 mt-1">Mohon tunggu sebentar.</p></div>
                    <div x-show="stockStatus === 'available' && shippingData.payment === 'qris'"><div class="text-orange-500 font-bold text-2xl mb-2 font-mono" x-text="formatTimer(paymentTimer)"></div><p class="text-xs text-slate-400 mb-4">Selesaikan pembayaran sebelum waktu habis.</p><div class="w-48 h-48 mx-auto bg-white border-2 border-slate-900 rounded-xl p-2 relative mb-4"><img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=SORTIQ_PAYMENT_DEMO" class="w-full h-full"></div><button @click="finishPaymentSuccess()" class="w-full bg-emerald-600 text-white py-3 rounded-xl font-bold text-sm">Saya Sudah Bayar</button></div>
                </div>
                <div x-show="paymentStep === 3" class="text-center">
                    <div class="w-20 h-20 bg-emerald-100 rounded-full mx-auto mb-4 flex items-center justify-center text-4xl text-emerald-600 animate-[bounce_1s]"><i class="ph-fill ph-check-circle"></i></div>
                    <h3 class="text-xl font-bold text-emerald-700 mb-1">Pesanan Diterima!</h3>
                    <p class="text-sm text-slate-500 mb-6">Kami akan segera memproses permintaanmu.</p>
                    <div x-show="shippingData.method === 'delivery'" class="bg-blue-50 p-4 rounded-xl border border-blue-100 mb-4 text-left">
                        <h4 class="font-bold text-blue-800 text-sm mb-2 flex items-center gap-2"><i class="ph-bold ph-moped"></i> Info Kurir</h4>
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center text-xl shadow-sm">üë®‚Äç‚úàÔ∏è</div>
                            <div><p class="text-xs font-bold text-slate-800">Budi Santoso</p><p class="text-[10px] text-slate-500">Honda Beat ‚Ä¢ L 1234 XY</p></div>
                            <div class="ml-auto flex gap-2"><button class="w-8 h-8 rounded-full bg-white text-green-500 shadow-sm flex items-center justify-center"><i class="ph-fill ph-whatsapp-logo"></i></button><button class="w-8 h-8 rounded-full bg-white text-blue-500 shadow-sm flex items-center justify-center"><i class="ph-fill ph-phone"></i></button></div>
                        </div>
                        <div class="mt-3 h-24 bg-slate-200 rounded-lg relative overflow-hidden"><div class="absolute inset-0 flex items-center justify-center text-slate-400 text-xs font-bold">MAP VISUALIZATION</div></div>
                    </div>
                    <div x-show="shippingData.method === 'pickup'" class="mb-4"><button @click="openGmaps()" class="w-full border-2 border-blue-100 text-blue-600 py-3 rounded-xl font-bold text-sm flex items-center justify-center gap-2 hover:bg-blue-50"><i class="ph-bold ph-map-pin"></i> Rute ke Toko</button></div>
                    <button @click="setPage('orders'); closePayment()" class="w-full bg-slate-900 text-white py-3.5 rounded-xl font-bold shadow-lg hover:bg-slate-800 transition">Lihat Pesanan Saya</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Alpine JS Logic -->
    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.data('appData', () => ({
                // ... (Previous State Variables kept) ...
                currentPage: 'home', 
                pageTitle: 'Dashboard', 
                xp: 0, 
                username: 'Memuat...', 
                email: '',
                phone: '', 
                showPaymentModal: false, 
                showProductModal: false,
                showCartModal: false, 
                showAddPaymentModal: false, 
                showRedeemModal: false, // NEW
                redeemType: null, // NEW
                redeemStep: 1, // NEW
                selectedItem: null, 
                selectedOrder: null, 
                paymentStep: 1, 
                showDepositModal: false, 
                depositStep: 1, 
                approvalTimer: 5, 
                paymentTimer: 600, 
                paymentInterval: null,
                stockStatus: 'idle',
                marketTab: 'redeem', 
                historyFilter: 'all', 
                isTyping: false,
                voucherSort: 'default', // NEW
                trashBag: { weight: 5.5, potentialXP: 550 }, 
                shippingData: { address: '', method: 'pickup', note: '', payment: 'cash' },
                depositData: { address: '' },
                newPayment: { holder: '', number: '', expiry: '', type: 'GPN' }, 
                paymentMethods: [{ name: 'Bank Indonesia Debit', number: '1234567812345678', last4: '5678', expiry: '12/28', type: 'GPN' }],
                userHistory: [], 
                marketOrders: [],
                cart: [], 
                priceFilter: 'Semua', 
                calcType: 50, 
                calcWeight: 0,
                // NEW: Redeem Data State
                redeemData: { phoneNumber: '', provider: '', nominal: 0, cost: 0, customerId: '', bank: '', accountNumber: '' },
                inquiryResult: null,

                // Computed Properties
                get cartTotal() { return this.cart.reduce((sum, item) => sum + item.priceValue, 0); },
                get filteredOrders() {
                    if (this.historyFilter === 'all') return this.marketOrders;
                    if (this.historyFilter === 'shop') return this.marketOrders.filter(o => o.itemType === 'money');
                    if (this.historyFilter === 'redeem') return this.marketOrders.filter(o => o.itemType === 'xp' && !o.itemName.toLowerCase().includes('voucher'));
                    if (this.historyFilter === 'withdraw') return this.marketOrders.filter(o => o.itemName.toLowerCase().includes('voucher')); 
                    return this.marketOrders;
                },
                // NEW: Sorted Vouchers
                get sortedVouchers() {
                    let vouchers = this.marketItems.filter(i => i.category === 'redeem');
                    if (this.voucherSort === 'lowest') return vouchers.sort((a,b) => a.priceValue - b.priceValue);
                    if (this.voucherSort === 'popular') return vouchers.sort((a,b) => b.priceValue - a.priceValue); // Dummy sort logic for now
                    return vouchers;
                },

                // Data (Trash Categories, Chart, Nav) kept same ...
                trashCategories: [ /* ... */ ],
                chartInstance: null,
                navItems: [
                    { id: 'home', label: 'Dashboard', icon: 'ph-bold ph-squares-four' },
                    { id: 'tpa', label: 'Lokasi Setor', icon: 'ph-bold ph-map-trifold' },
                    { id: 'bot', label: 'Tanya AI', icon: 'ph-bold ph-robot' },
                    { id: 'market', label: 'Eco Market', icon: 'ph-bold ph-storefront' },
                    { id: 'orders', label: 'Riwayat Belanja', icon: 'ph-bold ph-receipt' }
                ],
                selectedTpaId: 1, 
                tpaSearch: '',
                tpaData: [
                    { id: 1, nama: "SORTIQ Bank Sampah Ngagel", alamat: "Jl. Ngagel Tim., Pucang Sewu", lat: -7.289166, lng: 112.756549, status: "Buka", tipe: "Recycling Center", jarak: "2.1 km", zoom: 18, fullness: "low" },
                    { id: 2, nama: "SORTIQ Bank Sampah Barat", alamat: "Citraland, Surabaya Barat", lat: -7.275432, lng: 112.642331, status: "Buka", tipe: "Smart Hub", jarak: "3.5 km", zoom: 15, fullness: "medium" },
                    { id: 3, nama: "SORTIQ Bank Sampah Rungkut", alamat: "Gunung Anyar Tambak, Surabaya", lat: -7.339243, lng: 112.822231, status: "Penuh", tipe: "Community Unit", jarak: "7.8 km", zoom: 16, fullness: "high" }
                ],
                get selectedTpa() { 
                    const found = this.tpaData.find(t => t.id === this.selectedTpaId);
                    return found || (this.tpaData.length > 0 ? this.tpaData[0] : {}); 
                },
                get filteredTpa() { return this.tpaData.filter(t => t.nama.toLowerCase().includes(this.tpaSearch.toLowerCase())); },
                get nearestTpa() {
                    return this.tpaData.length > 0 ? this.tpaData[0] : { nama: 'Memuat...', alamat: '...', jarak: '-', lat: 0, lng: 0 };
                },

                // Market Items - Cleaned up to separate services from vouchers
                marketItems: [
                    // Shop Items (Money)
                    { id: 3, name: 'Starter Kit Kompos', desc: 'Perlengkapan praktis olah sampah organik.', cost: 'Rp 75.000', type: 'money', category: 'shop', priceValue: 75000, bgClass: 'bg-orange-50 text-orange-500', icon: 'ph-duotone ph-potted-plant', 
                      details: { longDesc: 'Perlengkapan praktis untuk mengolah sampah organik...', benefits: ['Mengurangi sampah', 'Nutrisi tanah'], quantity: '1 Set Kompos', specs: 'Plastik daur ulang' } },
                    { id: 4, name: 'Tempat Sampah Pilah', desc: 'Dua sekat untuk memilah sampah.', cost: 'Rp 65.000', type: 'money', category: 'shop', priceValue: 65000, bgClass: 'bg-slate-50 text-slate-500', icon: 'ph-duotone ph-trash',
                      details: { longDesc: 'Tempat sampah dua sekat...', benefits: ['Memilah sampah', 'Ramah lingkungan'], quantity: '1 Unit', specs: '2x7 Liter' } },
                    { id: 5, name: 'Sabun Cuci Eco', desc: 'Formula biodegradable aman lingkungan.', cost: 'Rp 15.000', type: 'money', category: 'shop', priceValue: 15000, bgClass: 'bg-cyan-50 text-cyan-500', icon: 'ph-duotone ph-drop',
                      details: { longDesc: 'Sabun cuci ramah lingkungan...', benefits: ['Biodegradable', 'Lembut'], quantity: '200ml', specs: 'Cair' } },
                    { id: 6, name: 'Sikat Serat Alami', desc: 'Pengganti spons plastik.', cost: 'Rp 12.000', type: 'money', category: 'shop', priceValue: 12000, bgClass: 'bg-amber-50 text-amber-600', icon: 'ph-duotone ph-broom',
                      details: { longDesc: 'Sikat sabut kelapa...', benefits: ['Zero waste', 'Tahan lama'], quantity: '1 Pcs', specs: 'Sabut Kelapa' } },
                    
                    // Voucher Items (XP) - Explicit Vouchers
                    { id: 101, name: 'Voucher Tokopedia 10rb', desc: 'Belanja hemat di Tokopedia.', cost: '1000 XP', type: 'xp', category: 'redeem', priceValue: 1000, bgClass: 'bg-green-50 text-green-600', icon: 'ph-duotone ph-bag' },
                    { id: 102, name: 'Voucher Shopee 25rb', desc: 'Diskon ongkir & cashback.', cost: '2500 XP', type: 'xp', category: 'redeem', priceValue: 2500, bgClass: 'bg-orange-50 text-orange-600', icon: 'ph-duotone ph-shopping-bag' },
                    { id: 103, name: 'Voucher Indomaret 50rb', desc: 'Belanja kebutuhan harian.', cost: '5000 XP', type: 'xp', category: 'redeem', priceValue: 5000, bgClass: 'bg-blue-50 text-blue-600', icon: 'ph-duotone ph-storefront' },
                    { id: 104, name: 'Voucher Kopi Kenangan', desc: 'Satu cup kopi gratis.', cost: '1500 XP', type: 'xp', category: 'redeem', priceValue: 1500, bgClass: 'bg-red-50 text-red-600', icon: 'ph-duotone ph-coffee' }
                ],

                // ... Other vars (chat, etc) ...
                chatMessages: [], chatInput: '',

                init() {
                    // Initialize Firebase Bridge
                    if (window.fbBridge) window.fbBridge.init(this);
                    
                    // Load mocked data
                    const storedBag = localStorage.getItem('sortiq_trashbag');
                    if (storedBag) this.trashBag = JSON.parse(storedBag);
                    
                    this.chatMessages = [{ id: 1, text: `Halo! Saya AI SORTIQ. Ada yang bisa saya bantu?`, sender: 'bot', time: '10:00' }];
                },

                // ... Helper Functions (setPage, etc) ...
                setPage(pageId) {
                    this.currentPage = pageId;
                    const titles = { 'home': 'Dashboard', 'bag': 'Detail Kantong', 'tpa': 'Lokasi Setor', 'bot': 'Asisten AI', 'market': 'Eco Market', 'prices': 'Bursa Sampah', 'orders': 'Riwayat Belanja', 'history': 'Riwayat Setoran', 'account': 'Akun Saya', 'tracking': 'Pantau Kurir' };
                    this.pageTitle = titles[pageId] || 'Dashboard';
                    document.getElementById('main-scroll').scrollTop = 0;
                    if (pageId === 'bag') setTimeout(() => this.renderChart(), 100); 
                },

                // ... Existing Logic (addPaymentMethod, renderChart, etc.) ...
                addPaymentMethod() { 
                    const last4 = this.newPayment.number.slice(-4);
                    this.paymentMethods.push({
                        name: this.newPayment.holder,
                        number: this.newPayment.number,
                        last4: last4,
                        expiry: this.newPayment.expiry,
                        type: 'VISA' // Assuming VISA for added cards for simplicity, or based on number
                    });
                    this.showAddPaymentModal = false;
                    this.newPayment = { holder: '', number: '', expiry: '', type: 'GPN' };
                    alert("Metode pembayaran berhasil ditambahkan.");
                },
                renderChart() {
                    const ctx = document.getElementById('marketChartDetail');
                    if (!ctx) return;
                    
                    if (this.chartInstance) this.chartInstance.destroy();

                    this.chartInstance = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: ['Sen', 'Sel', 'Rab', 'Kam', 'Jum', 'Sab', 'Min'],
                            datasets: [{
                                label: 'Harga',
                                data: [3100, 3150, 3100, 3300, 3400, 3450, 3500],
                                borderColor: '#10b981',
                                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                fill: true,
                                tension: 0.4,
                                pointRadius: 0,
                                borderWidth: 2
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: { x: { display: false }, y: { display: false } }
                        }
                    });
                },
                formatDate(isoString) {
                    if(!isoString) return '-';
                    const d = new Date(isoString);
                    if (isNaN(d.getTime())) return '-';
                    return d.toLocaleString('id-ID', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' });
                },
                formatTimer(seconds) {
                    const m = Math.floor(seconds / 60).toString().padStart(2, '0');
                    const s = (seconds % 60).toString().padStart(2, '0');
                    return `${m}:${s}`;
                },
                selectTpa(id) { this.selectedTpaId = id; },
                openGmaps() { window.open(`https://www.google.com/maps/dir/?api=1&destination=${this.selectedTpa.lat},${this.selectedTpa.lng}`, '_blank'); },
                async sendMessage() {
                    // 1. Validasi Input
                    if (!this.chatInput.trim()) return;
                    
                    // 2. Tampilkan Chat User
                    const userText = this.chatInput;
                    this.chatMessages.push({ id: Date.now(), text: userText, sender: 'user', time: 'Sekarang' });
                    this.chatInput = '';
                    this.isTyping = true;

                    // 3. Simulasi Chatbot
                    setTimeout(() => {
                        this.isTyping = false;
                        let botReply = "Maaf, saya hanya simulasi AI. Sambungkan API Gemini/OpenAI untuk fitur ini.";
                        if (userText.toLowerCase().includes('sampah')) botReply = "Untuk sampah plastik, pisahkan tutup botolnya ya agar nilai jual lebih tinggi!";
                        else if (userText.toLowerCase().includes('poin')) botReply = "Poin XP bisa kamu tukarkan dengan voucher di Eco Market.";
                        
                        this.chatMessages.push({ 
                            id: Date.now() + 1, 
                            text: botReply, 
                            sender: 'bot', 
                            time: 'Sekarang' 
                        });
                    }, 1500);
                },
                openProductModal(item) { this.selectedItem = item; this.showProductModal = true; },
                addToCart(item) { this.cart.push(item); },
                removeFromCart(index) { this.cart.splice(index, 1); },
                checkoutCart() {
                    this.showCartModal = false;
                    const totalCost = this.cartTotal;
                    this.selectedItem = {
                        name: 'Pesanan Keranjang',
                        desc: this.cart.length + ' Item dari Eco Market',
                        cost: 'Rp ' + totalCost.toLocaleString('id-ID'),
                        priceValue: totalCost,
                        type: 'money',
                        icon: 'ph-shopping-cart',
                        bgClass: 'bg-emerald-50 text-emerald-600'
                    };
                    this.shippingData = { address: '', method: 'pickup', note: '', payment: 'cash' };
                    this.paymentStep = 1;
                    this.stockStatus = 'idle';
                    this.showPaymentModal = true;
                },
                startTransaction(item) {
                    this.showProductModal = false;
                    this.selectedItem = item;
                    this.shippingData = { address: '', method: 'pickup', note: '', payment: 'cash' };
                    this.paymentStep = 1;
                    this.stockStatus = 'idle';
                    this.showPaymentModal = true;
                },
                trackOrder(order) { this.selectedOrder = order; this.setPage('tracking'); },
                async processPayment() {
                    this.paymentStep = 2;
                    this.stockStatus = 'checking';
                    
                    await new Promise(resolve => setTimeout(resolve, 1500));
                    
                    this.stockStatus = 'available';

                    if (this.selectedItem.type === 'xp') {
                        if (this.xp >= this.selectedItem.priceValue) {
                            await this.finalizeOrder();
                        } else {
                            alert("Poin XP tidak mencukupi.");
                            this.closePayment();
                        }
                    } else {
                        if (this.shippingData.payment === 'qris') {
                            this.paymentTimer = 600; 
                            if (this.paymentInterval) clearInterval(this.paymentInterval);
                            this.paymentInterval = setInterval(() => {
                                this.paymentTimer--;
                                if (this.paymentTimer <= 0) {
                                    clearInterval(this.paymentInterval);
                                    alert("Waktu pembayaran habis. Pesanan dibatalkan.");
                                    this.closePayment();
                                }
                            }, 1000);
                        } else {
                            await this.finalizeOrder();
                        }
                    }
                },
                async finishPaymentSuccess() {
                    if (this.paymentInterval) clearInterval(this.paymentInterval);
                    await this.finalizeOrder();
                },
                async finalizeOrder() {
                    const isCartCheckout = this.selectedItem.name === 'Pesanan Keranjang';
                    
                    // Determine Status based on method
                    let status = 'Selesai';
                    if (this.shippingData.method === 'delivery') status = 'Dalam Pengiriman';
                    if (this.shippingData.method === 'pickup') status = 'Siap Diambil';
                    if (this.selectedItem.type === 'xp') status = 'Selesai'; 

                    const success = await window.fbBridge.submitOrder({
                        ...this.selectedItem,
                        method: this.shippingData.method,
                        status: status
                    }, this.xp);

                    if (success) {
                        this.paymentStep = 3;
                        if (isCartCheckout) {
                            this.cart = [];
                        }
                    } else {
                        alert("Gagal memproses pesanan.");
                        this.closePayment();
                    }
                },
                closePayment() { 
                    this.showPaymentModal = false; 
                    this.selectedItem = null; 
                    this.paymentStep = 1; 
                    if (this.paymentInterval) clearInterval(this.paymentInterval);
                },
                openDepositModal() {
                    if (this.trashBag.weight <= 0) return alert("Kantong kosong!");
                    this.depositStep = 1;
                    this.depositData.address = '';
                    this.approvalTimer = 5;
                    this.showDepositModal = true;
                },
                async processDeposit() {
                    this.depositStep = 2; // Show Loading with Timer
                    
                    // Countdown Logic
                    let timeLeft = 5;
                    const timerInterval = setInterval(() => {
                        timeLeft--;
                        this.approvalTimer = timeLeft;
                        if (timeLeft <= 0) clearInterval(timerInterval);
                    }, 1000);

                    // SEND TO DATABASE
                    const success = await window.fbBridge.submitDeposit({
                        weight: this.trashBag.weight,
                        xpReward: this.trashBag.potentialXP,
                        address: this.depositData.address || "Langsung di TPA",
                        tpaName: this.selectedTpa.nama
                    });

                    // Wait for both timer and API
                    setTimeout(() => {
                        if(success) {
                            this.depositStep = 3; // Show Success & Nav CTA
                            this.trashBag = { weight: 0, potentialXP: 0 };
                            localStorage.setItem('sortiq_trashbag', JSON.stringify(this.trashBag));
                        } else {
                            alert("Gagal mengirim data ke server.");
                            this.showDepositModal = false;
                        }
                    }, 5000);
                },

                // === NEW REDEEM LOGIC ===
                openRedeemModal(type) {
                    this.redeemType = type;
                    this.redeemStep = 1;
                    this.redeemData = { phoneNumber: this.phone || '', provider: '', nominal: 0, cost: 0, customerId: '', bank: '', accountNumber: '' };
                    this.inquiryResult = null;
                    this.showRedeemModal = true;
                },
                
                openVoucherModal(item) {
                     // Reuse logic to simply redeem voucher directly like before or show details
                     this.startTransaction(item); 
                },

                processInquiry() {
                    // Simulate API delay
                    const btn = event.target;
                    const originalText = btn.innerText;
                    btn.innerText = "...";
                    setTimeout(() => {
                        btn.innerText = originalText;
                        if (this.redeemType === 'pln') this.inquiryResult = "Budi Santoso - 1300VA";
                        if (this.redeemType === 'withdraw') this.inquiryResult = "Budi Santoso";
                    }, 1000);
                },

                confirmRedemption() {
                    // If Withdraw or High Value, show PIN
                    if (this.redeemType === 'withdraw' || this.redeemData.cost > 5000) {
                        this.redeemStep = 2;
                    } else {
                        this.executeRedemption();
                    }
                },

                async executeRedemption() {
                    // Deduct Points & Add to History
                    const success = await window.fbBridge.submitOrder({
                        name: this.redeemType === 'pulsa' ? `Pulsa ${this.redeemData.nominal}` : (this.redeemType === 'pln' ? `Token PLN ${this.redeemData.nominal}` : `Withdraw Rp ${this.redeemData.nominal}`),
                        type: 'xp',
                        cost: `${this.redeemData.cost} XP`,
                        priceValue: this.redeemData.cost,
                        status: 'Berhasil',
                        method: 'digital',
                        meta: this.redeemData
                    }, this.xp);

                    if (success) {
                        this.redeemStep = 3;
                    } else {
                        alert("Poin tidak cukup atau terjadi kesalahan.");
                    }
                }
            }));
        });
    </script>
</body>
</html>
