<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Scanner - SORTIQ</title>
    
    <!-- Library -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Config Tailwind -->
     <link rel="icon" type="image/png" href="logo.png?v=2">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['"Plus Jakarta Sans"', 'sans-serif'] },
                    colors: {
                        brand: { 500: '#10b981', 600: '#059669', dark: '#064e3b' },
                        dark: { bg: '#0f172a', surface: '#1e293b' }
                    },
                    animation: {
                        'scan-beam': 'scanBeam 1.5s ease-in-out infinite alternate',
                        'pulse-slow': 'pulseSlow 3s infinite',
                    },
                    keyframes: {
                        scanBeam: { '0%': { top: '0%', opacity: 0 }, '50%': { top: '100%', opacity: 1 } },
                        pulseSlow: { '0%, 100%': { opacity: 0.4 }, '50%': { opacity: 0.1 } }
                    }
                }
            }
        }
    </script>
    
    <style>
        body { background-color: #000; overflow: hidden; }
        .glass { background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
        
        /* Transisi Popup */
        #result-popup { transition: transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1); will-change: transform; }
        
        /* State Popup */
        .popup-hidden { transform: translateX(110%); }
        .popup-visible { transform: translateX(0); }

        /* Responsif Popup di Mobile (Muncul dari Bawah) */
        @media (max-width: 768px) {
            .popup-hidden { transform: translateY(110%); }
            .popup-visible { transform: translateY(0); }
        }

        /* Style untuk Video Kamera */
        video { object-fit: cover; width: 100%; height: 100%; } 
    </style>
</head>
<body class="h-screen w-full relative overflow-hidden text-white">

    <!-- === 1. BACKGROUND KAMERA (REAL FEED) === -->
    <div class="absolute inset-0 z-0 bg-gray-900">
        <!-- Elemen Video untuk Kamera Asli -->
        <video id="cam-video" autoplay playsinline muted class="w-full h-full object-cover hidden"></video>
        
        <!-- Fallback Image jika kamera gagal/belum aktif -->
        <img id="cam-placeholder" src="https://images.unsplash.com/photo-1595278069441-2cf29f8005a4?ixlib=rb-4.0.3&auto=format&fit=crop&w=1000&q=80" class="absolute inset-0 w-full h-full object-cover opacity-60" alt="Camera Placeholder">
             
        <!-- Canvas Tersembunyi untuk Capture Foto -->
        <canvas id="capture-canvas" class="hidden"></canvas>

        <!-- Overlay Effects -->
        <div class="absolute inset-0 bg-[url('https://grainy-gradients.vercel.app/noise.svg')] opacity-20 pointer-events-none"></div>
        <div class="absolute inset-0 bg-radial-gradient pointer-events-none" style="background: radial-gradient(circle, transparent 40%, rgba(0,0,0,0.8) 100%);"></div>
    </div>

    <!-- === 2. UI SCANNER (CENTER HUD) === -->
    <div id="scanner-ui" class="absolute inset-0 z-20 flex flex-col justify-between p-4 md:p-6 transition-opacity duration-500 pb-8 md:pb-6">
        
        <!-- Header -->
        <div class="flex justify-between items-start pt-safe">
            <!-- UPDATE LINK: Mengarah ke dashboard.html -->
            <a href="dashboard.html" class="w-10 h-10 md:w-12 md:h-12 rounded-full glass flex items-center justify-center hover:bg-white/10 transition active:scale-90">
                <i class="ph-bold ph-arrow-left text-lg md:text-xl"></i>
            </a>
            
            <div class="glass px-3 py-1.5 md:px-4 md:py-2 rounded-full flex items-center gap-2">
                <span class="w-2 h-2 bg-brand-500 rounded-full animate-pulse shadow-[0_0_10px_#10b981]"></span>
                <span class="text-[10px] md:text-xs font-bold tracking-widest text-brand-500">AI DETECT</span>
            </div>
        </div>

        <!-- Center Frame -->
        <div class="flex-1 flex flex-col items-center justify-center relative">
            <!-- Bingkai Scan Responsif -->
            <div id="scan-frame" class="relative w-64 h-64 sm:w-80 sm:h-80 md:w-96 md:h-96 border border-white/20 rounded-[2rem] overflow-hidden transition-all duration-500 shadow-[0_0_0_1000px_rgba(0,0,0,0.5)]">
                <!-- Corners -->
                <div class="absolute top-0 left-0 w-6 h-6 md:w-8 md:h-8 border-t-4 border-l-4 border-brand-500 rounded-tl-2xl"></div>
                <div class="absolute top-0 right-0 w-6 h-6 md:w-8 md:h-8 border-t-4 border-r-4 border-brand-500 rounded-tr-2xl"></div>
                <div class="absolute bottom-0 left-0 w-6 h-6 md:w-8 md:h-8 border-b-4 border-l-4 border-brand-500 rounded-bl-2xl"></div>
                <div class="absolute bottom-0 right-0 w-6 h-6 md:w-8 md:h-8 border-b-4 border-r-4 border-brand-500 rounded-br-2xl"></div>

                <!-- Laser -->
                <div id="laser" class="hidden absolute left-0 w-full h-2 bg-gradient-to-b from-brand-500/0 via-brand-500/50 to-brand-500/0 shadow-[0_0_20px_#10b981] animate-scan-beam"></div>

                <!-- AI Label -->
                <div id="ai-tag" class="hidden absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2">
                    <div class="bg-brand-500 text-white px-3 py-1.5 md:px-4 md:py-2 rounded-xl shadow-lg flex items-center gap-2 animate-bounce">
                        <i class="ph-bold ph-check-circle text-lg md:text-xl"></i>
                        <span class="font-bold text-xs md:text-sm whitespace-nowrap">Objek Teridentifikasi</span>
                    </div>
                </div>
            </div>
            
            <p id="instruction" class="mt-6 md:mt-8 text-white/80 text-xs md:text-sm font-medium bg-black/40 px-4 py-2 md:px-6 md:py-2 rounded-full backdrop-blur-sm border border-white/5">
                Kamera non-aktif. Gunakan tombol upload.
            </p>
        </div>

        <!-- Footer Controls -->
        <div class="flex justify-center items-center gap-8 md:gap-10 pb-4 md:pb-8">
            <button onclick="document.getElementById('file-input').click()" class="w-12 h-12 md:w-14 md:h-14 rounded-full glass flex items-center justify-center hover:bg-white/10 transition active:scale-90">
                <i class="ph-bold ph-image text-xl md:text-2xl"></i>
            </button>

            <!-- Shutter Button -->
            <button id="shutter-btn" onclick="captureAndScan()" class="w-20 h-20 md:w-24 md:h-24 rounded-full border-4 border-white/80 flex items-center justify-center relative group active:scale-95 transition-all">
                <div class="absolute inset-0 rounded-full border border-white opacity-0 group-hover:opacity-100 animate-ping"></div>
                <div class="w-16 h-16 md:w-20 md:h-20 bg-white rounded-full transition-colors group-hover:bg-brand-500"></div>
            </button>

            <button onclick="toggleFlash()" class="w-12 h-12 md:w-14 md:h-14 rounded-full glass flex items-center justify-center hover:bg-white/10 transition active:scale-90">
                <i id="flash-icon" class="ph-bold ph-lightning text-xl md:text-2xl"></i>
            </button>
        </div>
    </div>

    <!-- === 3. POP-UP RESULT === -->
    <div id="result-popup" class="popup-hidden fixed z-40 top-auto md:top-4 right-0 md:right-4 bottom-0 md:bottom-4 w-full md:w-[400px] h-[60vh] md:h-auto bg-white rounded-t-[2rem] md:rounded-[2rem] shadow-2xl overflow-hidden flex flex-col border border-white/20 text-slate-800">
        
        <!-- Header Popup -->
        <div class="relative h-40 md:h-48 bg-slate-900 overflow-hidden shrink-0">
            <!-- Tempat Menampilkan Hasil Capture -->
            <img id="result-img" class="w-full h-full object-cover">
            <div class="absolute inset-0 bg-gradient-to-t from-black/80 to-transparent"></div>
            
            <button onclick="closePopup()" class="absolute top-4 left-4 w-10 h-10 bg-black/30 backdrop-blur rounded-full flex items-center justify-center text-white hover:bg-black/50 transition">
                <i class="ph-bold ph-x text-lg"></i>
            </button>

            <div class="absolute bottom-4 left-6 text-white">
                <div class="bg-brand-500 text-[10px] font-bold px-2 py-1 rounded mb-1 inline-block">CONFIDENCE: 98%</div>
                <h2 class="text-2xl md:text-3xl font-bold leading-none">Botol Plastik</h2>
            </div>
        </div>

        <!-- Content -->
        <div class="flex-1 overflow-y-auto p-5 md:p-6 bg-gray-50 space-y-4 md:space-y-5">
            <div class="grid grid-cols-2 gap-3">
                <div class="bg-white p-3 rounded-2xl shadow-sm border border-gray-100">
                    <p class="text-[10px] md:text-xs text-gray-400 font-bold uppercase">Estimasi Berat</p>
                    <div class="flex items-center gap-2 mt-1">
                        <i class="ph-fill ph-scales text-brand-500 text-lg"></i>
                        <span class="font-bold text-gray-800 text-lg">0.5 Kg</span>
                    </div>
                </div>
                <div class="bg-white p-3 rounded-2xl shadow-sm border border-gray-100">
                    <p class="text-[10px] md:text-xs text-gray-400 font-bold uppercase">Potensi Poin</p>
                    <div class="flex items-center gap-2 mt-1">
                        <i class="ph-fill ph-coin text-blue-500 text-lg"></i>
                        <span class="font-bold text-gray-800 text-lg">+50 XP</span>
                    </div>
                </div>
            </div>

            <div class="bg-blue-50 p-4 rounded-2xl border border-blue-100">
                <div class="flex gap-3">
                    <i class="ph-fill ph-info text-2xl text-blue-500"></i>
                    <div>
                        <h4 class="font-bold text-blue-900 text-sm">Masuk Kantong Dulu!</h4>
                        <p class="text-xs text-blue-700 mt-1 leading-relaxed">
                            Sampah ini akan disimpan di <b>"Kantong Saya"</b>. Kumpulkan lebih banyak lalu setor di menu Dashboard untuk klaim poin.
                        </p>
                    </div>
                </div>
            </div>

            <div>
                <h4 class="font-bold text-gray-800 text-sm mb-3">Langkah Pengelolaan</h4>
                <div class="space-y-3">
                    <div class="flex gap-3 items-center bg-white p-3 rounded-xl border border-gray-100">
                        <div class="w-6 h-6 rounded-full bg-gray-100 text-gray-500 flex items-center justify-center text-xs font-bold">1</div>
                        <span class="text-xs md:text-sm text-gray-600">Buang sisa cairan/isi.</span>
                    </div>
                    <div class="flex gap-3 items-center bg-white p-3 rounded-xl border border-gray-100">
                        <div class="w-6 h-6 rounded-full bg-gray-100 text-gray-500 flex items-center justify-center text-xs font-bold">2</div>
                        <span class="text-xs md:text-sm text-gray-600">Remukkan botol agar hemat tempat.</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="p-4 md:p-6 bg-white border-t border-gray-100">
            <button onclick="addToBag()" class="w-full bg-slate-900 text-white py-3.5 md:py-4 rounded-xl font-bold shadow-lg hover:bg-slate-800 transition active:scale-95 flex items-center justify-center gap-2">
                <i class="ph-bold ph-bag-simple"></i> Simpan ke Kantong
            </button>
        </div>
    </div>

    <input type="file" id="file-input" accept="image/*" class="hidden" onchange="handleFile(this)">

    <script>
        const els = {
            video: document.getElementById('cam-video'),
            placeholder: document.getElementById('cam-placeholder'),
            canvas: document.getElementById('capture-canvas'),
            resultImg: document.getElementById('result-img'),
            popup: document.getElementById('result-popup'),
            ui: document.getElementById('scanner-ui'),
            laser: document.getElementById('laser'),
            aiTag: document.getElementById('ai-tag'),
            scanBox: document.getElementById('scan-frame'),
            hint: document.getElementById('instruction')
        };

        // 1. Inisialisasi Kamera
        async function initCamera() {
            try {
                // Cek apakah browser mendukung getUserMedia
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error("API Kamera tidak didukung di browser ini.");
                }

                // Minta akses kamera belakang (environment)
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "environment" } 
                });
                
                els.video.srcObject = stream;
                els.video.classList.remove('hidden');
                els.placeholder.classList.add('hidden');
                els.hint.innerText = "Arahkan kamera ke sampah";

            } catch (err) {
                console.warn("Gagal akses kamera:", err);
                els.video.classList.add('hidden');
                els.placeholder.classList.remove('hidden');
                els.hint.innerText = "Kamera non-aktif. Gunakan tombol upload.";
            }
        }

        // 2. Fungsi Capture & Scan
        function captureAndScan() {
            // Animasi Tombol
            const btn = document.getElementById('shutter-btn');
            btn.classList.add('scale-90', 'border-brand-500');
            setTimeout(() => btn.classList.remove('scale-90', 'border-brand-500'), 150);

            // Efek Scanning UI
            els.laser.classList.remove('hidden');
            els.scanBox.classList.add('border-brand-500', 'shadow-[0_0_30px_#10b981]');
            els.hint.innerText = "Menganalisis objek...";
            els.hint.classList.replace('bg-black/40', 'bg-brand-500'); // Indikator aktif

            // Capture Frame dari Video ke Canvas (Jika kamera aktif)
            if (!els.video.classList.contains('hidden')) {
                const context = els.canvas.getContext('2d');
                els.canvas.width = els.video.videoWidth;
                els.canvas.height = els.video.videoHeight;
                context.drawImage(els.video, 0, 0, els.canvas.width, els.canvas.height);
                // Set hasil ke image popup
                els.resultImg.src = els.canvas.toDataURL('image/png');
            } else {
                // Jika pakai placeholder/upload (Mode Fallback)
                els.resultImg.src = els.placeholder.src;
            }

            // Simulasi Delay AI
            setTimeout(() => { els.aiTag.classList.remove('hidden'); }, 1500);

            setTimeout(() => {
                openPopup();
                // Reset UI
                els.laser.classList.add('hidden');
                els.aiTag.classList.add('hidden');
                els.scanBox.classList.remove('border-brand-500', 'shadow-[0_0_30px_#10b981]');
                els.hint.innerText = "Analisis Selesai.";
            }, 2500);
        }

        function handleFile(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    els.placeholder.src = e.target.result;
                    els.placeholder.classList.remove('hidden');
                    els.video.classList.add('hidden'); // Sembunyikan video stream
                    
                    // Otomatis scan setelah upload
                    setTimeout(captureAndScan, 500);
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function openPopup() {
            els.popup.classList.remove('popup-hidden');
            els.popup.classList.add('popup-visible');
            els.ui.style.opacity = '0'; 
            setTimeout(() => els.ui.style.visibility = 'hidden', 500); 
        }

        function closePopup() {
            els.popup.classList.remove('popup-visible');
            els.popup.classList.add('popup-hidden');
            els.ui.style.visibility = 'visible';
            els.ui.style.opacity = '1';
            els.hint.innerText = "Arahkan kamera ke sampah";
            els.hint.classList.replace('bg-brand-500', 'bg-black/40');
        }

        // 3. Simpan Hasil ke LocalStorage (LOGIKA KANTONG)
        function addToBag() {
            const btn = document.querySelector('#result-popup button');
            btn.innerHTML = "<i class='ph-bold ph-spinner animate-spin'></i> Menyimpan...";
            
            // Data Sampah Simulasi
            const weightToAdd = 0.5; // 0.5 Kg
            const xpToAdd = 50;      // 50 XP

            // Ambil data kantong yang sudah ada
            let currentBag = JSON.parse(localStorage.getItem('sortiq_trashbag')) || { weight: 0, potentialXP: 0 };
            
            // Update Data
            currentBag.weight = parseFloat((currentBag.weight + weightToAdd).toFixed(2));
            currentBag.potentialXP += xpToAdd;

            // Simpan Balik
            localStorage.setItem('sortiq_trashbag', JSON.stringify(currentBag));

            setTimeout(() => {
                alert(`Berhasil! ${weightToAdd}Kg botol telah masuk ke Kantong Digital.`);
                // UPDATE REDIRECT: Mengarah ke dashboard.html
                window.location.href = 'dashboard.html'; 
            }, 1000);
        }

        function toggleFlash() {
            alert('Fitur flash memerlukan akses hardware native (tidak tersedia di browser standard).');
        }

        // Jalankan kamera saat load
        window.addEventListener('load', initCamera);

    </script>
</body>
</html>